<doku:title parent="119" tags="manual,setup,database,object,relational,mapping,or,mapper,generic,relations,objects,object tree,object structures,configuration,usage" title="Generic O/R mapper - manual database setup" urlname="Generic-OR-mapper-manual-database-setup">
  The genericormapper module provides a generic data mapper, that is fully integrated into the APF.
  It enables the developer to dynamically handle objects and their reations, that are defined within
  configuration files. This page especially describes the manual database setup.
</doku:title>
<h3 id="Chapter-1-Introduction"><a href="#Chapter-1-Introduction">1. Introduction</a></h3>
The OR mapper follows a simple convention of database layout: <strong>each object is stored within
on database table, each relation has it's ont table, too!</strong> This is a good way between
normalization and good performance, because loading objects can be implemented well with one table
per object. Die to th efact, that each object and each relation have their own tables, it is easy to
add new objects and relations without disturbing the existent layout.
<br />
<br />
The follwing chapter depicts how the definition of objects and their relations is applied to the
database.
<br />
<br />
<br />
<h3 id="Chapter-2-Object-definitions"><a href="#Chapter-2-Object-definitions">2. Object definitions</a></h3>
An onject configuration contains the name of the object and the attributes. A simple configuration
file thus contains any number of sections, that follow the scheme printed below:
<gen:highlight type="apf-xml">
[{SectionName}]
{AttributeName} = "{AttributeType}"
...
</gen:highlight>
<strong>{SektionName}</strong> describes the name of the object (e.g. <strong>User</strong>),
<strong>{AttributeName}</strong> is the name of the attribute of the object (e.g. <strong>FirstName</strong>)
and <strong>{AttributeType}</strong> is the data type of the attribute. When you automatically setup
the database, the data types
<ul>
  <li>VARCHAR(<strong>{LENGTH}</strong>)</li>
  <li>TEXT</li>
  <li>DATE</li>
</ul>
are translated into the correct create statements. <strong>{LENGTH}</strong> must thereby be replaced
by the desired length of the string. Any other datatype definitions must be declared like in a
create statement.
<br />
<br />
The translation of the configuration into a create table statement follows this rules:
<ul>
  <li>
    The name of the table is concatinated by the name of the object in small letters and the prefix
    "ent_". In case of the object <strong>User</strong>, the table name is <strong>ent_user</strong>.
  </li>
  <li>
    The relations are defined in a separate configuration file (see chapter 3).
  </li>
  <li>
    The names of the attributes of an object are identical to the attributes of the configuration
    section. The values of the attribute definitions are used as data types.
  </li>
  <li>
    The name of the attributes may not be equal to reserved words of the database used. In case of
    the mysql database, the list of reserved words can be seen on
    <doku:link>http://dev.mysql.com/doc/refman/4.1/en/reserved-words.html</doku:link>.
  </li>
  <li>
    The name of the primary key of the table is combined of the name of the object and the suffix
    <strong>ID</strong>. In case of the <strong>User</strong> object, the name of the primary key is
    <strong>UserID</strong>.
  </li>
</ul>
<br />
<h3 id="Chapter-3-Relation-definitions"><a href="#Chapter-3-Relation-definitions">3. Relation definitions</a></h3>
The relation configuration contains the name and the type of relation as well as the source and target
object. The definition of the source and target objects must be defined as designed. Tis means, that
you must take care, that the relation's direction is defined concerning the UML diagram definition
(see <a href="./?Page=063-Generic-OR-mapper#Chapter-2-3-2-Relation-definition" title="Generic O/R mapper">2.3.2 Relation definition</a> for details)
A typical relation configuration file contains any amount of relation definition sections:
<gen:highlight type="apf-xml">
[{SectionName}]
Type = "{RelationType}"
SourceObject = "{SourceObjectName}"
TargetObject = "{TargetObjectName}"
</gen:highlight>
<strong>{SectionName}</strong> defines the name of the relation (e.g. <strong>User2Group</strong>),
<strong>{RelationType}</strong> the relation type and <strong>{SourceObjectName}</strong>
as well as <strong>{TargetObjectName}</strong> are object names as defined within the object
configuration file. The <strong>{RelationType}</strong> can contain <strong>COMPOSITION</strong>
or <strong>ASSOCIATION</strong>. These two types are equal to the relation types used in UML diarams.
<br />
<br />
The translation of the configuration into a create table statement follows this rules:
<ul>
  <li>
    The name of the table is concatinated by the name of the relation in small letters and the prefix
    <strong>cmp__</strong> (for compositions) or <strong>ass__</strong> (for assoziations).
  </li>
  <li>
    The name of the primary key of the relation table corresponds to the relation type. For
    compositions the key is named <strong>CMPID</strong>, for association tables the name is
    <strong>ASSID</strong>.
  </li>
  <li>
    The relation table contains a reference on the primary keys of the source and targe objects. The
    names of the foreign keys are equal to the object table's primary keys.
  </li>
  <li>
    The two foreign key columns are indexed within a combined JOIN index. Please note, that the index
    must be created beeing aware of both columns. This makes the index more selective and gains
    JOIN statement executions.
  </li>
</ul>
<br />
<h3 id="Chapter-4-Examples"><a href="#Chapter-4-Examples">4. Examples</a></h3>
The present chapter describes an example for the translation of object and relation definitions into
create table statements.
<br />
<br />
<h4 id="Chapter-4-1-Object-definition"><a href="#Chapter-4-1-Object-definition">4.1. Object definition</a></h4>
In order to use the following objects with the mapper
<gen:highlight type="ini">
[Application]
DisplayName = "VARCHAR(100)"

[User]
DisplayName = "VARCHAR(100)"
FirstName = "VARCHAR(100)"
LastName = "VARCHAR(100)"
StreetName = "VARCHAR(100)"
StreetNumber = "VARCHAR(100)"
ZIPCode = "VARCHAR(100)"
City = "VARCHAR(100)"
EMail = "VARCHAR(100)"
Phone = "VARCHAR(100)"
Mobile = "VARCHAR(100)"
Username = "VARCHAR(100)"
Password = "VARCHAR(100)"

[Group]
DisplayName = "VARCHAR(100)"
</gen:highlight>
it expechts the following tables beeing present in the database:
<gen:highlight type="sql">
CREATE TABLE IF NOT EXISTS `ent_application` (
  `ApplicationID` int(5) UNSIGNED NOT NULL auto_increment,
  `DisplayName` varchar(100) NOT NULL default '',
  `CreationTimestamp` timestamp NOT NULL default CURRENT_TIMESTAMP,
  `ModificationTimestamp` timestamp NOT NULL default '0000-00-00 00:00:00',
  PRIMARY KEY  (`ApplicationID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

CREATE TABLE IF NOT EXISTS `ent_group` (
  `GroupID` int(5) UNSIGNED NOT NULL auto_increment,
  `DisplayName` varchar(100) NOT NULL default '',
  `CreationTimestamp` timestamp NOT NULL default CURRENT_TIMESTAMP,
  `ModificationTimestamp` timestamp NOT NULL default '0000-00-00 00:00:00',
  PRIMARY KEY  (`GroupID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

CREATE TABLE IF NOT EXISTS `ent_user` (
  `UserID` int(5) UNSIGNED NOT NULL auto_increment,
  `DisplayName` varchar(100) NOT NULL default '',
  `FirstName` varchar(100) NOT NULL default '',
  `LastName` varchar(100) NOT NULL default '',
  `StreetName` varchar(100) NOT NULL default '',
  `StreetNumber` varchar(100) NOT NULL default '',
  `ZIPCode` varchar(100) NOT NULL default '',
  `City` varchar(100) NOT NULL default '',
  `EMail` varchar(100) NOT NULL default '',
  `Phone` varchar(100) NOT NULL default '',
  `Mobile` varchar(100) NOT NULL default '',
  `Username` varchar(100) NOT NULL default '',
  `Password` varchar(100) NOT NULL default '',
  `CreationTimestamp` timestamp NOT NULL default CURRENT_TIMESTAMP,
  `ModificationTimestamp` timestamp NOT NULL default '0000-00-00 00:00:00',
  PRIMARY KEY  (`UserID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
</gen:highlight>
The storage engine can also be set to <strong>INNODB</strong> if desired.
<br />
<br />
<br />
<h4 id="Chapter-4-2-Relation-definition"><a href="#Chapter-4-2-Relation-definition">4.2. Relation definition</a></h4>
For the following relation definitions
<gen:highlight type="ini">
[Application2Group]
Type = "COMPOSITION"
SourceObject = "Application"
TargetObject = "Group"

[Group2User]
Type = "ASSOCIATION"
SourceObject = "Group"
TargetObject = "User"

[Application2User]
Type = "COMPOSITION"
SourceObject = "Application"
TargetObject = "User"
</gen:highlight>
the mapper expects the tables described below:
<gen:highlight type="sql">
CREATE TABLE IF NOT EXISTS `ass_group2user` (
  `GroupID` int(5) UNSIGNED NOT NULL default '0',
  `UserID` int(5) UNSIGNED NOT NULL default '0',
  KEY `JOIN` (`GroupID`,`UserID`),
  KEY `REVERSEJOIN` (`UserID`,`GroupID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

CREATE TABLE IF NOT EXISTS `cmp_application2group` (
  `ApplicationID` int(5) UNSIGNED NOT NULL default '0',
  `GroupID` int(5) UNSIGNED NOT NULL default '0',
  KEY `JOIN` (`ApplicationID`,`GroupID`),
  KEY `REVERSEJOIN` (`GroupID`,`ApplicationID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

CREATE TABLE IF NOT EXISTS `cmp_application2user` (
  `ApplicationID` int(5) UNSIGNED NOT NULL default '0',
  `UserID` int(5) UNSIGNED NOT NULL default '0',
  KEY `JOIN` (`ApplicationID`,`UserID`),
  KEY `REVERSEJOIN` (`UserID`,`ApplicationID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
</gen:highlight>
<p>The storage engine can also be set to <em>INNODB</em> if desired.</p>
<div class="hint">
   Please note that the relation index definition has changed in 1.13. Thus, please note the 
   description under <int:link pageid="135" />.
</div>

<core:importdesign namespace="modules::comments::pres::templates" template="comment" categorykey="en_064" />