<doku:title parent="071" tags="erweiterung,funktionen,formular,taglibs,controller," title="Erweiterung der Formularfunktionen" urlname="Erweiterung-der-Formularfunktionen">
  Das Adventure PHP Framework beinhaltet bereits alle üblichen Formular-Elemente, es sind jedoch
  sicher nicht alle Spezialfälle abgedeckt. Um die Funktionen der mitgelieferten Formular-Tags
  einfach erweitern zu können, wurde im Release 1.7-BETA das Tag form:addtaglib eingeführt.
  Mit Hilfe dieser Taglib können beliebige weitere Taglibs eingebunden werden.
</doku:title>
<h3 id="Chapter-1-Einleitung"><a href="#Chapter-1-Einleitung">1. Einleitung</a></h3>
Das Adventure PHP Framework beinhaltet bereits alle üblichen Formular-Elemente, es sind jedoch
sicher nicht alle Spezialfälle abgedeckt. Um die Funktionen der mitgelieferten Formular-Tags
einfach erweitern zu können, wurde im Release 1.7-BETA das Tag <strong>&lt;form:addtaglib /&gt;</strong>
eingeführt. Mit Hilfe dieser Taglib können beliebige weitere Taglibs eingebunden werden.
Diese können dann dazu genutzt werden, die für den aktuellen Anwendungsfall gewünschte
Funktionalität nachzurüsten.
<br />
<br />
Das vorliegende Tutorial möchte an Hand von zwei Beispielen aufzeigen, wie der neue Tag genutzt
werden kann und welche Möglichkeiten sich dadurch ergeben. Im ersten Beispiel wird ein einfaches
Tag vorgestellt, mit dem das Datum im Formular als verstecktes Feld mitgeführt wird und das
Formular auf invalid setzt, wenn dieses innerhalb von einer konfigurierbaren Zeit abgeschickt wird.
Das dritte Kapitel zeigt, wie mit ein CAPTCHA-Tag implementiert werden kann.
<br />
<br />
<br />
<h3 id="Chapter-2-Anti-SPAM-Tag"><a href="#Chapter-2-Anti-SPAM-Tag">2. Anti-SPAM-Tag</a></h3>
<h4 id="Chapter-2-1-Idee"><a href="#Chapter-2-1-Idee">2.1. Idee</a></h4>
Eine sehr einfache, jedoch verhältnismäßig wirkungsvolle Möglichkeit, einen
SPAM-Schutz für ein Formular zu erstellen, ist es, die Zeit zu messen, die ein Benutzer
benötigt, um ein Formular auszufüllen. Wird das Formular in zu kurzer Zeit ausgefüllt
- etwa durch einen Bot - so wird das Formular als invalide gekennzeichnet und nicht abgeschickt. Wird
mindestend die konfigurierte Zeit für das Ausfüllen benötigt, wird das Abschicken
akzeptiert.
<br />
<br />
Nachteil dieser Vorgehensweise ist, dass die Zeit, die als minimale Ausfüllzeit hinterlegt wird,
empirisch bestimmt werden muss. Das kann im schlechtesten Fall dazu führen, dass ein Benutzer
ein Formular nochmals abschicken muss.
<br />
<br />
<br />
<h4 id="Chapter-2-2-Umsetzung"><a href="#Chapter-2-2-Umsetzung">2.2. Umsetzung</a></h4>
Für die Umsetzung der unter 2.1. beschriebenen Idee wird im Folgenden ein neues Tag erstellt,
das das Formular als invalid kennzeichnet, wenn die Zeit zwischen Aufruf und Absenden zu kurz ist. Da
jedes Formular eine individuelle Ausfüllzeit besitzt, wird im Tag ein Attribut vorgesehen, mit
dem die Ausfüllzeit konfigurierbar gestaltet wird. Die Signatur des Tags hat damit folgende
Gestalt:
<gen:highlight type="apf-xml">
&lt;form:antispam minfilltime="..." /&gt;
</gen:highlight>
Vor der Verwendung des Tags muss dieser innerhalb des <strong>&lt;html:form /&gt;</strong>-Tags per
<gen:highlight type="apf-xml">
&lt;form:addtaglib namespace="..." prefix="form" class="antispam" &gt;
</gen:highlight>
<p>
   bekannt gemacht werden.
</p>
<p>
   Wie unter <int:link pageid="147" /> beschrieben ist, muss für jeden Tag eine TagLib-Implementierung erstellt
   werden. Der Name der TagLib-Klasse ergibt sich dabei aus dem Präfix und der Klasse des Tags. Die Implementierung des
   Anti-Spam-Tags lautet damit <strong>form_taglib_antispam</strong>. Die Aufgabe der Klasse ist es nun, ein verstecktes
   Formularfeld hinzuzufügen, das speichert, wann das Formular ausgegeben worden ist. Weiterhin muss die Zeit zwischen
   dem letzten Request und der aktuellen Zeit vergleichen und bei Bedarf das Formular benachrichtigt werden. Der Code
   der Klasse stellt sich damit wie folgt dar:
</p>
<gen:highlight type="php">
class form_taglib_antispam extends form_control {

   public function onAfterAppend() {

      if ($this->getAttribute('minfilltime') === null) {
         $formName = $this->getParentObject()->getAttribute('name');
         throw new InvalidArgumentException('[form_taglib_antispam::onAfterAppend()] There is not '
            .'attribute "minfilltime" given in the anti spam tag definition in form "' . $formName
            . '"! Please provide the attribute mentioned containing the time in seconds the user '
            .'needs to fill in the form.');
      }

      $antiSpamName = $this->getAntiSpamName();

      if (isset($_REQUEST[$antiSpamName])) {

         $currentTime = date('U');
         $previousTime = $_REQUEST[$antiSpamName];
         $minFillTime = $this->getAttribute('minfilltime');

         // Formular-Element als invalid markieren fals die Zeit abgelaufen ist
         if (($currentTime - $minFillTime) < $previousTime) {
            $this->markAsInvalid();
         }
      }
   }

   public function transform() {
      return '<input type="hidden" name="' . $this->getAntiSpamName() . '" value="' . date('U') . '" />';
   }

   public function getAntiSpamName() {
      return strtolower($this->getParentObject()->getAttribute('name')) . '_antispam';
   }

   protected function __presetValue() {

   }

}
</gen:highlight>
Die private Methode <strong>getAntiSpamName()</strong> generiert den Namen des Feldes aus dem Namen
des Formulars und dem Zusatz <strong>_antispam</strong>. Da der Name hart verdratet ist, darf das
Anti-SPAM-Tag nur einmal pro Formular verwendet werden, da es sonst zu Überlagerungen kommt.
<br />
<br />
<br />
<h4 id="Chapter-antispam"><a href="#Chapter-antispam">2.3. Beispiel</a></h4>
Wird der Button des Beispiel-Formulars innerhalb von weniger als 10 Sekunden geklickt, wird die
Eingabe nicht akzeptiert und das Formular als invalid gekennzeichnet.
<br />
<br />
<center>
  <div style="border: 1px dotted gray; width: 200px; padding: 5px; background-color: #efefef;">
    <core:importdesign namespace="sites::apf::pres::templates::content" template="form_antispam_example" />
  </div>
</center>
<br />
<br />
Ein Manko der oben gezeigten Implementierung ist, dass ein auf Grund einer zu kurzen Ausfüllzeit
als invalid gekennzeichnetes Formular beim zweiten Absenden erneut als invalid gekennzeichnet wird,
da das Formular nach dem ersten Ausfüllen bereits gefüllt ist. Um dieses Problem zu umgehen,
sollte der Status des Formulars ("<em>Wurde das Formular schon einmal abgesendet?</em>") in der Session
mitgeführt werden.
<br />
<br />
<br />
<h3 id="Chapter-3-CAPTCHA-Tag"><a href="#Chapter-3-CAPTCHA-Tag">3. CAPTCHA-Tag</a></h3>
<h4 id="Chapter-3-1-Idee"><a href="#Chapter-3-1-Idee">3.1. Idee</a></h4>
Ähnlich dem im deutschsprachigen Forum unter
<doku:link>http://forum.adventure-php-framework.org/de/viewtopic.php?p=125#p125</doku:link>
vorgestellten Konzept, soll in diesem Tutorial ein Tag erstellt werden, der zur erweiterten
Validierung in ein Formular eingebunden werden kann. Der Tag soll zur generischen Verwendbarkeit
folgende Attribute unterstützen:
<ul>
  <li>
    <strong>button</strong>: Name des Buttons auf dessen Klick eine Validierung durchgeführt
    werden soll.
  </li>
  <li>
    <strong>validate</strong>: "true", falls eine Validierung durchgeführt werden soll, "false"
    oder fehlendes Attribut, wenn keine Validierung gewünscht ist.
  </li>
  <li>
    <strong>image_class</strong>: CSS-Klasse für das Captcha-Bild
  </li>
  <li>
    <strong>image_style</strong>: CSS-Stile für das Captcha-Bild
  </li>
  <li>
    <strong>text_class</strong>: CSS-Klasse für das Text-Feld
  </li>
  <li>
    <strong>text_style</strong>: CSS-Stile für das Text-Feld
  </li>
</ul>
Aus den genannten Anforderungen ergibt sich folgende Tag-Beschreibung:
<gen:highlight type="apf-xml">
&lt;form:captcha
            button = ""
            [validate = ""]
            [image_class = ""]
            [image_style = ""]
            [text_class = ""]
            [text_style = ""]
/&gt;
</gen:highlight>
<br />
<h4 id="Chapter-3-2-Umsetzung"><a href="#Chapter-3-2-Umsetzung">3.2. Umsetzung</a></h4>
Um den Tag verwenden zu können, muss dieser dem Formular per
<gen:highlight type="apf-xml">
&lt;form:addtaglib namespace="modules::captcha::pres::taglib" prefix="form" class="captcha" &gt;
</gen:highlight>
bekannt gemacht werden.
<br />
<br />
<br />
<h4 id="Chapter-captcha"><a href="#Chapter-captcha">3.3. Beispiel</a></h4>
Das folgende Formular zeigt die Einsatzmöglichkeit des Tags. Aus Sicherheitsgründen
generiert der Tag bei jedem Aufruf einen neuen Captcha-String.
<br />
<br />
<center>
  <div style="border: 1px dotted gray; width: 400px; padding: 5px; background-color: #efefef;">
    <core:importdesign namespace="sites::apf::pres::templates::content" template="form_captcha_example" />
  </div>
</center>
<br />
<br />
<core:importdesign namespace="modules::comments::pres::templates" template="comment" categorykey="de_070" />