<doku:title parent="119" tags="fehler,behandlung,fehlerbehandlung,registry,core,errorhandler" title="Fehlerbehandlung" urlname="Fehlerbehandlung">
  Das Kapitel Fehlerbehandlung beschreibt das im Framework enthaltene Fehlerhandling-Konzept und
  zeigt die Verwendung sowie die Erweiterung auf.
</doku:title>
<h3 id="Chapter-1-Einleitung"><a href="#Chapter-1-Einleitung">1. Einleitung</a></h3>
<p>
   Zur globalen Fehlerbehandlung nutzt das Framework die Funktion <strong>errorHandler</strong>. Diese
   hat die Aufgabe, alle auftretenden Fehler abzufangen und an zentraler Stelle zu behandeln. Zu diesem
   Zweck nutzt die Funktion eine <strong>ErrorHandler</strong>-Komponente, die über die Registry
   konfigurierbar ist. Letztere ist dann für die eigentliche Behandlung eines Fehlers verantwortlich.
</p>
<p>
   Die im APF vorkonfigurierte Fehlerbehandlung beinhaltet dabei die Speicherung der Meldung in einer
   Log-Datei und die Ausgabe des Fehlers inklusive des Stacktraces. Details können der
   <a href="./?Seite=002-API-Dokumentation" title="API-Dokumentation">API-Dokumentation</a> der Klasse
   <strong>DefaultErrorHandler</strong> entnommen werden.
</p>

<h3 id="Chapter-2-Konfiguration"><a href="#Chapter-2-Konfiguration">2. Konfiguration</a></h3>
<p>
   Um den vorkonfigurierten <strong>DefaultErrorHandler</strong> durch einen eigenen zu ersetzen muss der
   Registry-Offset <strong>ErrorHandler</strong> im Namespace <strong>apf::core</strong> mit der
   gewünschten <strong>ErrorHandlerDefinition</strong> ersetzt werden. Die Konfiguration einer
   eigenen Fehlerbehandlungsroutine muss dabei in der Bootstrap-Datei nach dem Einbinden der
   <em>pagecontroller.php</em> erfolgen.
</p>
<p>Die Definition einer eigenen Fehler-Behandlungskomponente gestaltet sich wie folgt:</p>
<gen:highlight type="php">
Registry::register(
   'apf::core',
   'ErrorHandler',
   new ErrorHandlerDefinition(
      'my::errorhandler::namespace',
      'MyErrorHandler'
   )
);
</gen:highlight>
<p>
   Wie aus dem Code-Beispiel zu erkennen ist, wird ein <em>ErrorHandler</em> durch seinen Namespace
   und seinen Klassennamen referenziert.
</p>
<div class="hint">
   Enthält der Registry-Offset keine gültige Definition, werden
   auftretende Fehler in Text-Form ausgegeben. Der Fallback-Modus ist daran zu erkennen, dass die Meldung
   mit
   <gen:highlight type="apf-xml">
   APF catchable error:
   </gen:highlight>
   beginnt. In diesem Fall muss die Definition oder die Implementierung der ErrorHandler-Klasse
   überprüft werden.
</div>
<div class="warn">
   Um den <em>ErrorHandler</em> zu deaktivieren kann der Registry-Eintrag mit <strong>null</strong>
   initialisiert werden. Ist dies der Fall, werden die Fehler-Informationen direkt ausgegeben. Dies
   wird aus Sicherheits-Gründen nicht empfohlen, da sensible Daten enthalten sein können.
</div>

<h3 id="Chapter-3-Erweiterung"><a href="#Chapter-3-Erweiterung">3. Erweiterung</a></h3>
<p>
   Um eine eigene Fehlerbehandlung einzuführen, muss die Klasse <strong>AbstractErrorHandler</strong>
   implementiert werden. Diese definiert folgendes Interface:
</p>
<gen:highlight type="php">
class AbstractErrorHandler extends APFObject {

   public function handleError($errorNumber,$errorMessage,$errorFile,$errorLine){
   }

}
</gen:highlight>
<p>Bei Auftreten eines Fehlers werden der Methode <strong>handleError</strong> die Parameter</p>
<ul>
  <li>Fehler-Nummer</li>
  <li>Fehler-Meldung</li>
  <li>Datei, in der der Fehler auftritt</li>
  <li>Zeile, in der der Fehler auftritt</li>
</ul>
<p>
   übergeben. Da die Fehlerbehandlung in einer eigenen Klasse stattfindet, die nicht mit dem
   ServiceManager erzeugt wurde, steht der Zugriff auf den aktuellen <strong>Context</strong> und die
   aktuelle <strong>Sprache</strong> <em>nicht</em> zur Verfügung!
</p>
<p>
   Sollten diese Informationen für die Behandlung des Fehlers notwendig sein, müssen diese
   über in einer Applikation verfügbaren Informationscontainer (z.B. Model-Klasse eines Modules)
   bezogen werden. Der Umgebungsparameter steht wie in der Dokumentation beschrieben über die
   Registry zur Verfügung.
</p>

<h3 id="Chapter-4-Anwendung"><a href="#Chapter-4-Anwendung">4. Anwendung</a></h3>
<p>Der globale Fehler-Behandlungsmechanismus kann einfach durch Aufrufen der PHP-Funktion</p>
<gen:highlight type="php">
trigger_error();
</gen:highlight>
<p>
   genutzt werden. Details können der Online-Dokumentation unter
   <a class="external" href="http://php.net/trigger_error">http://php.net/trigger_error</a>
   entnommen werden.
</p>

<h3 id="Chapter-5-Weitere-ErrorHandler"><a href="#Chapter-5-Weitere-ErrorHandler">5. Weitere ErrorHandler</a></h3>
<p>
   Das Release 1.13 bringt zwei weitere ErrorHandler-Implementierungen mit, die für den Einsatz in
   Live-Umgebungen empfohlen werden. Live-Systeme gilt es im besonderen vor Kompromittierung zu
   schützen. Daher sind der <em>ProductionErrorHandler</em> und <em>ConfigurableErrorHandler</em>
   dafür ausgelegt, möglichst die bei einem Fehler gesammelten Daten vor dem potentiellen Angreifer
   zu verstecken.
</p>

<h4 id="Chapter-5-1-ProductionErrorHandler"><a href="#Chapter-5-1-ProductionErrorHandler">5.1. ProductionErrorHandler</a></h4>
<p>
   Tritt ein Fehler auf, fügt der <em>ProductionErrorHandler</em> diesen an die globale Log-Datei an
   und leitet auf eine zuvor konfigurierte Seite weiter. Damit schützt er vor der Veröffentlichung
   von Daten, die zum Zeitpunkt des Fehlers gesammelt wurden.
</p>
<p>
   Die Konfiguration kann nach Einbinden der Datei <em>pagecontroller.php</em> wie folgt vorgenommen
   werden:
</p>
<gen:highlight type="php">
Registry::register(
   'apf::core',
   'ErrorHandler',
   new ErrorHandlerDefinition(
      'core::errorhandler',
      'ProductionErrorHandler'
   )
);
Registry::register(
   'apf::core::errorhandler',
   'ProductionErrorRedirectUrl',
   '/pages/global-error'
);
</gen:highlight>
<p>
   Wird die Registry-Direktive <em>ProductionErrorRedirectUrl</em> nicht gesetzt, leitet der
   ErrorHandler nach &quot;/&quot; weiter.
</p>

<h4 id="Chapter-5-2-ConfigurableErrorHandler"><a href="#Chapter-5-2-ConfigurableErrorHandler">5.2. ConfigurableErrorHandler</a></h4>
<p>
   Der <em>ConfigurableErrorHandler</em> ermöglicht es, Fehler unter einem gewissen Level zu
   getrennt zu behandeln. Hierzu kann über die Registry ein Level fest gelegt werden unterhalb dessen
   der ErrorHandler den Fehler ignoriert. Ist dieser Level überschritten, verhält er sich wie der
   <em>DefaultErrorHandler</em>.
</p>
<p>
   Die Konfiguration kann nach Einbinden der Datei <em>pagecontroller.php</em> wie folgt vorgenommen
   werden:
</p>
<gen:highlight type="php">
Registry::register(
   'apf::core',
   'ErrorHandler',
   new ErrorHandlerDefinition(
      'core::errorhandler',
      'ConfigurableErrorHandler'
   )
);
Registry::register(
   'apf::core::errorhandler',
   'ConfigurableErrorReportingLevel',
   E_ALL ^ E_NOTICE
);
</gen:highlight>
<p>
   Mit der gewählten Konfiguration werden alle Fehler ausser <em>E_NOTICE</em>-Fehler behandelt.
   Details zur Konfiguration von Fehler-Leveln kann der
   <a class="external" href="http://de.php.net/manual/en/errorfunc.constants.php">PHP-Dokumentation</a>
   entnommen werden.
</p>

<core:importdesign namespace="modules::comments::pres::templates" template="comment" categorykey="de_101" />