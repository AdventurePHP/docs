<doku:title parent="119" tags="manuelles,setup,datenbank,object,relational,mapping,or,mapper,generisch,beziehungen,objekte,objektbäume,objekt strukturen,konfiguration,verwendung" title="Generischer O/R-Mapper - Manuelles Setup der Datenbank" urlname="Generischer-OR-Mapper-Manuelles-Setup-der-Datenbank">
  Das Modul genericormapper bietet einen generischen O/R-Mapper, der voll in das APF integriert ist
  uns dessen Mechanismen - z.B. Konfiguration - nutzt um die gewünschten Objekte und deren
  Beziehungen zu konfigurieren. Auf dieser Seite wird das manuelle Setup der zu verwendenden Datenbank
  beschrieben.
</doku:title>
<div class="warn">
   Das manuelle Setup der Datenbank wird explizit nicht empfohlen, da mit Release 1.15 Änderungen an der Auflösung von
   Beziehungen vorgenommen wurden. Diese erhöhen die Komplexität für ein manuelles Zusammenstellen der Statements
   deutlich. Bitte nutzen Sie daher die unter <int:link pageid="063" anchor="Chapter-3-Datenbank-Setup" /> beschriebene
   Vorgehensweise.
</div>

<h3 id="Chapter-1-Einleitung"><a href="#Chapter-1-Einleitung">1. Einleitung</a></h3>
Der O/R-Mapper hält sich beim Design des Datenbank-Layouts an eine einfache Konvention:
<strong>Jedes Objekt wird in einer Tabelle abgebildet, jede Beziehung in eine weitere</strong>. Dieses
Vorgehen ist ein guter Mittelweg zwischen Normalisierung und guter Performance, da das Laden von
Objekten auf Tabellenebene schnell abgebildet werden kann, das Modell jedoch trotzdem die Generik
mitbringt, weitere Objekte hinzuzufügen - etwa wegen weiteren Modulen - und die Beziehung zwischen
diesen neuen Objekten das bisherige Layout nicht stört.
<br />
<br />
Das folgende Kapitel erklärt nun, wie die Definition der Objekte und deren Beziehungen in
Datenbank-Tabellen umgesetzt werden.
<br />
<br />
<br />
<h3 id="Chapter-2-Objektdefinitionen"><a href="#Chapter-2-Objektdefinitionen">2. Umsetzung der Objektdefinitionen</a></h3>
Die Konfiguration der Objekte enthält im wesentlichen den Namen und die Attribute eines Objekts.
Eine typische Konfigurationsdatei enthält dabei eine beliebige Anzahl folgender Definitionen:
<gen:highlight type="apf-xml">
[{SektionsName}]
{AttributName} = "{AttributTyp}"
...
</gen:highlight>
<strong>{SektionsName}</strong> ist dabei der Name des Objekts (z.B. <strong>User</strong>),
<strong>{AttributName}</strong> der Name eines Attributs des Objekts (z.B. <strong>FirstName</strong>)
und <strong>{AttributTyp}</strong> der Daten-Typ des Attributs. Beim automatischen Setup werden die
Daten-Typen
<ul>
  <li>VARCHAR(<strong>{LENGTH}</strong>)</li>
  <li>TEXT</li>
  <li>DATE</li>
</ul>
jeweils in die richtigen SQL-Statements übersetzt. <strong>{LENGTH}</strong> ist dabei durch
eine entsprechende Zahl (gewünschte Länge der Zeichenkette) zu ersetzen. Alle weiteren
Datentypen-Deklarationen müssen ausformuliert werden.
<br />
<br />
Für die Umsetzung der Konfiguration in einzelne Tabellen gelten folgende Regeln:
<ul>
  <li>
    Der Name der Tabelle ergibt sich aus dem Namen des Objektes in Kleinbuchstaben mit dem
    Prefix "ent_". Im Fall des Objekts <strong>User</strong> ergibt sich somit ein Tabellenname
    <strong>ent_user</strong>.
  </li>
  <li>
    Die Beziehungen zwischen Objekten werden in einer eigenen Konfiguration definiert
    (siehe Kapitel 3).
  </li>
  <li>
    Die Namen der Attribute eines Objekts sind identisch mit den Attributen der Konfigurationssektion.
    Die Werte der Attribut-Definitionen werden zur Auslegung des Datentyps verwendet.
  </li>
  <li>
    Die Namen der Attribute dürfen nicht mit reservierten Wörtern der verwendeten Datenbank
    übereinstimmen. Im Fall von MySQL, kann diese Liste unter
    <doku:link>http://dev.mysql.com/doc/refman/4.1/en/reserved-words.html</doku:link> eingesehen
    werden.
  </li>
  <li>
    Der Name des Primärschlüssels der Tabelle wird aus dem Namen des Objekts und dem
    Suffix <strong>ID</strong> generiert. Im Fall des Objekts <strong>User</strong> ergibt sich somit
    der Name <strong>UserID</strong>.
  </li>
</ul>
<br />
<h3 id="Chapter-3-Beziehungsdefinitionen"><a href="#Chapter-3-Beziehungsdefinitionen">3. Umsetzung der Beziehungsdefinitionen</a></h3>
Die Konfiguration der Beziehungen enthält im wesentlichen den Namen und die Qualität der
Beziehung sowie das referenzierte Quell- und Zielobjekt. Bei der Auslegung der Beziehungsrichtung
muss auf die Bedeutung der Beziehung im Objektmodell geachtet werden (siehe hierzu
<int:link pageid="063" anchor="Chapter-2-3-2-Beziehungsdefinition">2.3.2. Beziehungsdefinition</int:link>).
Eine typische Konfigurationsdatei enthält dabei eine beliebige Anzahl folgender Definitionen:
<gen:highlight type="apf-xml">
[{SektionsName}]
Type = "{BeziehungsTyp}"
SourceObject = "{SourceObjektName}"
TargetObject = "{TargetObjektName}"
</gen:highlight>
<strong>{SektionsName}</strong> ist dabei der Name der Beziehung (z.B. <strong>User2Group</strong>),
<strong>{BeziehungsTyp}</strong> die Qualität der Beziehung und <strong>{SourceObjektName}</strong>
sowie <strong>{TargetObjektName}</strong> Namen von Objekten der Objekt-Konfigurationsdatei.
Gültige Werte für Beziehungsqualitäten (<strong>{BeziehungsTyp}</strong>) sind
<strong>COMPOSITION</strong> für eine Komposition und <strong>ASSOCIATION</strong> für
Assoziationen.
<br />
<br />
Für die Umsetzung der Konfiguration in einzelne Tabellen gelten folgende Regeln:
<ul>
  <li>
    Der Name der Tabelle ergibt sich aus dem Namen der Beziehung in Kleinbuchstaben und dem Präfix
    <strong>cmp__</strong> (für Kompositionsbeziehungen) oder <strong>ass__</strong> (für
    Assoziationsbeziehungen).
  </li>
  <li>
    Der Primärschlüssel der Beziehungstabelle ergibt sich aus der Qualität der Beziehung.
    Er lautet <strong>CMPID</strong> (für Kompositionsbeziehungen) oder <strong>ASSID</strong>
    (für Assoziationsbeziehungen).
  </li>
  <li>
    Die Beziehungstabelle muss jeweils eine Refrenz auf den Primärschlüssel der Quell- und
    Ziel-Objekt-Tabelle besitzen. Die Namen der Fremdschlüsselspalten werden identisch den
    Namen der Fremdschlüssel-IDs gewählt.
  </li>
  <li>
    Über die beiden Fremdschlüssel-Spalten wird ein Index gelegt, der den JOIN-Index
    darstellt. Hier ist wichtig, dass der Index über beide Spalten gelegt wird, da somit eine
    höhere Selektivität des Indizes beim JOIN erreicht werden kann.
  </li>
</ul>
<br />
<h3 id="Chapter-4-Beispiel"><a href="#Chapter-4-Beispiel">4. Beispiel</a></h3>
Das vorliegende Kapitel möchte je ein Beispiel für die Umsetzung von Objekt- und
Beziehungsdefinition in Datenbanktabellen geben.
<br />
<br />
<h4 id="Chapter-4-1-Objektdefinition"><a href="#Chapter-4-1-Objektdefinition">4.1. Objektdefinition</a></h4>
Für die Objektdefinition
<gen:highlight type="ini">
[Application]
DisplayName = "VARCHAR(100)"

[User]
DisplayName = "VARCHAR(100)"
FirstName = "VARCHAR(100)"
LastName = "VARCHAR(100)"
StreetName = "VARCHAR(100)"
StreetNumber = "VARCHAR(100)"
ZIPCode = "VARCHAR(100)"
City = "VARCHAR(100)"
EMail = "VARCHAR(100)"
Phone = "VARCHAR(100)"
Mobile = "VARCHAR(100)"
Username = "VARCHAR(100)"
Password = "VARCHAR(100)"

[Group]
DisplayName = "VARCHAR(100)"
</gen:highlight>
erwartet der O/R-Mapper die Tabellen-Definition
<gen:highlight type="apf-xml">
CREATE TABLE IF NOT EXISTS `ent_application` (
  `ApplicationID` int(5) UNSIGNED NOT NULL auto_increment,
  `DisplayName` varchar(100) NOT NULL default '',
  `CreationTimestamp` timestamp NOT NULL default CURRENT_TIMESTAMP,
  `ModificationTimestamp` timestamp NOT NULL default '0000-00-00 00:00:00',
  PRIMARY KEY  (`ApplicationID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

CREATE TABLE IF NOT EXISTS `ent_group` (
  `GroupID` int(5) UNSIGNED NOT NULL auto_increment,
  `DisplayName` varchar(100) NOT NULL default '',
  `CreationTimestamp` timestamp NOT NULL default CURRENT_TIMESTAMP,
  `ModificationTimestamp` timestamp NOT NULL default '0000-00-00 00:00:00',
  PRIMARY KEY  (`GroupID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

CREATE TABLE IF NOT EXISTS `ent_user` (
  `UserID` int(5) UNSIGNED NOT NULL auto_increment,
  `DisplayName` varchar(100) NOT NULL default '',
  `FirstName` varchar(100) NOT NULL default '',
  `LastName` varchar(100) NOT NULL default '',
  `StreetName` varchar(100) NOT NULL default '',
  `StreetNumber` varchar(100) NOT NULL default '',
  `ZIPCode` varchar(100) NOT NULL default '',
  `City` varchar(100) NOT NULL default '',
  `EMail` varchar(100) NOT NULL default '',
  `Phone` varchar(100) NOT NULL default '',
  `Mobile` varchar(100) NOT NULL default '',
  `Username` varchar(100) NOT NULL default '',
  `Password` varchar(100) NOT NULL default '',
  `CreationTimestamp` timestamp NOT NULL default CURRENT_TIMESTAMP,
  `ModificationTimestamp` timestamp NOT NULL default '0000-00-00 00:00:00',
  PRIMARY KEY  (`UserID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
</gen:highlight>
Als Storage-Engine kann auch <strong>INNODB</strong> verwendet werden.
<br />
<br />
<br />
<h4 id="Chapter-4-2-Beziehungsdefinition"><a href="#Chapter-4-2-Beziehungsdefinition">4.2. Beziehungsdefinition</a></h4>
Für die Beziehungsdefinition
<gen:highlight type="ini">
[Application2Group]
Type = "COMPOSITION"
SourceObject = "Application"
TargetObject = "Group"

[Group2User]
Type = "ASSOCIATION"
SourceObject = "Group"
TargetObject = "User"

[Application2User]
Type = "COMPOSITION"
SourceObject = "Application"
TargetObject = "User"
</gen:highlight>
erwartet der O/R-Mapper die Tabellen-Definition
<gen:highlight type="apf-xml">
CREATE TABLE IF NOT EXISTS `ass_group2user` (
  `GroupID` int(5) UNSIGNED NOT NULL default '0',
  `UserID` int(5) UNSIGNED NOT NULL default '0',
  KEY `JOIN` (`GroupID`,`UserID`),
  KEY `REVERSEJOIN` (`UserID`,`GroupID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

CREATE TABLE IF NOT EXISTS `cmp_application2group` (
  `ApplicationID` int(5) UNSIGNED NOT NULL default '0',
  `GroupID` int(5) UNSIGNED NOT NULL default '0',
  KEY `JOIN` (`ApplicationID`,`GroupID`),
  KEY `REVERSEJOIN` (`GroupID`,`ApplicationID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;

CREATE TABLE IF NOT EXISTS `cmp_application2user` (
  `ApplicationID` int(5) UNSIGNED NOT NULL default '0',
  `UserID` int(5) UNSIGNED NOT NULL default '0',
  KEY `JOIN` (`ApplicationID`,`UserID`),
  KEY `REVERSEJOIN` (`UserID`,`ApplicationID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
</gen:highlight>
<p>Als Storage-Engine kann auch <em>INNODB</em> verwendet werden.</p>
<div class="hint">
   Bitte beachten Sie, dass sich die Definition der Beziehungs-Indizes in Version 1.13 geändert
   hat. Details können dem Artikel <int:link pageid="135" /> entnommen werden.
</div>

<core:importdesign namespace="modules::comments::pres::templates" template="comment" categorykey="de_064" />