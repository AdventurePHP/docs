<doku:title parent="119" tags="dokumentation,klassen referenz,klassen,referenz,singleton,connectionmanager" title="ConnectionManager" urlname="ConnectionManager">
  Zweck des ConnectionManagers ist es, eine Konvention zu definieren, wie die Konfiguration und
  Implementierung einer Datenbank-Zugriffsschnittstelle gestaltet sein soll. Idealerweise
  erm&ouml;glicht diese Vorgehensweise einen einfachen Austausch einer Treiberschicht gegen eine
  andere um von einer Datenbank zur anderen zu wechseln.
</doku:title>
<p>
   Zweck des ConnectionManagers ist es, eine Konvention zu definieren, wie die Konfiguration und
   Implementierung einer Datenbank-Zugriffsschnittstelle gestaltet sein soll. Idealerweise
   erm&ouml;glicht diese Vorgehensweise einen einfachen Austausch einer Treiberschicht gegen eine andere
   um von einer Datenbank zur anderen zu wechseln.
</p>
<p>
   Trotz, dass dieser Ansatz hinsichtlich der Unterschiede zwischen Datenbanken sehr ambitioniert ist,
   vereinheitlicht er dennoch die API und schafft ein gemeinsames Verst&auml;ndnis f&uuml;r den Zugriff
   der Datenschicht einer Applikation auf die Datenbank-Treiberschicht.
</p>

<h3 id="Chapter-1-Konfiguration"><a href="#Chapter-1-Konfiguration">1. Konfiguration</a></h3>
Der <strong>ConnectionManager</strong> fungiert als Factory f&uuml;r konkrete Implementierungen
eines Datenbanktreibers. Um den gew&uuml;nschte Treiber laden zu k&ouml;nnen, muss dieser
zun&auml;chst konfiguriert werden. Die geschieht in der Konfigurationsdatei
<gen:highlight type="code">/config/core/database/{CONTEXT}/{ENVIRONMENT}_connections.ini</gen:highlight>
Details zu Konfigurationsdateien k&ouml;nnen dem Kapitel <int:link pageid="134" /> entnommen werden.
Die Konfigurationsdatei enth&auml;lt je eine Sektion f&uuml;r einen Treiber:
<gen:highlight type="ini">
[Sektionsname]
DB.Host = ""
DB.User = ""
DB.Pass = ""
DB.Name = ""
[DB.DebugMode = "true|false"]
</gen:highlight>
<p>
   Der <strong>Sektionsname</strong> dient als Referenz f&uuml;r die Erstellung der Treiber-Instanz,
   <strong>DB.Host</strong> beinhaltet den Hostnamen des Datenbank-Server, <strong>DB.User</strong> und
   <strong>DB.Pass</strong> die Authentifizierungsdaten und <strong>DB.Name</strong> benennt die zu
   verwendende Datenbank. <strong>DB.Type</strong> dient zur Definition des zur verwendenen Treibers
   und <strong>DB.DebugMode</strong> entscheidet, ob der Debug-Modus des Treibers aktiviert werden soll
   oder nicht.
</p>
<div class="hint">
   Der Debug-Modus kann dazu genutzt werden, das aktuell ausgef&uuml;hrte Statement auszugeben.
   Alternativ dazu kann der optionale Parameter <em>$logStatement</em> der Methoden
   <em>executeStatement()</em> und <em>executeTextStatement()</em> genutzt werden um das aktuell
   ausgef&uuml;hrte Statement in eine Log-Datei zu schreiben. Details zur Funktion k&ouml;nnen der
   <int:link pageid="002" /> entnommen werden.
</div>

<h3 id="Chapter-2-Anwendung"><a href="#Chapter-2-Anwendung">2. Anwendung</a></h3>
Um den <strong>ConnectionManager</strong> einsetzen zu k&ouml;nnen muss dieser zun&auml;chst per
<gen:highlight type="php">
import('core::database','ConnectionManager');
</gen:highlight>
eingebunden werden. Anschlie&szlig;end kann per
<gen:highlight type="php">
$cM = &$this->getServiceObject('core::database','ConnectionManager');
$driver = &$cM->getConnection('Sektionsname');
</gen:highlight>
<p>
   eine Instanz eines Datenbank-Treibers erzeugt werden.
</p>

<h3 id="Chapter-3-Erweiterung"><a href="#Chapter-3-Erweiterung">3. Erweiterung</a></h3>
<p>
   Gem&auml;&szlig; der Definition der abstrakten Klasse <strong>AbstractDatabaseHandler</strong>
   k&ouml;nnen weitere Datenbank-Abstraktions-Klassen hinzugef&uuml;gt werden. Um diese mit dem
   <strong>ConnectionManager</strong> verwenden zu k&ouml;nnen, m&uuml;ssen diese im Namespace
   <strong>core::database</strong> abgelegt werden und von der Klasse
   <strong>AbstractDatabaseHandler</strong> ableiten.
</p>

<h3 id="Chapter-4-Vorhandene-Treiberschichten"><a href="#Chapter-4-Vorhandene-Treiberschichten">4. Vorhandene Treiberschichten</a></h3>
<p>Das Framework liefert zwei Treiberschichten mit:</p>
<ul>
  <li>MySQLx: MySQL-Treiberschicht. Setzt auf die mysql_*-Funktionen auf</li>
  <li>SQLite: SQLite-Treiberschicht. Setzt auf die sqlite_*-Funktionen. Hier ist PHP > 5.0.0 notwendig!</li>
  <li>MySQLi: MySQLi-Treiberschicht. Setzt auf die mysqli_*-Funktionen auf</li>
</ul>

<h4 id="Chapter-4-1-MySQL-Treiberschicht"><a href="#Chapter-4-1-MySQL-Treiberschicht">4.1. MySQL-Treiberschicht</a></h4>
<p>
   Um eine Instanz des MySQL-Treibers erstellen zu k&ouml;nnen, ist folgende Konfiguration notwendig:
</p>
<gen:highlight type="ini">
[MySQL]
DB.Host = "host"
DB.User = "user"
DB.Pass = "pass"
DB.Name = "name"
DB.Type = "MySQLx"
[DB.DebugMode = "true|false"]
[DB.Charset = ""]
[DB.Collation = ""]
</gen:highlight>
Die Parameter <strong>DB.Charset</strong> und <strong>DB.Collation</strong> dienen dazu, den
<em>Zeichensatz</em> und die <em>Zeichenbehandlung</em> der MySQL-Verbindung zu definieren. Mit dem
Parameter <strong>DB.Charset</strong> werden die MySQL-Variablen
<ul>
   <li>character_set_client</li>
   <li>character_set_connection</li>
   <li>character_set_results</li>
</ul>
gesetzt, <strong>DB.Collation</strong> beeinflusst
<ul>
   <li>collation_connection</li>
   <li>collation_database</li>
</ul>
Die beiden Parameter sind optional und k&ouml;nnen bei Bedarf auch wechselseitig gesetzt werden, das
Vorhandensein beider ist nicht erforderlich.
<div class="hint">
   Details zu den verf&uuml;gbaren Werten f&uuml;r die Konfiguration findet sich in der
   MySQL-Dokumentation im Kapitel
   <a class="external" href="http://dev.mysql.com/doc/refman/5.0/en/charset-connection.html" title="Connection Character Sets and Collations (MySQL 5.0)">Connection Character Sets and Collations (MySQL 5.0)</a>.
</div>
Anschlie&szlig;end kann die Treiber-Instanz mit den Code-Zeilen
<gen:highlight type="php">
$cM = &$this->getServiceObject('core::database','ConnectionManager');
$MySQL = &$cM->getConnection('MySQL');
</gen:highlight>
<p>
   erzeugt werden. Die Treiberschicht wird aus Performance-Gr&uuml;nden dabei immer als
   Singleton-Objekt erstellt.
</p>

<h4 id="Chapter-4-2-SQLite-Treiberschicht"><a href="#Chapter-4-2-SQLite-Treiberschicht">4.2. SQLite-Treiberschicht</a></h4>
<p>Eine SQLite Treiberschicht kann mit dem Konfigurationseintrag</p>
<gen:highlight type="ini">
[SQLite]
DB.Name = "/path/to/my/database.sqlite"
DB.Type = "SQLite"
DB.DebugMode = "true|false"
</gen:highlight>
und den Code-Zeilen
<gen:highlight type="php">
$cM = &$this->getServiceObject('core::database','ConnectionManager');
$SQLite = &$cM->getConnection('SQLite');
</gen:highlight>
<p>
   instanziiert werden. Bitte beachten Sie, dass im Fall von SQLite Host, User und Passwort nicht
   konfiguriert werden m&uuml;ssen, da SQLite eine integrierte Datenbank-Engine ist.
</p>

<h4 id="Chapter-4-3-MySQLi-Treiberschicht"><a href="#Chapter-4-3-MySQLi-Treiberschicht">4.3. MySQLi-Treiberschicht</a></h4>
<p>
   Der <em>MySQLi</em>-Treiber ist weitestgehend identisch mit der Implementierung des
   <em>MySQLx</em>-Treibers. Er unterst&uuml;tzt das Ausf&uuml;hren von dynamisch zusammengesetzten
   Statements und Statements, die in SQL-Dateien abgelegt sind.
</p>
<p>
   Um eine Instanz des MySQLi-Treibers erstellen zu k&ouml;nnen, ist folgende Konfiguration notwendig:
</p>
<gen:highlight type="ini">
[MySQLi]
DB.Host = "host"
DB.User = "user"
DB.Pass = "pass"
DB.Name = "name"
DB.Type = "MySQLi"
[DB.DebugMode = "true|false"]
[DB.Charset = ""]
[DB.Collation = ""]
</gen:highlight>
<p>
   F&uuml;r die Konfiguration des Zeichensatz und der Collation gelten die selben Bedingungen wie
   f&uuml;r eine <a href="#Chapter-4-1-MySQL-Treiberschicht">MySQLx</a>-Connection.
</p>
<p>
   &Uuml;ber die Funktion des <em>MySQLx</em>-Treibers hinaus implementiert er Methoden, die es
   erlauben, Statements mit Bind-Parametern gegen die Datenbank auszuf&uuml;hren. Diese sind:
</p>
<ul>
   <li>executeTextBindStatement()</li>
   <li>executeBindStatement()</li>
</ul>
<p>
   Mit <em>executeTextBindStatement()</em> kann ein Statement, das - analog zu <em>executeTextStatement()</em>
   - als String &uuml;bergeben wurde gegen die Datenbank ausgef&uuml;hrt werden. Als zweiten Parameter
   erwartet es die Werte der Bind-Parameter.
</p>
<p>
   Die Methode <em>executeBindStatement()</em> f&uuml;hrt ein Statement aus, das in einer SQL-Datei
   abgelegt wurde und reichert dieses mit den im Aufruf &uuml;bergebenen Parametern an. Da die
   Implementierung der Bind-Parameter f&uuml;r MySQL-Datenbanken eine genaue Beachtung der Reihenfolge
   der Bind-Parameter voraussetzt, wurde in der Implementierung eine automatische Re-Sortierung
   eingef&uuml;hrt, die daf&uuml;r sort, dass die Zuordnung der Parameter des Methoden-Aufrufs zur
   Definition der Parameter in der SQL-Datei passt.
</p>
<p>
   F&uuml;r die Nutzung der Methode <em>executeTextBindStatement()</em> steht die Funktion
   <em>fetchBindResult()</em> zur Verf&uuml;gung. Diese holt analog zu <em>fetchData()</em> die
   gew&uuml;nschte Ergebnismenge ab.
</p>
<p>
   Die folgende Code-Box zweigt Anwendungsbeispiele f&uuml;r den Umgang mit Bind-Statements:
</p>
<gen:highlight type="php">
// retrieve db connection
$cm = &$this->getServiceObject('core::database','ConnectionManager');
$conn = $cm->getConnection('MySQLi');

// execute textual statement with bind params
$data = $conn->executeTextBindStatement(
   'SELECT * FROM ent_user_2 WHERE FirstName LIKE ?',
   array('Christian')
);

// execute statement within an sql file with bind params
$data = $conn->executeBindStatement(
   'my::module',
   'notepad_entries.sql',
   array('date_from' => '2009-03-20 00:00:00','date_until' => '2010-04-10 00:00:00')
);
</gen:highlight>
<p>
   Die Ausf&uuml;hrung der letzten Methode setzt voraus, dass eine SQL-Datei unter
</p>
<gen:highlight type="code">/apps/config/my/module/{CONTEXT}/{ENVIRONMENT}_notepad_entries.sql</gen:highlight>
<p>
   die &uuml;bergebenen Parameter in der Form
</p>
<gen:highlight type="sql">
SELECT *
FROM notepad
WHERE
   save_date BETWEEN [date_from] AND [date_until]
</gen:highlight>
<p>
   enth&auml;lt.
</p>

<core:importdesign namespace="modules::comments::pres::templates" template="comment" categorykey="de_031" />