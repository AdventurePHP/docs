<doku:title parent="119" tags="exception,behandlung,exceptionbehandlung,registry,core,exceptionhandler" title="Exceptionbehandlung" urlname="Exceptionbehandlung">
  Das Kapitel Exceptionbehandlung beschreibt das im Framework enthaltene Exceptionbehandlung-Konzept und
  zeigt die Verwendung sowie die Erweiterung auf.
</doku:title>
<div class="hint">
   Bitte beachten Sie, dass die hier beschriebene Dokumentation bis einschließlich Release 1.14 gilt. Die Dokumentation
   für Releases nach 1.14 finden Sie unter <int:link pageid="145"/>.
</div>

<h3 id="Chapter-1-Einleitung"><a href="#Chapter-1-Einleitung">1. Einleitung</a></h3>
<p>
   Zur globalen Exceptionbehandlung nutzt das Framework die Funktion <strong>exceptionHandler</strong>.
   Diese hat die Aufgabe, alle nicht abgefangenen Exceptions an zentraler Stelle zu behandeln. Zu diesem
   Zweck nutzt die Funktion eine <strong>ExceptionHandler</strong>-Komponente, die über die Registry
   konfigurierbar ist. Letztere ist dann für die eigentliche Behandlung einer Exception verantwortlich.
   Der Mechanismus ähnelt der im Framework integrierten
   <a href="./?Seite=101-Fehlerbehandlung" title="Fehlerbehandlung">Fehlerbehandlung</a>.
</p>
<p>
   Die im APF vorkonfigurierte Exceptionbehandlung beinhaltet dabei die Speicherung der Meldung in einer
   Log-Datei und die Ausgabe der nicht abgefangenen Exception inklusive des Stacktraces. Details
   können der <a href="./?Seite=002-API-Dokumentation" title="API-Dokumentation">API-Dokumentation</a>
   der Klasse <strong>DefaultExceptionHandler</strong> entnommen werden.
</p>

<h3 id="Chapter-2-Konfiguration"><a href="#Chapter-2-Konfiguration">2. Konfiguration</a></h3>
<p>
   Um den vorkonfigurierten <strong>DefaultExceptionHandler</strong> durch einen eigenen zu ersetzen
   muss der Registry-Offset <strong>ExceptionHandler</strong> im Namespace <strong>apf::core</strong>
   mit der gewünschten <strong>ExceptionHandlerDefinition</strong> ersetzt werden. Die Konfiguration
   einer eigenen Exceptionbehandlungsroutine muss dabei in der Bootstrap-Datei nach dem Einbinden der
   <em>pagecontroller.php</em> erfolgen.
</p>
<p>Die Definition einer eigenen Exception-Behandlungskomponente gestaltet sich wie folgt:</p>
<gen:highlight type="php">
Registry::register(
   'apf::core',
   'ExceptionHandler',
   new ExceptionHandlerDefinition(
      'my::exceptionhandler::namespace',
      'MyExceptionHandler'
   )
);
</gen:highlight>
<p>
   Wie aus dem Code-Beispiel zu erkennen ist, wird ein <em>ExceptionHandler</em> durch seinen Namespace
   und seinen Klassennamen referenziert.
</p>
<div class="hint">
   Enthält der Registry-Offset keine gültige Definition, werden auftretende Exceptions in
   Text-Form ausgegeben. Der Fallback-Modus ist daran zu erkennen, dass die Meldung mit
   <gen:highlight type="apf-xml">
   APF catchable exception:
   </gen:highlight>
   beginnt. In diesem Fall muss die Definition oder die Implementierung der ExceptionHandler-Klasse
   überprüft werden.
</div>

<div class="hint">
   Um den <em>ExceptionHandler</em> zu deaktivieren kann der Registry-Eintrag mit
   <strong>null</strong> initialisiert werden.
   <br />
   <br />
</div>

<h3 id="Chapter-3-Erweiterung"><a href="#Chapter-3-Erweiterung">3. Erweiterung</a></h3>
<p>
   Um eine eigene Exceptionbehandlung einzuführen, muss die Klasse <strong>AbstractExceptionHandler</strong>
   implementiert werden. Diese definiert folgendes Interface:
</p>
<gen:highlight type="php">
abstract class AbstractExceptionHandler extends APFObject {

   public function handleException($exception){
   }

}
</gen:highlight>
<p>
   Bei Auftreten einer Exception wird der Methode <strong>handleException</strong> das Exception-Objekt
   übergeben. Da die Exceptionbehandlung in einer eigenen Klasse stattfindet, die nicht mit dem
   ServiceManager erzeugt wurde, steht der Zugriff auf den aktuellen <strong>Context</strong> und die
   aktuelle <strong>Sprache</strong> <em>nicht</em> zur Verfügung!
</p>
<p>
   Sollten diese Informationen für die Behandlung der Exception notwendig sein, müssen diese
   über in einer Applikation verfügbaren Informationscontainer (z.B. Model-Klasse eines Modules)
   bezogen werden. Der Umgebungsparameter steht wie in der Dokumentation beschrieben über die
   Registry zur Verfügung.
</p>

<h3 id="Chapter-4-Anwendung"><a href="#Chapter-4-Anwendung">4. Anwendung</a></h3>
<p>
   Der globale Exception-Behandlungsmechanismus kann einfach durch folgenden PHP-Code genutzt werden:
</p>
<gen:highlight type="php">
throw new Exception('My application exception');
</gen:highlight>
<p>
   Vorraussetzung dabei ist, dass die durch den Code geworfene Exception nicht durch ein
   <em>try-catch</em>-Konstrukt abgefangen wird!
</p>
<p>
   Details können der Online-Dokumentation unter
   <doku:link>http://php.net/exception</doku:link> und <doku:link>http://php.net/exceptions</doku:link>
   entnommen werden.
</p>

<h3 id="Chapter-5-Live-ExceptionHandler"><a href="#Chapter-5-Live-ExceptionHandler">5. Live ExceptionHandler</a></h3>
<p>
   Analog zum <int:link pageid="101" anchor="Chapter-5-1-ProductionErrorHandler">ProductionErrorHandler</int:link>
   wird seit dem Release 1.13 auch ein ExceptionHandler für den Live-Betrieb ausgeliefert.
</p>
<p>
   Nach dem Einbinden der <em>pagecontroller.php</em> kann der <em>ProductionExceptionHandler</em>
   wir folgt konfiguriert werden:
</p>
<gen:highlight type="php">
Registry::register(
   'apf::core',
   'ExceptionHandler',
   new ExceptionHandlerDefinition(
      'core::exceptionhandler',
      'ProductionExceptionHandler'
   )
);
Registry::register(
   'apf::core::exceptionhandler',
   'ProductionExceptionRedirectUrl',
   '/pages/global-error'
);
</gen:highlight>
<p>
   Wird die Registry-Direktive <em>ProductionExceptionRedirectUrl</em> nicht gesetzt, leitet der ExceptionHandler nach
   &quot;/&quot; weiter.
</p>

<core:importdesign namespace="modules::comments::pres::templates" template="comment" categorykey="de_102" />