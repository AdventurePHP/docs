<doku:title parent="119" tags="dokumentation,klassen referenz,klassen,referenz,mysqlhandler" title="MySQLHandler" urlname="MySQLHandler">
  Der MySQLHandler dient zur Abstraktion einer MySQL-Datenbank gegen die Anwendung. Er nimmt dem
  Entwickler die Sorge um Datenbank-Spezifika wie Konfiguration, Verbindungsaufbau und
  standardisiertes Ausf&uuml;hren von Statements ab.
</doku:title>
<div class="warn">
   Diese Komponente ist veraltet. Ab dem Release 1.10 sollte nur noch der 
   <int:link pageid="031" anchor="Chapter-4-1-MySQL-Treiberschicht" /> eingesetzt werden. Die
   Dokumentation der Features gilt jedoch auch f&uuml;r den MySQLx-Treiber.
</div>
Der <strong>MySQLHandler</strong> dient zur Abstraktion einer MySQL-Datenbank gegen die Anwendung.
Er nimmt dem Entwickler die Sorge um Datenbank-Spezifika wie Konfiguration, Verbindungsaufbau und
standardisiertes Ausf&uuml;hren von Statements ab. F&uuml;r letzteres stehen dabei zwei Methoden zur
Verf&uuml;gung: Einerseits kann per <strong>executeTextStatement()</strong> jedes beliebige
SQL-Statement ausgef&uuml;hrt werden, m&ouml;chte der Entwickler die Statements in seiner Anwendung
mehrfach und an unterschiedlichen Stellen verwenden, so k&ouml;nnen Statements ebenso in externe
Statement-Dateien ausgelagert und per <strong>executeStatement()</strong> ausgef&uuml;hrt werden.
Die hier relevanten Parameter k&ouml;nnen in der
<a href="./?Seite=002-API-Dokumentation" title="API-Dokumentation">API-Dokumentation</a> nachgelesen werden.
<br />
<br />
<br />
<h3 id="Chapter-1-Allgemeine-Verwendung"><a href="#Chapter-1-Allgemeine-Verwendung">1. Allgemeine Verwendung</a></h3>
Um den <strong>MySQLHandler</strong> nutzen zu k&ouml;nnen muss dieser zuerst per
<gen:highlight type="php">
import('core::database','MySQLHandler');
</gen:highlight>
in die Applikation eingebunden werden. Anschlie&szlig;end kann mit dem Code-Fragment
<gen:highlight type="php">
$SQL = &$this->__getServiceObject('core::database','MySQLHandler');
</gen:highlight>
eine Referenz auf den Service erzeugt werden. Da hier die private Methode <em>__getServiceObject()</em>
Verwendung findet ist sichergestellt, dass der angefragte Service nur einmal innerhalb der Anwendung
erzeugt wird. Dies hat nicht nur einen verwaltungstechnischen, sondern im Fall des Datenbankzugriffs
vor allem performancetechnische Vorteile. Intern m&uuml;ssen beispielsweise Datenbank-Verbindungen
nur einmal hergestellt und Konfigurationen nur einmal gelesen werden.
<br />
<br />
Zur Konfiguration der Komponente muss die Konfigurationsdatei
<gen:highlight type="code">
/apps/config/core/database/{CONTEXT}/{ENVIRONMENT}_connections.ini
</gen:highlight>
vorhanden sein. <strong>{CONTEXT}</strong> ist dabei der Context der aktuellen Applikation,
<strong>{ENVIRONMENT}</strong> der Wert der Umgebungsvariable aus der Registry. Details hierzu
k&ouml;nnen im Kapitel <int:link pageid="134" /> nachgelesen werden.
Diese konfiguriert den zu benutzenden Server, Benutzerdaten und die Datenbank. Eine
typische Konfigurationsdatei hat folgenden Inhalt:
<gen:highlight type="ini">
[MySQL]
DB.Host = ""
DB.User = ""
DB.Pass = ""
DB.Name = ""
DB.DebugMode = "true|false"
DB.Charset = ""
DB.Collation = ""
</gen:highlight>
Falls der Parameter <strong>DB.DebugMode</strong> auf den Wert <strong>true</strong> eingestellt ist,
legt der MySQLHandler ein Logfile an und notiert Fehler, die w&auml;hrend der Benutzung auftreten.
<br />
<br />
Die Parameter <strong>DB.Charset</strong> und <strong>DB.Collation</strong> dienen dazu, den
<em>Zeichensatz</em> und die <em>Zeichenbehandlung</em> der MySQL-Verbindung zu definieren. Mit dem
Parameter <strong>DB.Charset</strong> werden die MySQL-Variablen
<ul>
   <li>character_set_client</li>
   <li>character_set_connection</li>
   <li>character_set_results</li>
</ul>
gesetzt, <strong>DB.Collation</strong> beeinflusst
<ul>
   <li>collation_connection</li>
   <li>collation_database</li>
</ul>
Die beiden Parameter sind optional und k&ouml;nnen bei Bedarf auch wechselseitig gesetzt werden, das
Vorhandensein beider ist nicht erforderlich.
<br />
<br />
Um nun Daten aus einer Datenbank zu lesen k&ouml;nnen folgende Zeilen in die Applikation eingebaut
werden:
<gen:highlight type="php">
$select = 'SELECT somefield, anotherfield
           FROM mytable
           WHERE somefield = \'somevalue\';';
$result = $SQL->executeTextStatement($select);
</gen:highlight>
Die mit dem Select angefragten Daten k&ouml;nnen anschlie&szlig;end mit einer while-Schleife abgeholt
werden:
<br />
<gen:highlight type="php">
while($data = $SQL->fetchData($result)){
   // ... //
}
</gen:highlight>
<br />
<h3 id="Chapter-2-Statement-Auslagerung"><a href="#Chapter-2-Statement-Auslagerung">2. Statement-Auslagerung</a></h3>
Soll das gezeigte Statement ausgelagert werden, um von einer weiteren Applikation oder der selben an
anderer Stelle verwendet zu werden, so kann die Methode <strong>executeStatement()</strong>
daf&uuml;r herangezogen werden. Dazu muss das Select in einer Datei mit dem Namen
<gen:highlight type="code">
{ENVIRONMENT}_{StatementDateiName}.sql
</gen:highlight>
abgelegt werden. Der MySQLHandler sucht diese Datei dann im Ordner
<gen:highlight type="code">
{Namespace}/{CONTEXT}
</gen:highlight>
&auml;hnlich zur Benennung der &uuml;blichen Konfigurationsdateien. Unter der Annahme, dass das
Statement einem Modul unter dem Namespace <em>modules::testmodule</em> "geh&ouml;rt", die
Umgebungsvariable nicht angepasst wurde und der Context der Applikation "sites::demosite" lautet
muss die Datei den Namen
<gen:highlight type="code">
DEFAULT_mystatement.sql
</gen:highlight>
tragen und im Ordner
<gen:highlight type="code">
/apps/config/modules/testmodule/sites/demosite
</gen:highlight>
abgelegt sein. Um das Statement auszuf&uuml;hren muss die Methode <strong>executeStatement()</strong>
wie folgt verwendet werden:
<gen:highlight type="php">
   $params = array(
                   'somefield' => 'somevalue'
                   );
   $result = $SQL->executeStatement('modules::testmodule','mystatement',$params);
</gen:highlight>
Der dritte Parameter der Methode <em>executeStatement()</em> dient dazu Platzhalter im Statement
zu f&uuml;llen. Platzhalter werden mit "[" einem Namen und "]" gekennzeichnet. Der in den Klammern
stehende Name ist gleichzeitig der Name des Platzhalters, der im Parameter-Array verwendet wird.
F&uuml;hrt man das obige Beispiel weiter, so hat die Datei <strong>DEFAULT_mystatement.sql</strong>
folgende Gestalt:
<gen:highlight type="sql">
SELECT somefield, anotherfield
FROM mytable
WHERE somefield = '[somefield]';
</gen:highlight>
Ein Anwendungsbeispiel findet sich im
<a href="./?Seite=032-Kommentarfunktion" title="Kontaktformular-Tutorial">Kontaktformular-Tutorial</a> unter
Kapitel 4.3.
<br />
<br />
<br />
<h3 id="Chapter-3-Debugging"><a href="#Chapter-3-Debugging">3. Debugging</a></h3>
Oft ist es notwendig, die gegen die Datenbank abgesetzten Statements zu monitoren. Hierzu bietet der
<strong>MySQLHandler</strong> in den Methoden <strong>executeTextStatement()</strong> und
<strong>executeStatement()</strong> jeweils einen optionalen Parameter, der es erm&ouml;glicht,
Statement-Logging zu aktivieren. Details hierzu k&ouml;nnen der
<a href="./?Seite=002-API-Dokumentation" title="API-Dokumentation">API-Dokumentation</a> entnommen
werden. 
<br />
<br />
<br />
<h3 id="Chapter-4-Weitere-Features"><a href="#Chapter-4-Weitere-Features">4. Weitere Features</a></h3>
Der MySQLHandler besitzt weitere Tools zur Unterst&uuml;tzung der Implementierung. Bei Inserts wird
die LAST_INSERT_ID automatisch eingelesen und vorgehalten. Diese kann nach dem Ausf&uuml;hren eines
Inserts per <strong>getLastID()</strong> ausgelesen werden.
<br />
<br />
Dar&uuml;ber hinaus bietet der MySQLHandler Methoden wie <strong>getNumRows()</strong> und
<strong>getAffectedRows()</strong> um die Ergebnis-Menge eines Selects oder Updates abfragen zu
k&ouml;nnen und <strong>fetchData()</strong> um Daten von der MySQL abholen zu k&ouml;nnen.