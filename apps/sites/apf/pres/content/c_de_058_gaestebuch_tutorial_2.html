<doku:title parent="072" tags="tutorial,gaestebuch,taglibs,wiederverwendbarkeit,mehrsprachigkeit,frontcontroller" title="Gästebuch-Tutorial (2)" urlname="Gaestebuch-Tutorial-2">
  Das Gästebuch-Tutorial ist eine umfassendes Dokumentation über die moderne
  Software-Architektur. Es behandelt den Entwicklungsprozess von der Erstellung der Anforderungen,
  über die Modellierung bis hin zur Implementierung einer fertigen Anwendung. Das Modul liegt
  dem Frameworkrelease im Ordner modules/guestbook bei.
</doku:title>
Die folgenden Kapiteln beschreiben die Implementierungsdatails des Gästebuchs.
<br />
<br />
<br />
<h3 id="Chapter-6-Implementierung-Datenschicht"><a href="#Chapter-6-Implementierung-Datenschicht">6. Implementierung der Datenschicht</a></h3>
Die Hauptaufgabe des <em>GuestbookMapper</em>'s ist es, Daten zwischen Datenhaltung und Anwendung zu
übersetzen. Im Fall des Lesens muss ein Resultset in ein Domänen-Objekt übersetzt werden,
im Fall des Schreibens muss ein Domänen-Objekt in seine Bestandteile zerlegt und in den zugehörigen
Tabellen gespeichert werden. Dazu werden - wie im Design beschrieben - jeweils eine Mapping-Methode
für jedes Objekt der Anwendung erstellt. Das Schreiben übernehmen die <em>save*()</em>-Methoden.
Hier zunächst der Quellcode des Gästebuchs:
<br />
<br />
<strong>GuestbookMapper.php:</strong>
<gen:highlight type="php">
import('modules::guestbook::biz','Guestbook');
import('modules::guestbook::biz','Entry');
import('modules::guestbook::biz','Comment');
import('core::database','MySQLHandler');

class GuestbookMapper extends APFObject {

   public function loadEntryByID($EntryID){

      // Instanz des MySQLHandlers holen
      $SQL = &$this->getServiceObject('core::database','MySQLHandler');

      // Daten lesen und zurückgeben
      $T = &Singleton::getInstance('BenchmarkTimer');
      $T->start('loadEntryByID('.$EntryID.')');
      $select = 'SELECT * FROM entry WHERE EntryID = \''.$EntryID.'\';';
      $result = $SQL->executeTextStatement($select);

      $T->start('__mapEntry2DomainObject('.$EntryID.')');
      $Entry = $this->__mapEntry2DomainObject($SQL->fetchData($result));
      $T->stop('__mapEntry2DomainObject('.$EntryID.')');

      $T->stop('loadEntryByID('.$EntryID.')');

      return $Entry;

   }

   public function loadCommentByID($CommentID){

      // Instanz des MySQLHandlers holen
      $SQL = &$this->getServiceObject('core::database','MySQLHandler');

      // Daten lesen und zurückgeben
      $select = 'SELECT * FROM comment WHERE CommentID = \''.$CommentID.'\';';
      $result = $SQL->executeTextStatement($select);
      return $this->__mapComment2DomainObject($SQL->fetchData($result));

   }

   public function loadGuestbookByID($GuestbookID){

      // Instanz des MySQLHandlers holen
      $SQL = &$this->getServiceObject('core::database','MySQLHandler');

      // Daten lesen und zurückgeben
      $select = 'SELECT * FROM guestbook WHERE GuestbookID = \''.$GuestbookID.'\';';
      $result = $SQL->executeTextStatement($select);
      return $this->__mapGuestbook2DomainObject($SQL->fetchData($result));

   }

   public function loadEntryWithComments($EntyID){

      // Instanz des MySQLHandlers holen
      $SQL = &$this->getServiceObject('core::database','MySQLHandler');

      // Eintrag laden
      $Entry = $this->loadEntryByID($EntyID);

      // Kommentare hinzuladen
      $select = 'SELECT comment.CommentID AS ID FROM comment
                 INNER JOIN comp_entry_comment ON comment.CommentID = comp_entry_comment.CommentID
                 INNER JOIN entry ON comp_entry_comment.EntryID = entry.EntryID
                 WHERE entry.EntryID = \''.$Entry->get('ID').'\';';
      $result = $SQL->executeTextStatement($select);

      while($data = $SQL->fetchData($result)){
         $Comment = $this->loadCommentByID($data['ID']);
         $Entry->addComment($Comment);
         $Comment = null;
      }

      return $Entry;

   }

   public function loadGuestbookWithEntries($GuestbookID){

      // Instanz des MySQLHandlers holen
      $SQL = &$this->getServiceObject('core::database','MySQLHandler');

      // Gästebuch laden
      $Guestbook = $this->loadGuestbookByID($GuestbookID);

      // Kommentare hinzuladen
      $select = 'SELECT entry.EntryID AS ID FROM entry
                 INNER JOIN comp_guestbook_entry ON entry.EntryID = comp_guestbook_entry.EntryID
                 INNER JOIN guestbook ON comp_guestbook_entry.GuestbookID = guestbook.GuestbookID
                 WHERE guestbook.GuestbookID = \''.$Guestbook->get('ID').'\';';
      $result = $SQL->executeTextStatement($select);

      while($data = $SQL->fetchData($result)){
         $Entry = $this->loadEntryWithComments($data['ID']);
         $Guestbook->addEntry($Entry);
         $Entry = null;
      }

      return $Guestbook;

   }

   ...

}
</gen:highlight>
<div class="hint">
  Der hier abgedruckte Quellcode enthält keine Sicherungen für SQL-Injections. Diese
  sollten zur eigenen Sicherheit in echten Applikationen enthalten sein. Hierzu bietet die Klasse
  <em>MySQLxHandler</em> die Methode <em>escapeValue()</em>. Diese maskiert Steuerzeichen und
  verhindert so in Verbindung mit den <int:link pageid="137">Input-Filtern</int:link> eine
  mögliche Sicherheitslücke. Mehr zum Thema Sicherheit und den im Framework eingebauten
  Maßnahmen findet sich unter <a href="./?Seite=075-Security" title="Security">Security</a>.
</div>
<br />
<br />
<h4 id="Chapter-6-1-Lese-Mapper-Methoden"><a href="#Chapter-6-1-Lese-Mapper-Methoden">6.1. Lese-Mapper-Methoden</a></h4>
Um der Business-Schicht Objekte zur Verfügung stellen zu können muss ein Ergebnis einer
Datenbank-Abfrage in die Business-Objekte gemappt werden. Dazu wurden die Funktionen <strong>_mapEntry2DomainObject()</strong>,
<strong>__mapGuestbook2DomainObject</strong> und <strong>__mapComment2DomainObject</strong> vorgesehen.
Diese wiederum werden von den <em>load*ByID()</em>- und <em>load*WithEntries()</em>-Methoden verwendet.
Jede dieser Methoden stellt der Business-Schicht einen Service zur Verfügung, mit dem Daten aus
der Datenquelle geladen werden können. Zur Kommunikation mit der Datenbank kommt der <strong>MySQLHandler</strong>
zur Verfügung. Dieses Service-Objekt kennt die Methoden <em>executeTextStatement()</em> um ein SQL-
Statement auszuführen und <em>fetchData()</em> um Daten abzuholen. Der MySQLHandler stellt eine
Abstraktionsschicht für den Datenzugriff dar.
<br />
<br />
<br />
<h4 id="Chapter-6-2-Schreibe-Mapper-Methoden"><a href="#Chapter-6-2-Schreibe-Mapper-Methoden">6.2. Schreibe-Mapper-Methoden</a></h4>
Da das Gästebuch keine rein lesenden Anwendung ist, muss die Anwendung Daten auch wieder persistieren
können. Um sicherzustellen, dass sich die Anwendung nicht um die Spezifika der Datenschicht kümmern
muss werden <em>save*()</em>-Methoden angeboten. Mit diesen kann durch Übergabe eines Objekts oder
auch eines Objekt-Baums die Objekte oder Bäume transparent für die Anwendung gespeichert werden.
Beim Erstellen eines Gästebuch-Eintrags beispielsweise muss lediglich das zugehörige
Gästebuch der Methode <em>saveGuestbook()</em> übergeben werden und die Datenschicht kümmert
sich um die Speicherung des Gästebuchs, bzw. der Einträge. Innerhalb dieser Funktion wird
dann überprüft, ob das übergebene Gästebuch bereits existiert. Wenn nein, wird es
gespeichert, wenn ja nur upgedatet. Ebenso werden nur neue Einträge mit Hilfe der Funktion
<em>saveEntry()</em> gespeichert. Damit die Zuordnung eines Eintrags zu deinem Gästebuch konsistent
bleibt, kümmerst sich jede dieser Methoden darum, dass die Beziehungsinformationen richtig
gespeichert werden.
<br />
<br />
<br />
<br />
<h3 id="Chapter-7-Businessschicht"><a href="#Chapter-7-Businessschicht">7. Implementierung der Business-Schicht</a></h3>
In den Implementierungen des Frameworks werden die Business- und Datenschicht-Komponenten in der
Regel als Service-Objekte verwendet. Um diese in einer Methode verwenden zu können ist in
jeder Klasse, die direkt oder indirekt von APFObject erbt die Methode <em>getServiceObject()</em>
oder <em>getAndInitServiceObject()</em>. Die beiden Funktionen liefern dabei jeweils eine Referenz
auf die Instanz des spezifizierten Service-Objekts zurück. Um als Service-Objekt aufgerufen und
erzeugt zu werden muss diese Klasse direkt oder indirekt von <em>APFObject</em> erben und falls ein
Service mit <em>getAndInitServiceObject()</em> erstellt wird die Methode <em>init()</em> implementieren.
Letzter dient dazu einen Service zu initialisieren. Dazu besitzt <em>getAndInitServiceObject()</em>
einen dritten Parameter, der als Initialisierungs-Parameter an die Methode <em>init()</em> weitergegeben
wird. Wird jedes Service-Layer mit den genannten Funktionen erstellt, so ist sichergestellt, dass die
Layer die für die Anwendung wichtigen Attribute wie <strong>Context</strong> und <strong>Language</strong>
kennen. Dies ist insbesondere für das Auslesen von Konfigurations-Dateien wichtig.
<br />
<br />
<strong>GuestbookManager.php:</strong>
<gen:highlight type="php">
import('modules::guestbook::biz','Guestbook');
import('modules::guestbook::biz','Entry');
import('modules::guestbook::biz','Comment');
import('modules::guestbook::data','GuestbookMapper');
import('modules::pager::biz','PagerManagerFabric');
import('core::session','SessionManager');

class GuestbookManager extends APFObject {

   private  $__GuestbookID;
   private $__Guestbook = null;
   private $__sessMgr = null;

   public function init($GuestbookID){

      // GuestbookID speichern
      $this->__GuestbookID = $GuestbookID;

      // SessionManager initialisieren
      $this->__sessMgr = new SessionManager('Guestbook');

   }

   public function loadGuestbook(){

      // Falls Gästebuch noch nicht geladen wurde...
      if($this->__Guestbook == null){

         // pagerManager holen
         $pMF = &$this->getServiceObject('modules::pager::biz','PagerManagerFabric');
         $pM = &$pMF->getPagerManager('Guestbook');

         // GuestbookMapper holen
         $gM = &$this->getServiceObject('modules::guestbook::data','GuestbookMapper');

         // Gästebuch laden
         $this->__Guestbook = $gM->loadGuestbookByID($this->__GuestbookID);

         // Eintrag-IDs, die angezeigt werden sollen laden
         $EntryIDs = $pM->loadEntries(array('GuestbookID' => $this->__GuestbookID));

         // Einträge laden
         $Entries = array();

         for($i = 0; $i < count($EntryIDs); $i++){
            $Entries[] = $gM->loadEntryWithComments($EntryIDs[$i]);
         }


         // Einträge zum Gästebuch hinzufügen
         $this->__Guestbook->setEntries($Entries);

      }

      return $this->__Guestbook;
   }

   public function loadGuestbookObject(){

      // GuestbookMapper holen
      $gM = &$this->getServiceObject('modules::guestbook::data','GuestbookMapper');

      // Gästebuch-Objekt laden
      return $gM->loadGuestbookByID($this->__GuestbookID);

   }

   public function getURLParameters(){

      // pagerManager holen
      $pMF = &$this->getServiceObject('modules::pager::biz','PagerManagerFabric');
      $pM = &$pMF->getPagerManager('Guestbook');

      // Pager-Ausgabe hinzufügen
      return $pM->getPagerURLParameters();

   }

   public function getPager(){

      // pagerManager holen
      $pMF = &$this->getServiceObject('modules::pager::biz','PagerManagerFabric');
      $pM = &$pMF->getPagerManager('Guestbook');

      // Pager-Ausgabe hinzufügen
      return $pM->getPager(array('GuestbookID' => $this->__GuestbookID));

   }

   public function saveEntry($Entry){

      // GuestbookMapper holen
      $gM = &$this->getServiceObject('modules::guestbook::data','GuestbookMapper');

      // Gästebuch laden
      $Guestbook = $gM->loadGuestbookByID($this->__GuestbookID);

      // Eintrag hinzufügen
      $Guestbook->addEntry($Entry);

      // Gästebuch speichern
      $gM->saveGuestbook($Guestbook);

      // pagerManager holen
      $pMF = &$this->getServiceObject('modules::pager::biz','PagerManagerFabric');
      $pM = &$pMF->getPagerManager('Guestbook');

      // Auf Anzeige-Seite weiterleiten
      $URLParams = $pM->getPagerURLParameters();
      $Link = LinkHandler::generateLink($_SERVER['REQUEST_URI'],array($URLParams['PageName'] => '', $URLParams['CountName'] => '', 'gbview' => 'display'));
      header('Location: '.$Link);

   }

   public function saveComment($EntryID,$Comment){

      // GuestbookMapper holen
      $gM = &$this->getServiceObject('modules::guestbook::data','GuestbookMapper');

      // Gästebuch laden
      $Guestbook = $gM->loadGuestbookByID($this->__GuestbookID);

      // Entry laden
      $Entry = $gM->loadEntryByID($EntryID);

      // Comment zum Entry hinzufügen
      $Entry->addComment($Comment);

      // Eintrag hinzufügen
      $Guestbook->addEntry($Entry);

      // Gästebuch speichern
      $gM->saveGuestbook($Guestbook);

      // pagerManager holen
      $pMF = &$this->getServiceObject('modules::pager::biz','PagerManagerFabric');
      $pM = &$pMF->getPagerManager('Guestbook');

      // Auf Anzeige-Seite weiterleiten
      $URLParams = $pM->getPagerURLParameters();
      $Link = LinkHandler::generateLink($_SERVER['REQUEST_URI'],array($URLParams['PageName'] => '', $URLParams['CountName'] => '', 'gbview' => 'display','commentid' => '', 'entryid' => ''));
      header('Location: '.$Link);

   }

   public function loadEntry($EntryID){

      // GuestbookMapper holen
      $gM = &$this->getServiceObject('modules::guestbook::data','GuestbookMapper');

      // Eintrag ausgeben
      return $gM->loadEntryByID($EntryID);

   }

   public function loadComment($CommentID){

      // GuestbookMapper holen
      $gM = &$this->getServiceObject('modules::guestbook::data','GuestbookMapper');

      // Eintrag ausgeben
      return $gM->loadCommentByID($CommentID);

   }

   pubic function validateCrendentials($Username,$Password){

      // Gästebuch-Objekt laden
      $Guestbook = $this->loadGuestbookObject();

      // Zugangsdaten validieren
      if($Guestbook->get('Admin_Username') == $Username && $Guestbook->get('Admin_Password') == $Password){
         return true;
      }
      else{
         return false;
      }

   }

   public function deleteEntry($Entry){

      // GuestbookMapper holen
      $gM = &$this->getServiceObject('modules::guestbook::data','GuestbookMapper');

      // Eintrag löschen
      $gM->deleteEntry($Entry);

   }

   public function deleteComment($Comment){

      // GuestbookMapper holen
      $gM = &$this->getServiceObject('modules::guestbook::data','GuestbookMapper');

      // Eintrag löschen
      $gM->deleteComment($Comment);

   }

}
</gen:highlight>
<h4 id="Chapter-7-1-Initialisierung"><a href="#Chapter-7-1-Initialisierung">7.1. Initialisierung</a></h4>
Da allein die Präsentations-Schicht über den "&lt;core:importdesign /&gt;"-Tag die
Gästebuch-ID kennt, muss die Präsentations-Schicht eine Möglichkeit haben diese dem
Business-Layer mitzuteilen. Dazu wird die bereits genannte Methode <em>getAndInitServiceObject()</em>
verwendet um die Business-Schicht zu initialisieren. Die Business-Schicht implementiert dazu die
Funktion <em>init()</em>, die einen Parameter zur Initialisierung erwartet. Beim Aufrufen der Business-
Schicht wird dann jeweils die ID des Gästebuchs mitgegeben.
<br />
<br />
<br />
<h4 id="Chapter-7-2-Laden-von-Eintraegen"><a href="#Chapter-7-2-Laden-von-Eintraegen">7.2. Laden von Einträgen</a></h4>
Um das Anzeigen von Einträgen zu erleichtern, wird die Pager-Komponente bereits in der Business-
Schicht eingesetzt. So muss sich die Präsentations-Schicht keine Gedanken zur Menge der darzustellenden
Einträge machen. Die Pager-Komponente wird hier in Form des <em>pagerManager</em>'s aus dem
Package <em>modules::pager</em> eingesetzt. Das ist eine bereits fertig implementierte Komponente, die
lediglich fü den Einsatz konfiguriert werden muss. Um mehrere Instanzen des <em>pagerManager</em>'s
innerhalb der Applikation verwenden zu können, wurde eine <em>PagerManagerFabric</em> implementiert.
Diese liefert bei Aufruf der Funktion <em>getPagerManager</em> die initialisierte Instanz eines
<em>pagerManager</em>'s zurück. Der Pager gibt bei Aufruf der Methode <em>loadEntries()</em> die
IDs der anzuzeigenden Eintäge zurück. Diese können dann mit Hilfe der Daten-Schicht geladen
und an das Gästebuch gehängt werden.
<br />
<br />
<br />
<h4 id="Chapter-7-3-Pager-Ausgabe"><a href="#Chapter-7-3-Pager-Ausgabe">7.3. Ausgabe des Pagers</a></h4>
Die unter 7.2. eingeführte Pager-Komponente bietet die Möglichkeit eine HTML-Ausgabe auszugeben.
Diese beinhaltet das Blättern in Seiten und die Wahl der Einträge pro Seite. Hierzu muss
einfach die Methode <em>getPager()</em> aufgerufen werden. Diese gibt dei HTML-Ausgabe zurück, die
in der Präsentations-Schicht in die Seite oder ein Template eingesetzt werden kann.
<br />
<br />
<br />
<h4 id="Chapter-7-4-Speichern-von-Eintraegen"><a href="#Chapter-7-4-Speichern-von-Eintraegen">7.4. Speichern von Einträgen</a></h4>
Der Präsentations-Schicht wird mit der Methode <em>saveEntry()</em> ein weiterer Service bereit
gestellt. Um diesen nutzen zu können muss die Präsentations-Schicht die Methode aufrufen und
ein Domain-Objekt <strong>Entry</strong> übergeben. Dieses wird dann gespeichert und die Funktion
leitet den Benutzer auf den <em>display</em>-View weiter.
<br />
<br />
<br />
<br />
<h3 id="Chapter-8-Praesentationsschicht"><a href="#Chapter-8-Praesentationsschicht">8. Implementierung der Präsentations-Schicht</a></h3>
Die Präsentations-Schicht besteht aus zwei Views: der Anzeige der Einträge und dem Formular.
Dies zwei Views werden durch jeweils eine Template- und eine Controller-Datei repräsentiert. Um
die Anzeige der Views zu erleichtern, wird das Gästebuch mit einem weiteren Wrapper-Template
eingebunden: <strong>guestbook.html</strong>. Diese beinhaltet die globalen Ausgaben eines Gästbuchs
und verfügt ebenfalls über einen Controller.
<br />
<br />
<br />
<h4 id="Chapter-8-1-Design-Rahmen"><a href="#Chapter-8-1-Design-Rahmen">8.1. Gästebuch Design-Rahmen</a></h4>
Die Datei <em>guestbook.html</em> beinhaltet die globalen Ausgaben eines Gästebuchs.
<gen:highlight type="apf-xml">
&lt;@controller namespace="modules::guestbook::pres::documentcontroller" class="guestbook_v1_controller" [file="guestbook_v1_controller"] @&gt;
&lt;font style="font-size: 26px; font-weight: bold;"&gt;&lt;html:placeholder name="Name" /&gt;&lt;/font&gt;
&lt;br /&gt;
&lt;br /&gt;
&lt;html:placeholder name="Description" /&gt;
&lt;br /&gt;
&lt;core:importdesign namespace="modules::guestbook::pres::templates" template="[gbview=display]" incparam="gbview" /&gt;
</gen:highlight>
Hier werden Platzhalter für die Ausgabe des Namens und der Beschreibung sowie die Einbindung der
oben genannten Views per "&lt;core:importdesign /&gt;"-Tag definiert. Der zugehörige Controller
liest zur Generierung der Darstellung das Gästebuch-Objekt aus und stellt die genannten Attribute
dar.
<gen:highlight type="php">
import('modules::guestbook::biz','GuestbookManager');

class guestbook_v1_controller extends base_controller {

   public function transformContent(){

      // guestbookid holen
      $GuestbookID = $this->__Attributes['guestbookid'];

      // Gästebuch laden
      $gM = &$this->getAndInitServiceObject('modules::guestbook::biz','GuestbookManager',$GuestbookID);
      $Guestbook = $gM->loadGuestbookObject();

      // Name und Beschreibung anzeigen
      $this->setPlaceHolder('Name',$Guestbook->get('Name'));
      $this->setPlaceHolder('Description',$Guestbook->get('Description'));

   }

}
</gen:highlight>
<h4 id="Chapter-8-2-Display-View"><a href="#Chapter-8-2-Display-View">8.2. Display-View</a></h4>
Der Display-View definiert Platzhalter für Pager, Link zum Formular und der Eintrags-Liste sowie
Templates für die Darstellung der Domain-Objekte "Entry" und "Comment".
<gen:highlight type="apf-xml">
&lt;@controller namespace="modules::guestbook::pres::documentcontroller" class="guestbook_display_v1_controller" [file="guestbook_display_v1_controller"] @&gt;
&lt;html:placeholder name="Pager" /&gt;
&lt;html:placeholder name="CreateEntry" /&gt;
&lt;br /&gt;
&lt;html:placeholder name="ControlGuestbook" /&gt;
&lt;br /&gt;
&lt;br /&gt;
&lt;br /&gt;
&lt;html:placeholder name="Content" /&gt;

&lt;html:template name="CreateEntry_de"&gt;
  &raquo; Klicken Sie
  &lt;a href="&lt;template:placeholder name="Link" /&gt;" title="Eintrag hinzufügen!"&gt;
    hier
  &lt;/a&gt;
  um einen Eintrag hinzuzufügen!
&lt;/html:template&gt;

&lt;html:template name="CreateEntry_en"&gt;
  &raquo; Please click
  &lt;a href="&lt;template:placeholder name="Link" /&gt;" title="Add new entry!"&gt;
    here
  &lt;/a&gt;
  to add a new entry!
&lt;/html:template&gt;

&lt;html:template name="ControlGuestbook_Login_de"&gt;
  &raquo; Klicken Sie
  &lt;a href="&lt;template:placeholder name="Link" /&gt;" title="Gästebuch administrieren!"&gt;
    hier
  &lt;/a&gt;
  um das Gästebuch zu administrieren!
&lt;/html:template&gt;

&lt;html:template name="ControlGuestbook_Login_en"&gt;
  &raquo; Please click
  &lt;a href="&lt;template:placeholder name="Link" /&gt;" title="Manage guestbook!"&gt;
    here
  &lt;/a&gt;
  to manage the guestbook!
&lt;/html:template&gt;

&lt;html:template name="ControlGuestbook_Logout_de"&gt;
  &raquo; Klicken Sie
  &lt;a href="&lt;template:placeholder name="Link" /&gt;" title="Administrations-Modus verlassen!"&gt;
    hier
  &lt;/a&gt;
  um den Administrations-Modus zu verlassen!
&lt;/html:template&gt;

&lt;html:template name="ControlGuestbook_Logout_en"&gt;
  &raquo; Please click
  &lt;a href="&lt;template:placeholder name="Link" /&gt;" title="Leave administration mode!"&gt;
    here
  &lt;/a&gt;
  to leave the administration mode!
&lt;/html:template&gt;

&lt;html:template name="Entry"&gt;
  &lt;div style="width: 100%;"&gt;
    &lt;div style="background-color: white; border-bottom: 2px solid gray; padding-bottom: 3px;"&gt;&lt;img src="/frontend/media/guestbook/elephant_small.png" alt="" border="0" /&gt;&nbsp;&nbsp;&lt;strong&gt;&lt;template:getstring namespace="modules::guestbook" config="guestbook_lang" entry="Text.EntryNo" /&gt; &lt;template:placeholder name="ID" /&gt;&lt;/strong&gt;&lt;/div&gt;
    &lt;div class="guestbook_padding_background"&gt;
      &lt;strong&gt;&lt;template:getstring namespace="modules::guestbook" config="guestbook_lang" entry="Text.Name" /&gt;:&lt;/strong&gt; &lt;template:placeholder name="Name" /&gt;
      &lt;br /&gt;
      &lt;strong&gt;&lt;template:getstring namespace="modules::guestbook" config="guestbook_lang" entry="Text.EMail" /&gt;:&lt;/strong&gt; &lt;template:placeholder name="EMail" /&gt;
      &lt;br /&gt;
      &lt;strong&gt;&lt;template:getstring namespace="modules::guestbook" config="guestbook_lang" entry="Text.City" /&gt;:&lt;/strong&gt; &lt;template:placeholder name="City" /&gt;
      &lt;br /&gt;
      &lt;strong&gt;&lt;template:getstring namespace="modules::guestbook" config="guestbook_lang" entry="Text.Website" /&gt;:&lt;/strong&gt; &lt;template:placeholder name="Website" /&gt;
      &lt;br /&gt;
      &lt;strong&gt;&lt;template:getstring namespace="modules::guestbook" config="guestbook_lang" entry="Text.ICQ" /&gt;:&lt;/strong&gt; &lt;template:placeholder name="ICQ" /&gt;,
      &lt;strong&gt;&lt;template:getstring namespace="modules::guestbook" config="guestbook_lang" entry="Text.MSN" /&gt;:&lt;/strong&gt; &lt;template:placeholder name="MSN" /&gt;,
      &lt;strong&gt;&lt;template:getstring namespace="modules::guestbook" config="guestbook_lang" entry="Text.Skype" /&gt;:&lt;/strong&gt; &lt;template:placeholder name="Skype" /&gt;,
      &lt;strong&gt;&lt;template:getstring namespace="modules::guestbook" config="guestbook_lang" entry="Text.AIM" /&gt;:&lt;/strong&gt; &lt;template:placeholder name="AIM" /&gt;,
      &lt;strong&gt;&lt;template:getstring namespace="modules::guestbook" config="guestbook_lang" entry="Text.Yahoo" /&gt;:&lt;/strong&gt; &lt;template:placeholder name="Yahoo" /&gt;
    &lt;/div&gt;
    &lt;div class="guestbook_padding_background" style="background-color: white;"&gt;
      &lt;template:placeholder name="Text" /&gt;
      &lt;template:placeholder name="Comments" /&gt;
    &lt;/div&gt;
    &lt;div class="guestbook_padding_background" style="padding-top: 2px; padding-bottom: 2px;"&gt;
      &lt;strong&gt;&lt;template:getstring namespace="modules::guestbook" config="guestbook_lang" entry="Text.Date" /&gt;:&lt;/strong&gt; &lt;template:placeholder name="Date" /&gt;, &lt;strong&gt;&lt;template:getstring namespace="modules::guestbook" config="guestbook_lang" entry="Text.Time" /&gt;:&lt;/strong&gt; &lt;template:placeholder name="Time" /&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;div style="width: 100%; text-align: right;"&gt;
    &lt;template:placeholder name="AdminAddComment" /&gt; &lt;template:placeholder name="AdminEdit" /&gt; &lt;template:placeholder name="AdminDelete" /&gt;
  &lt;/div&gt;
  &lt;br /&gt;
  &lt;br /&gt;
&lt;/html:template&gt;

&lt;html:template name="Comment"&gt;
  &lt;br /&gt;
  &lt;div style="width: 100%; margin: 10px; margin-bottom: 2px;"&gt;
    &lt;strong&gt;&lt;template:getstring namespace="modules::guestbook" config="guestbook_lang" entry="Text.Comment" /&gt;:&lt;/strong&gt;
  &lt;/div&gt;
  &lt;div style="width: 98%; margin: 10px; margin-top: 2px; margin-bottom: 0px; margin-right: 0px; border: 1px solid #dddddd;"&gt;
    &lt;div style="background-color: #dddddd; padding-left: 2px;"&gt;
      &lt;strong&gt;&lt;template:getstring namespace="modules::guestbook" config="guestbook_lang" entry="Text.Title" /&gt;:&lt;/strong&gt; &lt;template:placeholder name="Title" /&gt;
    &lt;/div&gt;
    &lt;div style="padding: 5px;"&gt;
      &lt;template:placeholder name="Text" /&gt;
    &lt;/div&gt;
    &lt;div style="background-color: #dddddd; padding-left: 2px;"&gt;
      &lt;strong&gt;&lt;template:getstring namespace="modules::guestbook" config="guestbook_lang" entry="Text.Date" /&gt;:&lt;/strong&gt; &lt;template:placeholder name="Date" /&gt;, &lt;strong&gt;&lt;template:getstring namespace="modules::guestbook" config="guestbook_lang" entry="Text.Time" /&gt;:&lt;/strong&gt; &lt;template:placeholder name="Time" /&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;div style="width: 98%; text-align: right;"&gt;
    &lt;template:placeholder name="AdminEditComment" /&gt; &lt;template:placeholder name="AdminDeleteComment" /&gt;
  &lt;/div&gt;
&lt;/html:template&gt;

&lt;html:template name="AdminDelete"&gt;
  &lt;a href="&lt;template:placeholder name="Link" /&gt;" title="Beitrag löschen!"&gt;&lt;strong&gt;[ del ]&lt;/strong&gt;&lt;/a&gt;
&lt;/html:template&gt;

&lt;html:template name="AdminEdit"&gt;
  &lt;a href="&lt;template:placeholder name="Link" /&gt;" title="Beitrag bearbeiten!"&gt;&lt;strong&gt;[ edt ]&lt;/strong&gt;&lt;/a&gt;
&lt;/html:template&gt;

&lt;html:template name="AdminAddComment"&gt;
  &lt;a href="&lt;template:placeholder name="Link" /&gt;" title="Kommentar hinzufügen!"&gt;&lt;strong&gt;[ cmt ]&lt;/strong&gt;&lt;/a&gt;
&lt;/html:template&gt;

&lt;html:template name="AdminDeleteComment"&gt;
  &lt;a href="&lt;template:placeholder name="Link" /&gt;" title="Kommentar löschen!"&gt;&lt;strong&gt;[ del ]&lt;/strong&gt;&lt;/a&gt;
&lt;/html:template&gt;

&lt;html:template name="AdminEditComment"&gt;
  &lt;a href="&lt;template:placeholder name="Link" /&gt;" title="Kommentar bearbeiten!"&gt;&lt;strong&gt;[ edt ]&lt;/strong&gt;&lt;/a&gt;
&lt;/html:template&gt;
</gen:highlight>
Im Controller werden dann auf generische Art und Weise die Inhalte mit den Methoden <em>__generateEntryList()</em>,
<em>__createEntry()</em> und <em>__createComment()</em> zusammengesetzt und in der Funktion
<em>transformContent()</em> ausgegeben. Das Laden der Einträge übernimmt dabei die oben
beschriebene Business-Schicht. Um die Einträge laden zu können wir der <em>GuestbookManager</em>
mit Hilfe der Funktion <em>loadGuestbook()</em> angefragt.
<gen:highlight type="php">
import('modules::guestbook::biz','GuestbookManager');
import('tools::link','FrontcontrollerLinkHandler');
import('core::session','SessionManager');
import('modules::guestbook::pres::documentcontroller','guestbookBaseController');
import('tools::string','StringAssistant');

class guestbook_display_v1_controller extends guestbookBaseController {

   private $_LOCALS;
   private $__sessMgr;

   public function __construct(){
      $this->__sessMgr = new SessionManager('Module_Guestbook');
   }

   public function transformContent(){

      // Manager holen
      $gM = &$this->__getGuestbookManager();

      // Einträge ausgeben
      $this->setPlaceHolder('Content',$this->__generateEntryList());

      // Pager ausgeben
      $this->setPlaceHolder('Pager',$gM->getPager());

      // Eintragen-Link ausgeben
      $this->setPlaceHolder('CreateEntry',$this->__generateCreateEntryLink());

      // Eintragen-Link ausgeben
      $this->setPlaceHolder('ControlGuestbook',$this->__generateControlGuestbookLink());

   }

   private function __generateCreateEntryLink(){

      // Referenz auf das Template holen
      $Template__CreateEntry = &$this->getTemplate('CreateEntry_'.$this->__Language);

      // Link generieren und einsetzen
      $Link = FrontcontrollerLinkHandler::generateLink($_SERVER['REQUEST_URI'],array('gbview' => 'createentry','entryid' => ''));
      $Template__CreateEntry->setPlaceHolder('Link',$Link);

      // Ausgabe zurückgeben
      return $Template__CreateEntry->transformTemplate();

   }

   private function __generateControlGuestbookLink(){

      // Inhalte der Session zerstören
      $oSessMgr = new SessionManager('Module_Guestbook');

      if($oSessMgr->loadSessionData('AdminView') == 'true'){

         // Referenz auf das Template holen
         $Template__ControlGuestbook_Logout = &$this->getTemplate('ControlGuestbook_Logout_'.$this->__Language);

         // Link generieren und einsetzen
         $Link = FrontcontrollerLinkHandler::generateLink($_SERVER['REQUEST_URI'],array('gbview' => 'adminlogin','logout' => 'true','entryid' => ''));
         $Template__ControlGuestbook_Logout->setPlaceHolder('Link',$Link);

         // Ausgabe zurückgeben
         return $Template__ControlGuestbook_Logout->transformTemplate();

      }
      else{

         // Referenz auf das Template holen
         $Template__ControlGuestbook_Login = &$this->getTemplate('ControlGuestbook_Login_'.$this->__Language);

         // Link generieren und einsetzen
         $Link = FrontcontrollerLinkHandler::generateLink($_SERVER['REQUEST_URI'],array('gbview' => 'adminlogin','entryid' => ''));
         $Template__ControlGuestbook_Login->setPlaceHolder('Link',$Link);

         // Ausgabe zurückgeben
         return $Template__ControlGuestbook_Login->transformTemplate();

      }

   }

   private function __generateEntryList(){

      // Manager holen
      $gM = &$this->__getGuestbookManager();

      // Einträge holen
      $Guestbook = $gM->loadGuestbook();
      $Entries = $Guestbook->getEntries();

      // Ausgabe generieren
      $Buffer = (string)'';

      for($i = 0; $i < count($Entries); $i++){
         $Buffer .= $this->__generateEntry($Entries[$i]);
      }

      // Puffer ausgeben
      return $Buffer;

   }

   private function __generateEntry($Entry){

      // Referenz auf das Template holen
      $Template__Entry = &$this->getTemplate('Entry');

      // Werte setzen
      $Template__Entry->setPlaceHolder('AdminDelete',$this->__showAdminDelete($Entry->get('ID')));
      $Template__Entry->setPlaceHolder('AdminEdit',$this->__showAdminEdit($Entry->get('ID')));
      $Template__Entry->setPlaceHolder('AdminAddComment',$this->__showAdminAddComment($Entry->get('ID')));
      $Template__Entry->setPlaceHolder('ID',$Entry->get('ID'));
      $Template__Entry->setPlaceHolder('Name',$Entry->get('Name'));
      $Template__Entry->setPlaceHolder('EMail',StringAssistant::encodeCharactersToHTML($Entry->get('EMail')));
      $Template__Entry->setPlaceHolder('City',$Entry->get('City'));
      $Template__Entry->setPlaceHolder('Website',$Entry->get('Website'));
      $Template__Entry->setPlaceHolder('ICQ',$Entry->get('ICQ'));
      $Template__Entry->setPlaceHolder('MSN',$Entry->get('MSN'));
      $Template__Entry->setPlaceHolder('Skype',$Entry->get('Skype'));
      $Template__Entry->setPlaceHolder('AIM',$Entry->get('AIM'));
      $Template__Entry->setPlaceHolder('Yahoo',$Entry->get('Yahoo'));
      $Template__Entry->setPlaceHolder('Text',nl2br($Entry->get('Text')));
      $Template__Entry->setPlaceHolder('Date',$Entry->get('Date'));
      $Template__Entry->setPlaceHolder('Time',$Entry->get('Time'));

      // Comments einfügen
      $Comments = $Entry->getComments();
      $CommentBuffer = (string)'';

      if(count($Comments) > 0){

         for($i = 0; $i < count($Comments); $i++){
            $CommentBuffer .= $this->__generateComment($Comments[$i],$Entry->get('ID'));
         }

      }

      $Template__Entry->setPlaceHolder('Comments',$CommentBuffer);

      // Ausgabe zurückgeben
      return $Template__Entry->transformTemplate();

   }

   ...

}
</gen:highlight>
<h4 id="Chapter-8-3-Formular-View"><a href="#Chapter-8-3-Formular-View">8.3. Formular-View</a></h4>
Im Formular-View wird das Formular zum Erzeugen eines Inhalts ausgegeben. Die Template-Datei definiert
im Wesentlichen das Formular und dessen Verhalten hinsichtlich Validierung der Felder.
<gen:highlight type="apf-xml">
&lt;@controller namespace="modules::guestbook::pres::documentcontroller" class="guestbook_createentry_v1_controller" [file="guestbook_createentry_v1_controller"] @&gt;
&lt;core:addtaglib namespace="tools::form::taglib" prefix="html" class="form" /&gt;
&lt;br /&gt;
&lt;br /&gt;
&lt;strong&gt;&lt;html:getstring namespace="modules::guestbook" config="guestbook_lang.ini" entry="CreateEntry.Title" /&gt;&lt;/strong&gt;
&lt;br /&gt;
&lt;br /&gt;
&lt;html:getstring namespace="modules::guestbook" config="guestbook_lang.ini" entry="CreateEntry.Hint" /&gt;
&lt;br /&gt;
&lt;br /&gt;
&lt;html:placeholder name="Form" /&gt;

&lt;html:form name="GuestbookEntry" method="post"&gt;
  &lt;table cellpadding="0" cellspacing="0" class="formtable"&gt;
    &lt;tr&gt;
      &lt;td class="formtable_row_description"&gt;
        &lt;form:getstring namespace="modules::guestbook" config="guestbook_lang.ini" entry="CreateEntry.Form.Name" /&gt;
      &lt;/td&gt;
      &lt;td class="formtable_row_control"&gt;
        &lt;form:text name="Name" class="eingabe_feld" style="width: 300px;" validate="true" button="CreateGuestbookEntryButton"/&gt;
      &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td class="formtable_row_description"&gt;
        &lt;form:getstring namespace="modules::guestbook" config="guestbook_lang.ini" entry="CreateEntry.Form.EMail" /&gt;
      &lt;/td&gt;
      &lt;td class="formtable_row_control"&gt;
        &lt;form:text name="EMail" class="eingabe_feld" style="width: 300px;" validate="true" validator="EMail" button="CreateGuestbookEntryButton" /&gt;
      &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td class="formtable_row_description"&gt;
        &lt;form:getstring namespace="modules::guestbook" config="guestbook_lang.ini" entry="CreateEntry.Form.City" /&gt;
      &lt;/td&gt;
      &lt;td class="formtable_row_control"&gt;
        &lt;form:text name="City" class="eingabe_feld" style="width: 300px;" /&gt;
      &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td class="formtable_row_description"&gt;
        &lt;form:getstring namespace="modules::guestbook" config="guestbook_lang.ini" entry="CreateEntry.Form.Website" /&gt;
      &lt;/td&gt;
      &lt;td class="formtable_row_control"&gt;
        &lt;form:text name="Website" class="eingabe_feld" style="width: 300px;" /&gt;
      &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td class="formtable_row_description"&gt;
        &lt;form:getstring namespace="modules::guestbook" config="guestbook_lang.ini" entry="CreateEntry.Form.ICQ" /&gt;
      &lt;/td&gt;
      &lt;td class="formtable_row_control"&gt;
        &lt;form:text name="ICQ" class="eingabe_feld" style="width: 300px;" /&gt;
      &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td class="formtable_row_description"&gt;
        &lt;form:getstring namespace="modules::guestbook" config="guestbook_lang.ini" entry="CreateEntry.Form.MSN" /&gt;
      &lt;/td&gt;
      &lt;td class="formtable_row_control"&gt;
        &lt;form:text name="MSN" class="eingabe_feld" style="width: 300px;" /&gt;
      &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td class="formtable_row_description"&gt;
        &lt;form:getstring namespace="modules::guestbook" config="guestbook_lang.ini" entry="CreateEntry.Form.Skype" /&gt;
      &lt;/td&gt;
      &lt;td class="formtable_row_control"&gt;
        &lt;form:text name="Skype" class="eingabe_feld" style="width: 300px;" /&gt;
      &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td class="formtable_row_description"&gt;
        &lt;form:getstring namespace="modules::guestbook" config="guestbook_lang.ini" entry="CreateEntry.Form.AIM" /&gt;
      &lt;/td&gt;
      &lt;td class="formtable_row_control"&gt;
        &lt;form:text name="AIM" class="eingabe_feld" style="width: 300px;" /&gt;
      &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td class="formtable_row_description"&gt;
        &lt;form:getstring namespace="modules::guestbook" config="guestbook_lang.ini" entry="CreateEntry.Form.Yahoo" /&gt;
      &lt;/td&gt;
      &lt;td class="formtable_row_control"&gt;
        &lt;form:text name="Yahoo" class="eingabe_feld" style="width: 300px;" /&gt;
      &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td colspan="2" class="formtable_row_description"&gt;
        &lt;br /&gt;
        &lt;strong&gt;&lt;form:getstring namespace="modules::guestbook" config="guestbook_lang.ini" entry="CreateEntry.Form.Text" /&gt;&lt;/strong&gt; *
        &lt;br /&gt;
        &lt;br /&gt;
        &lt;form:area name="Text" class="eingabe_feld" style="height: 200px; width: 480px; overflow: auto;" validate="true" button="CreateGuestbookEntryButton" /&gt;
      &lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td colspan="2" class="formtable_row_description"&gt;
        &lt;br /&gt;
        &lt;strong&gt;&lt;form:getstring namespace="modules::guestbook" config="guestbook_lang.ini" entry="CreateEntry.Form.Captcha" /&gt;&lt;/strong&gt;
        &lt;br /&gt;
        &lt;br /&gt;
        &lt;form:addtaglib namespace="modules::captcha::pres::taglib" prefix="form" class="captcha" /&gt;
        &lt;form:captcha text_class="eingabe_feld" validate="true" button="CreateGuestbookEntryButton"/&gt;
      &lt;/td&gt;
    &lt;/tr&gt;
  &lt;/table&gt;
  &lt;br /&gt;
  &lt;span style="font-size: 11px;"&gt;
    &lt;form:getstring namespace="modules::guestbook" config="guestbook_lang.ini" entry="CreateEntry.Form.Hint" /&gt;
  &lt;/span&gt;
  &lt;br /&gt;
  &lt;br /&gt;
  &lt;br /&gt;
  &lt;form:button name="CreateGuestbookEntryButton" value="Eintragen" class="eingabe_feld" /&gt;
&lt;/html:form&gt;
</gen:highlight>
Der zugehörige Document-Controller implementiert dazu lediglich die Methode <em>transformContent()</em>,
in der abgefragt wird, ob das Formular korrekt ausgefüllt wurde. Ist das der Fall wird aus den
Werten ein Entry-Domain-Objekt erstellt und dieses an die Business-Schicht zur Speicherung desselben
weitergegeben.
<gen:highlight type="php">
import('modules::guestbook::biz','GuestbookManager');
import('modules::guestbook::pres::documentcontroller','guestbookBaseController');

class guestbook_createentry_v1_controller extends guestbookBaseController {

   private $_LOCALS;

   public function __construct(){

      $this->_LOCALS = RequestHandler::getValues(array(
                                                             'Name',
                                                             'EMail',
                                                             'City',
                                                             'Website',
                                                             'ICQ',
                                                             'MSN',
                                                             'Skype',
                                                             'AIM',
                                                             'Yahoo',
                                                             'Text'
                                                            )
                                                      );

   }

   public function transformContent(){

      // Referenz auf das Formular holen
      $Form__GuestbookEntry = &$this->getForm('GuestbookEntry');

      if($Form__GuestbookEntry->get('isValid') && $Form__GuestbookEntry->get('isSent')){

         // Manager holen
         $gM = &$this->__getGuestbookManager();

         // Eintrag erzeugen
         $Entry = new Entry();
         $Entry->set('Name',$this->_LOCALS['Name']);
         $Entry->set('EMail',$this->_LOCALS['EMail']);
         $Entry->set('City',$this->_LOCALS['City']);
         $Entry->set('Website',$this->_LOCALS['Website']);
         $Entry->set('ICQ',$this->_LOCALS['ICQ']);
         $Entry->set('MSN',$this->_LOCALS['MSN']);
         $Entry->set('Skype',$this->_LOCALS['Skype']);
         $Entry->set('AIM',$this->_LOCALS['AIM']);
         $Entry->set('Yahoo',$this->_LOCALS['Yahoo']);
         $Entry->set('Text',$this->_LOCALS['Text']);

         // Eintrag speichern
         $gM->saveEntry($Entry);

      }
      else{

         // Button beschriften
         $Config = $this->getConfiguration('modules::guestbook','guestbook_lang.ini');
         $Button = &$Form__GuestbookEntry->getFormElementByName('CreateGuestbookEntryButton');
         $Button->setAttribute('value',$Config->getSection($this->__Language)->getValue('CreateEntry.Form.Button'));

         // Formular anzeigen
         $this->setPlaceHolder('Form',$Form__GuestbookEntry->transformForm());

      }

   }

}
</gen:highlight>
<strong>Fortsetzung:</strong>
Die Implementierung des Frontends ist damit erledigt. <a href="./?Seite=059-Gaestebuch-Tutorial-3" title="Backend">Seite 3</a>
beschäftigt sich nun mit der Erstellung des Backends.
<br />
<br />
<br />
<core:importdesign namespace="modules::comments::pres::templates" template="comment" categorykey="de_058" />