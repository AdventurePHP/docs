<doku:title tags="dokumentation,module,captcha,gaestebuch,pager,kommentar,social bookmarking,usermanagement" title="Module - Usermanagement" urlname="Module-Usermanagement">
  Generisch einsetzbares Usermanagement.
</doku:title>
<core:importdesign namespace="sites::apfdocupage::pres::templates::perspectives::content::voting" template="voting" />
Das Modul <strong>usermanagement</strong> beinhaltet ein Backend zur Benutzerverwaltung und eine
generische Business-Komponente - basierend auf dem
<a href="./?Seite=063-Generischer-OR-Mapper" title="GenericORMapper">GenericORMapper</a> - die zur
Authentifizierung und zur Verwaltung von Benutzern, Gruppen, Rollen, Berechtigungen und
Berechtigungsschemata verwendet werden kann. Es dient einerseits dazu, Benutzer-Verwaltung zu
standardisieren, andererseits, dem Entwickler f&uuml;r eine so zentrale Aufgabe ein fertiges und
verl&auml;ssliches Tool an die Hand zu geben.
<br />
<br />
Die folgenden Kapitel zeigen den Aufbau des Moduls und geben Beispiele f&uuml;r die Verwendung des
Business-Komponente und die Einbindung des Backends.
<br />
<br />
<br />
<a name="1-Design"></a><h3>1. Design des Moduls</h3>
Das Modul besteht aus einer Business-Komponente, dem <strong>UmgtManager</strong>, und einem Frontend.
Der Manager nutzt den <strong>GenericORMapper</strong> als Datenkomponente. Das Frontend basiert
komplett auf der Business-Schicht des Moduls. Das bedeutet, dass diese in anderen Anwendungen f&uuml;r
die Authentifizierung und Benutzerverwaltung als vollwertige Komponente eingesetzt werden kann.
<br />
<br />
<br />
<a name="1-1-Datenmodell"></a><h4>1.1. Datenmodell</h4>
Das Datenmodell des Benutzer-Managements sieht die Gliederung in
<ul>
  <li>Benutzer</li>
  <li>Gruppen</li>
  <li>Rollen</li>
  <li>Berechtigungsschemen</li>
  <li>Berechtigungen</li>
</ul>
vor. Dieses Trennung erm&ouml;glicht es, eine granulare und allgemeing&uuml;ltige Benutzerverwaltung
bereitzustellen. Das folgende UML-Diagramm zeigt die Bedeutung der Objekte und deren Beziehungen:
<br />
<br />
<img src="http://media.adventure-php-framework.org/content/usermanagement_domain_model.png" alt="Usermanagement UML Diagramm (APF)" style="width: 560px;" />
<br />
<br />
<strong>Hinweis:</strong> Gruppen werden in der Regel zur Vergabe von Berechtigungen auf
<strong>Objekte</strong> einer Anwendung verwendet, Rollen kommen dann zum Einsatz, wenn Berechtigungen
auf das ausf&uuml;hren von <strong>Funktionen</strong> vergeben werden sollen. Zur Granularisierung
und Wiederverwendbarkeit von &quot;Funktionsberechtigungen&quot; wurden <em>Berechtigungsschemen</em>
eingef&uuml;hrt. Diese k&ouml;nnen wiederum mehrere Berechtigungen kapseln und werden selbst einer
Rolle zugewiesen.
<br />
<br />
<br />
<a name="1-2-UmgtManager"></a><h4>1.2. UmgtManager</h4>
Die Business-Komponente besitzt eine Reihe von Methoden, die dem Entwickler einen abstrahierten
Zugriff auf das Datenmodell geben. Darunter befinden sich nicht nur Methoden zum Erzeugen, Lesen,
Manipulieren und L&ouml;schen von einzelnen Objekten, sondern auch zum Erzeugen, Lesen, Manipulieren
und L&ouml;schen der Beziehungen zwischen den Objekten. Im Besonderen wurden Methoden inkludiert,
die das Authentifizieren und Verwenden von Benutzern erleichtert um die Implementierung von
Anwendungen, basierend auf dem Benutzermanagement, m&ouml;glichst effektiv zu gestalten.
<br />
<br />
Die folgende Liste zeigt eine &Uuml;bersicht &uuml;ber die API-Methoden der Komponente. Details
k&ouml;nnen der API-Dokumentation der Klasse <strong>UmgtManager</strong> entnommen werden:
<ul style="line-height: 20px;">
  <li><strong>loadUserByEMailAndPassword()</strong>: L&auml;d einen Benutzer per E-Mail und Passwort.</li>
  <li><strong>loadUserByUsernameAndPassword()</strong>: L&auml;d einen Benutzer per Benutzername und Passwort.</li>
  <li><strong>loadUserPermissions()</strong>: L&auml;d die Berechtigungen, die ein Benutzer besitzt.</li>
  <li><strong>saveUser($user)</strong>: Speichert einen Benutzer in der aktuellen Instanz der Benutzerverwaltung.</li>
  <li><strong>saveGroup($group)</strong>: Speichert eine Gruppe in der aktuellen Instanz der Benutzerverwaltung.</li>
  <li><strong>saveRole($role)</strong>: Speichert eine Rolle in der aktuellen Instanz der Benutzerverwaltung.</li>
  <li><strong>savePermissionSet($permissionSet)</strong>: Speichert ein Berechtigungsschema in der aktuellen Instanz der Benutzerverwaltung.</li>
  <li><strong>savePermission($permission)</strong>: Speichert eine Berechtigung in der aktuellen Instanz der Benutzerverwaltung.</li>
  <li><strong>getPagedUserList()</strong>: Gibt eine Liste von Benutzern zur&uuml;ck.</li>
  <li><strong>getPagedGroupList()</strong>: Gibt eine Liste von Gruppen zur&uuml;ck.</li>
  <li><strong>getPagedRoleList()</strong>: Gibt eine Liste von Rollen zur&uuml;ck.</li>
  <li><strong>getPagedPermissionSetList()</strong>: Gibt eine Liste von Berechtigungsschemen zur&uuml;ck.</li>
  <li><strong>getPagedPermissionList()</strong>: Gibt eine Liste von Berechtigungen zur&uuml;ck.</li>
  <li><strong>loadUserByID($userID)</strong>: L&auml;d einen Benutzer per ID.</li>
  <li><strong>loadGroupByID($groupID)</strong>: L&auml;d eine Gruppe per ID.</li>
  <li><strong>loadRoleByID($roleID)</strong>: L&auml;d eine Rolle per ID.</li>
  <li><strong>loadPermissionSetByID($permissionSetID)</strong>: L&auml;d ein Berechtigungsschema per ID.</li>
  <li><strong>loadPermissionByID($permID)</strong>: L&auml;d ein Berechtigung per ID.</li>
  <li><strong>loadPermissionList()</strong>:  Gibt eine Liste von Berechtigungen zur&uuml;ck.</li>
  <li><strong>loadRolesNotWithPermissionSet($permissionSet)</strong>: L&auml;d eine Liste von Rollen, die nicht das &uuml;bergebene Berechtigungsschema haben.</li>
  <li><strong>loadRolesWithPermissionSet($permissionSet)</strong>: L&auml;d eine Liste von Rollen, die das &uuml;bergebene Berechtigungsschema haben.</li>
  <li><strong>assignPermissionSet2Roles($permissionSet,$roles)</strong>: Weist ein Berechtigungsschema mehreren Rollen zu.</li>
  <li><strong>detachPermissionSetFromRoles($permissionSet,$roles)</strong>: Entfernt ein Berechtigungsschema von einer Liste von Rollen.</li>
  <li><strong>deleteUser($user)</strong>: L&ouml;scht einen Benutzer.</li>
  <li><strong>deleteGroup($group)</strong>: L&ouml;scht eine Gruppe.</li>
  <li><strong>deleteRole($role)</strong>: L&ouml;scht eine Rolle.</li>
  <li><strong>deletePermissionSet($permissionSet)</strong>: L&ouml;scht ein Berechtigungsschema.</li>
  <li><strong>deletePermission($permission)</strong>: L&ouml;scht eine Berechtigung.</li>
  <li><strong>assignUser2Groups($user,$groups)</strong>: Nimmt einen Benutzer in mehrere Gruppen auf.</li>
  <li><strong>assignUsers2Group($users,$group)</strong>: Nimmt mehrere Benutzer in eine Gruppe auf.</li>
  <li><strong>assignRole2Users($role,$users)</strong>: Weist eine Rolle mehreren Benutzern zu.</li>
  <li><strong>loadGroupsWithUser(&$user)</strong>: L&auml;d alle Gruppen, die einem Benutzer zugewiesen wurden.</li>
  <li><strong>loadGroupsNotWithUser(&$user)</strong>: L&auml;d alle Gruppen, die einem Benutzer nicht zugewiesen wurden.</li>
  <li><strong>loadUsersWithGroup(&$group)</strong>: L&auml;d alle Benutzer, die einer Gruppe angeh&ouml;ren.</li>
  <li><strong>loadUsersNotWithGroup(&$group)</strong>: L&auml;d alle Benutzer, die nicht einer Gruppe angeh&ouml;ren.</li>
  <li><strong>loadRolesWithUser(&$user)</strong>: L&auml;d alle Rollen, die einem Benutzer zugewiesen wurden.</li>
  <li><strong>loadRolesNotWithUser(&$user)</strong>: L&auml;d alle Rollen, die einem Benutzer nicht zugewiesen wurden.</li>
  <li><strong>loadUsersWithRole(&$role)</strong>: L&auml;d alle Benutzer, die einer Rolle angeh&ouml;ren.</li>
  <li><strong>loadUsersNotWithRole(&$role)</strong>: L&auml;d alle Benutzer, die einer Rolle nicht angeh&ouml;ren.</li>
  <li><strong>loadPermissionsOfPermissionSet(&$permissionSet)</strong>: L&auml;d alle Berechtigungen eines Schemas.</li>
  <li><strong>detachUserFromRole($user,$role)</strong>: Entfernt die Zuweisung eines Benutzers zu einer Rolle.</li>
  <li><strong>detachUsersFromRole($users,$role)</strong>: Entfernt die Zuweisung mehrerer Benutzer zu einer Rolle.</li>
  <li><strong>detachUserFromGroup($user,$group)</strong>: Entfernt einen Benutzer aus einer Gruppe.</li>
  <li><strong>detachUserFromGroups($user,$groups)</strong>: Entfernt einen Benutzer aus mehrern Gruppen.</li>
  <li><strong>detachUsersFromGroup($users,$group)</strong>: Entfernt mehrere Benutzer aus einer Gruppe.</li>
</ul>
<br />
<a name="2-Installation"></a><h3>2. Installation</h3>
Die Installation des Moduls umfasst folgende Schritte:
<ul>
  <li>Konfiguration des Moduls bereitstellen</li>
  <li>Konfiguration des GenericORMappers bereitstellen</li>
  <li>Installation der Datenbank</li>
</ul>
<br />
<a name="2-1-Konfiguration-Modul"></a><h4>2.1. Konfiguration des Moduls</h4>
Die Konfiguration des Moduls umfasst drei Parameter: den Schl&uuml;ssel der Datenbankverbindung,
die ID des zu verwendenden Applikationscontainers und den Service-Mode, mit dem der OR-Mapper erzeugt
werden soll:
<pre class="tagexample">
[InstanceName]
ConnectionKey = ""
ApplicationID = ""
ServiceMode = ""
</pre>
Im <em>adventure-configpack-*</em>-Package ist eine Beispiel-Konfigurationsdatei mit einer Bescheibung
der Werte enthalten.
<br />
<br />
Da das Datenmodell ein Objekt <strong>Application</strong> besitzt, kann das Usermanagement f&uuml;r
mehrere Anwendungen gleichzeitig auf der selben Datenquelle verwendet werden. So ist es m&ouml;glich
eine gemeinsame Datenhaltung f&uuml;r Benutzer in unterschiedlichen Applikationen oder Modulen
aufzubauen. Bei der Verwendung muss dem <em>UmgtManager</em> deshalb die <strong>ApplicationID</strong>
mitgegeben werden, damit bekannt ist, welcher Container adressiert werden soll. Durch die Konfiguration
k&ouml;nnen innrhalb eines Contextes mehrere Instanzen definiert und verwendet werden.
<br />
<br />
<br />
<a name="2-2-Konfiguration-OR-Mapper"></a><h4>2.2. Konfiguration des OR-Mappers</h4>
Da das Modul auf dem <a href="./?Seite=063-Generischer-OR-Mapper" title="GenericORMapper">GenericORMapper</a>
basiert, muss f&uuml;r das oben abgebildete UML eine Konfiguration f&uuml;r den Mapper vorhanden
sein. Um das Setup zu erleichtern sind die fertigen Konfigurationsdateien bereits im
<em>adventure-configpack-*</em>-Package unter <strong>/modules/usermanagement/</strong> enthalten.
Diese m&uuml;ssen lediglich in den <strong>config</strong>-Namespace in den richtigen Ordner kopiert
werden. Hierbei muss darauf geachtet werden, dass die Konfigurationsdateien im korrekten Context-Pfad
liegen und entsprechend benannt sind. Details k&ouml;nnen dem Kapitel
<a href="./?Seite=033-Konfiguration#2-Bennenung-Pfade-und-Dateien" title="Konfiguration">Konfiguration</a>
entnommen werden.
<br />
<br />
Wie der
<a href="./?Seite=063-Generischer-OR-Mapper#2-3-Objekt-und-Beziehungsdefinition" title="Objekt- und Beziehungsdefinition">Dokumentation</a>
des generischen OR-Mappers zu entnehmen ist, m&uuml;ssen f&uuml;r die verwendeten Objekte und die
Beziehungen der Objekte Konfigurationen vorgehalten werden.
<br />
<br />
<br />
<a name="2-3-Installation-Datenbank"></a><h4>2.3. Installation der Datenbank</h4>
Als letzter Schritt muss die Datenbank vorbereitet werden. Dazu muss das unter
<strong>/modules/usermanagement/data/scripts/setup.sql</strong> gegen die gew&uuml;nschte Datenbank
ausgef&uuml;hrt werden. Anschlie&szlig;end ist das Modul voll einsatzbereit.
<br />
<br />
Es empfiehlt sich, f&uuml;r das Modul eine eigene Datenbank zu nutzen, grunds&auml;tzlich spricht
jedoch nichts gegen eine bereits bestehende Datenbank zu bef&uuml;llen. Durch den Einsatz des
<a href="./?Seite=031-Klassenreferenz-connectionManager" title="ConnectionManager">ConnectionManager</a>
entsteht in keinem Fall ein Nachteil, da mit diesem innerhalb einer Applikation mehrere Datenbanken
adressiert werden k&ouml;nnen.
<br />
<br />
<br />
<a name="3-Anwendung"></a><h3>3. Anwendung</h3>
<a name="3-1-Backend"></a><h4>3.1. Backend</h4>
Um das integrierte Backend nutzen zu k&ouml;nnen, muss f&uuml;r das Modul eine eigene Bootstrap
erstellt oder dieses per Tag in eine bestehende Anwendung eingebaut werden. Durch die generische
Implementierung werden bei der Erzeugung der URLs des Moduls externe Parameter (z.B. zur Navigation)
mit eingebunden.
<br />
<br />
Da das Backend auf dem Frontcontroller basiert (Anzeige der Icons wird &uuml;ber die
<a href="./?Seite=078-Spezielle-TagLibs#2-Mediastream" title="Mediastream-Tags">&lt;*:mediastream /&gt;</a>-Tags
realisiert), kann folgende <em>index.php</em> eingesetzt werden:
<php:highlight>
include('./apps/core/pagecontroller/pagecontroller.php');
import('core::frontcontroller','Frontcontroller');
$fC = &Singleton::getInstance('Frontcontroller');
$fC->set('Context',{CONTEXT});
$fC->start('modules::usermanagement::pres::templates','main');
</php:highlight>
Soll das Backend als View in einer bestehenden Anwendung integriert werden, kann folgende
Tag-Definition verwendet werden:
<pre class="tagexample">
&lt;core:importdesign namespace="modules::usermanagement::pres::templates" template="main" &gt;
</pre>
Sollte die bestehende Anwendung eine Frontcontroller-Action zur Navigation nutzen, so muss das Modul
mit dem <strong>&lt;generic:importdesign /&gt;</strong>-Tag eingebaut und die Navigations-Action
mit <strong>$__KeepInURL = true</strong> definiert werden. Andernfalls wird die Action-Information
nicht in die Links des Moduls eingebunden und die Navigation funktioniert unter Umst&auml;nden nicht.
<pre class="tagexample">
&lt;core::addtaglib namespace="tools::html::taglib" prefix="generic" class="importdesign" />
&lt;generic:importdesign
   modelnamespace="namespace::to::application::model"
   modelfile="ModelName"
   modelclass="ModelName"
   modelmode="SINGLETON"
   namespaceparam="..."
   templateparam="..."
   dependentactionnamespace="namespace::to::dependent::action"
   dependentactionname="DependentActionName"
   dependentactionparams="param1:value1|param2:value2"
/&gt;
</pre>
Details zum generischen importdesign-Tag k&ouml;nnen dem Kapitel
<a href="./?Seite=078-Spezielle-TagLibs#3-Generischer-importdesign-Tag" title="Generischer importdesign-Tag">Spezialle TagLibs</a>
entnommen werden.
<br />
<br />
<br />
<a name="3-2-Businesskomponente"></a><h4>3.2. Business-Komponente</h4>
Die API der Klasse <strong>UmgtManager</strong> arbeitet grunds&auml;tzlich mit Objekten. Das
bedeutet, dass als Argumente weitestgehend Objekte des Typs <strong>GenericDomainObject</strong>
erwartet werden. Als R&uuml;ckgabewerte dienen ebenfalls Instanzen der Klasse
<strong>GenericDomainObject</strong> oder der Wert <strong>null</strong>.
<br />
<br />
<br />
<a name="3-2-1-Login-Benutzer"></a><h5>3.2.1. Login via Benutzer und Passwort</h5>
Das folgende Beispiel zeigt, wie eine einfache Authentifizierung mit Hilfe von URL-Werten
durchgef&uuml;hrt werden kann:
<php:highlight>
// get the business object
$uM = &$this->__getAndInitServiceObject('modules::usermanagement::biz','umgtManager','Default');

// retrieve the username and password from the request
$username = RequestHandler::getValue('user');
$password = RequestHandler::getValue('pass');

// try to get the user object. if null ist returned, the credentials are not correct
$user = $uM->loadUserByUsernameAndPassword($username,$password);
if($user !== null){
   echo 'user "'.$user->getProperty('DisplayName').'" is logged in';
 // end if
}
else{
   echo 'user could not be logged in with the given credentials';
 // end else
}
</php:highlight>
<br />
<a name="3-2-2-Login-E-Mail"></a><h5>3.2.2. Login via E-Mail und Passwort</h5>
Um einen Benutzer nicht &uuml;ber seinen Benutzernamen sondern seiner E-Mail-Adresse und seinem
Passwort zu authentifizieren, muss der Methodenaufruf
<php:highlight>
$user = $uM->loadUserByUsernameAndPassword($username,$password);
</php:highlight>
durch
<php:highlight>
$user = $uM->loadUserByEMailAndPassword($email,$password);
</php:highlight>
ersetzt werden.
<br />
<br />
<br />
<a name="3-2-3-Gruppen-und-Rollen"></a><h5>3.2.3. Laden von Gruppen und Rollen</h5>
Wurde ein Benutzer erfolgreich &uuml;ber die in 3.2.1 und 3.2.1 geschilderte Methoden geladen, so
kann wie folgt auf dessen Gruppen und Rollen zugegriffen werden:
<php:highlight>
// load groups
$groups = $uM->loadGroupsWithUser($user);

// load roles
$roles = $uM->loadRolesWithUser($user);
</php:highlight>
<br />
<a name="3-2-4-Benutzer-Berechtigungen"></a><h5>3.2.4. Laden von Benutzer-Berechtigungen</h5>
M&ouml;chte der Entwickler nun auf die dem Benutzer zugeordneten Funktionsberechtigungen
(<em>Permissions</em>) zugreifen, kann das &uuml;ber die Rollen, oder direkt &uuml;ber eine daf&uuml;r
vorgesehene API-Methode erledigt werden:
<php:highlight>
// load permissions via the relevant relations
$roles = $uM->loadRolesWithUser($user);

$permissions = array();
for($i = 0; $i < count($roles); $i++){

   // load permission sets
   $permSets = $roles[$i]->loadRelatedObjects('Role2PermissionSet');

   for($j = 0; $j < count($permSets); $j++){
      $permissions = array_merge($permissions,$permSets[$j]->loadRelatedObjects('PermissionSet2Permission'));
    // end for
   }

 // end for
}
// call the api method
$permissions = $uM->loadUserPermissions($user);
</php:highlight>
Nachteil der ersten Variante ist die m&ouml;gliche Mehrfachzuordnung von Funktionsberechtigungen zu
Berechtigungsschemen und Rollen zu Benutzern. Die API-Methode ber&uuml;cksicht dies.
<br />
<br />
<br />
<a name="3-2-5-Manipulation-Objekte"></a><h5>3.2.5. Manipulieren von Objekten</h5>
<pre>- Manipulieren von verschiedenen Objekten</pre>
<br />
<br />
<br />
<a name="3-2-6-Manipulation-Beziehungen"></a><h5>3.2.6. Manipulieren von Beziehungen</h5>
<pre>- Manipulieren von verschiedenen Beziehungen</pre>

<br />
<br />
<br />
<core:importdesign namespace="modules::comments::pres::templates" template="comment" categorykey="de_095" />