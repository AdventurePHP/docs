<doku:title parent="100" tags="migration,2.1,3.0" title="Migration von 2.1 auf 3.0" urlname="Migration-von-2-1-auf-3-0">
   Diese Seite beschreibt die Anpassungen an bestehender Software (bis einschließlich Release 2.1), die notwendig sind
   um Ihre Applikation auf die Version 3.0 zu portieren.
</doku:title>
<h3 id="Chapter-1-Einleitung"><a href="#Chapter-1-Einleitung">1. Einleitung</a></h3>
<p>
   Version 3.0 des Adventure PHP Framework beinhaltet einen von Grund auf neu geschriebenen Parser. Auf diesem basieren
   eine Vielzahl von neuen Funktionen und Optimierungen.
</p>
<div class="hint">
   Mit dem Erscheinen dieses Release wird die Weiterentwicklung der Version 2.1 eingestellt. Security- und Bug-Fixes werden
   bis Ende 2015 verfügbar sein.
</div>
<p>
   In diesem Artikel erfahren Sie, wie Sie eine bestehende Anwendung auf APF-Version 3.0 aktualisieren können. Wie
   bereits von den vorangegangenen Versionen gewohnt, kann die Migration auch in diesem Release weitestgehend automatisiert
   erfolgen. Zu diesem Zweck liegen zwei Migrations-Skripten bei: <em>migrate-code.sh</em> für die Aktualisierung von
   HTML- und PHP-Dateien und <em>migrate-config.sh</em> für Konfigurations-Dateien.
</p>
<div class="hint">
   Das APF-Team empfiehlt, die Nutzung der Migrations-Skripten einer manuellen Migration vorzuziehen. Dies spart Zeit
   und Kosten und stellt sicher, dass alle relevanten Stellen erfasst wurden.
</div>
<p>
   Die folgenden Kapitel stellen die notwendigen Schritte zum Umstieg auf Version 3.0 zusammen.
</p>

<h3 id="Chapter-2-Automatisierte-Migration"><a href="#Chapter-2-Automatisierte-Migration">2. Automatisierte Migration</a></h3>
<p>
   Wie von Release 2.1 bereits bekannt, lässt sich die Migration mit Hilfe eines mitgelieferten Migrations-Skripts
   erledigen. In diesem Release wurden Änderungen an Code- und Konfigurations-Dateien vorgenommen, die mit Hilfe der
   Skripte <em>migrate-code.sh</em> und <em>migrate-config.sh</em> auf Ihre bestehende Applikation übertragen werden
   können.
</p>
<div class="warn">
   Bitte stellen Sie sicher, dass Sie vor der Migration alle unter <int:link pageid="157" /> beschriebenen Schritte
   durchgeführt haben. Setzen Sie eine noch ältere Version ein, migrieren Sie bitte zuerst <em>vollständig</em> auf die
   Version 2.1. Hinweise zur jeweiligen Migration finden Sie auf der Seite <int:link pageid="100" />.
</div>
<p>
   Sofern Sie auf Windows entwickeln, installieren Sie bitte eine aktuelle Version von <em>cygwin</em> (Download unter
   <a class="external" href="http://cygwin.com/install.html">cygwin.com</a>). Eine Migration auf Basis eines
   Windows-Batch-Script wird nicht angeboten.
</p>
<p>
   Um Ihre Quell-Code-Dateien auf den neuesten Stand zu bringen, führen Sie das Skript bitte wie folgt aus:
</p>
<div class="warn">
   Bitte wechseln Sie vor der Ausführung in das Code-Verzeichnis Ihrer Applikation um unerwartete Ergebnisse
   zu vermeiden.
</div>
<gen:highlight type="code">
$ /path/to/APF/migration/migrate-code.sh /cygdrive/c/xampp/php/php
#############################################
# APF 3.0 automatic code migration          #
#############################################

Checking PHP executable available ... [OK]

Using given php executable at /cygdrive/c/xampp/php/php. PHP Version: 5.4.16.

#############################################

Starting migration ...
* Migrate taglib declaration statements ...
* Consolidate tag usage ...
* Remove redundant tag lib registration ...
* Switch to new place holder logic ...

#############################################

Migration done! Please check your code and follow instructions within migration documentation!
</gen:highlight>
<p>
   Um Ihre Konfigurations-Dateien auf den neuesten Stand zu bringen, führen Sie das Skript bitte wie folgt aus:
</p>
<div class="warn">
   Bitte wechseln Sie vor der Ausführung in das Konfigurations-Verzeichnis Ihrer Applikation um unerwartete Ergebnisse
   zu vermeiden.
</div>
<gen:highlight type="code">
$ /path/to/APF/migration/migrate-config.sh /cygdrive/c/xampp/php/php
#############################################
# APF 3.0 automatic configuration migration #
#############################################
Checking PHP executable available ... [OK]

Using given php executable at /cygdrive/c/xampp/php/php. PHP Version: 5.4.16.

#############################################

Starting configuration migration ...
* Migrate cache configuration ...
* Migrate pager configuration ...

#############################################

Migration done! Please check your configuration and follow instructions within migration documentation!
</gen:highlight>

<h3 id="Chapter-3-Manuelle-Schritte"><a href="#Chapter-3-Manuelle-Schritte">3. Manuelle Schritte</a></h3>
<p>
   Das Migrations-Skript kann leider nicht alle Projekt-spezifischen Konstrukte migrieren. Die folgenden Kapitel
   zeigen, welche manuellen Schritte notwendig sind um bestehenden Code mit der Version 3.0 einsetzen zu können:
</p>

<h4 id="Chapter-3-1-Front-Controller"><a href="#Chapter-3-1-Front-Controller">3.1. Front-Controller</a></h4>
<p>
   Mit dem Issue <a class="external" linkrewrite="false" href="http://tracker.adventure-php-framework.org/view.php?id=207">ID#207</a> wurde eine lange in
   der Code-Basis vorhandene Klassen-Design-Schwäche entfernt. Die Klasse <em>APFObject</em> ist nun nicht mehr für die
   Speicherung von XML-Tag-Attributen zuständig - dies wurde in die Klasse <em>Document</em> verschoben, denn diese
   repräsentiert einen APF-DOM-Knoten.
</p>
<p>
   Mit dieser Änderung geht auch eine Änderung der Klasse <em>FrontControllerInput</em> einher, die Action-Parameter nun
   in einem eigenen Feld speichert: <em>$this->parameters</em>.
</p>
<p>
   Um auf die neue Version zu aktualisieren, ersetzen Sie bitte alle Vorkommen in Klassen, die von
   <em>FrontControllerInput</em> ableiten wie folgt:
</p>
<table>
   <thead>
      <tr>
         <td>Bisheriger Name</td>
         <td>Neuer Name</td>
      </tr>
   </thead>
   <tbody>
      <tr>
         <td>(<em>APFObject</em>) $this->attributes</td>
         <td>(<em>FrontControllerInput</em>) $this->parameters</td>
      </tr>
      <tr>
         <td>FrontControllerInput::getAttribute()</td>
         <td>FrontControllerInput::getParameter()</td>
      </tr>
      <tr>
         <td>FrontControllerInput::getAttributes()</td>
         <td>FrontControllerInput::getParameters()</td>
      </tr>
      <tr>
         <td>FrontControllerInput::setAttribute()</td>
         <td>FrontControllerInput::setParameter()</td>
      </tr>
      <tr>
         <td>FrontControllerInput::setAttributes()</td>
         <td>FrontControllerInput::setParameters()</td>
      </tr>
      <tr>
         <td>FrontControllerInput::deleteAttribute()</td>
         <td>(mehr unterstützt)</td>
      </tr>
      <tr>
         <td>FrontControllerInput::addAttribute()</td>
         <td>(mehr unterstützt)</td>
      </tr>
   </tbody>
</table>

<h4 id="Chapter-3-2-APFObject"><a href="#Chapter-3-2-APFObject">3.2. APFObject</a></h4>
<p>
   Wie in <a href="#Chapter-3-1-Front-Controller">Kapitel 3.1</a> angesprochen wurde das Attribut-Handling wurde aus
   <em>APFObject</em> entfernt. Diese Änderung betrifft damit auch Klassen, die direkt von <em>APFObject</em> erben
   und z.B. bei der Implementierung von View-Models auf das <em>$this->attributes</em>-Feld zurückgreifen.
</p>
<p>
   Passen Sie beim Umstieg auf die neue Version bitte die relevanten Stellen an.
</p>

<h4 id="Chapter-3-3-Platzhalter"><a href="#Chapter-3-3-Platzhalter">3.3. Platzhalter</a></h4>
<p>
   Die Funktion des <em>&lt;html:placeholder /&gt;</em>-Tags im Inhaltsbereich eine eigene, vereinfachte Platzhalternotation
   nutzen zu können wurde in Release 3.0 entfernt.
</p>
<p>
   Finden Sie in Ihrem Projekt Code-Stellen wie
</p>
<gen:highlight type="apf-xml">
&lt;html:placeholder name="foo"&gt;This is a {bar} thing.&lt;/html:placeholder&gt
</gen:highlight>
<p>
   schreiben Sie diese bitte wie folgt um:
</p>
<gen:highlight type="apf-xml">
This is a &#36;{bar} thing.
</gen:highlight>
<p>
   Im Controller ändert sich die Verwendung des Platzhalters von bisher
</p>
<gen:highlight type="php">
$this->setStringPlaceHolder('foo', 'bar', '...');
</gen:highlight>
<p>
   auf
</p>
<gen:highlight type="php">
$this->setPlaceHolder('bar', '...');
</gen:highlight>

<h4 id="Chapter-3-4-Signatur-Aenderung-DateSelectorTag-TimeSelectorTag"><a href="#Chapter-3-4-Signatur-Aenderung-DateSelectorTag-TimeSelectorTag">3.4. Signatur-Änderung DateSelectorTag und TimeSelectorTag</a></h4>
<p>
   Mit der Umsetzung von <a class="external" linkrewrite="false" href="http://tracker.adventure-php-framework.org/view.php?id=208">ID#208</a>
   wurde die Signatur der Methoden <em>DateSelectorTag::getDate()</em> und <em>DateSelectorTag::setDate()</em> sowie
   <em>TimeSelectorTag::getTime()</em> und <em>TimeSelectorTag::setTime()</em> geändert.
</p>
<p>
   Die beiden Setter nehmen nun neben einem String auch eine Instanz der Klasse <em>DateTime</em> zur Initialisierung
   entgegen. Damit ist eine stärkere Typisierung der Daten in Ihrer Anwendung möglich.
</p>
<div class="hint">
   Das APF-Team empfiehlt beim Umstieg auf die Version 3.0 Datums- und Zeit-Werte in <em>DateTime</em>-Instanzen zu
   verpacken. Dies erleichtert nicht nur die Nutzung der beiden Tags, sondern sorgt für eine saubere Kapselung der
   Werte.
</div>
<p>
   Die Getter-Methoden geben ab der Version ausschließlich <em>DateTime</em>-Instanzen zurück. Dies erfordert im Gegensatz
   zu den Setter-Methoden eine Änderung Ihrer bestehenden Code-Basis. Sofern Sie bisher für das Auslesen und Verarbeiten
   eines <em>DateSelectorTag</em> den Code
</p>
<gen:highlight type="php">
$date = &$form->getFormElementByName('date-of-birth');
$sql = 'INSERT INTO ... SET ..., dob = `' . $date->getDate() . '`, ... ';
</gen:highlight>
<p>
   genutzt haben, muss dieser ab Version 3.0 wie folgt lauten:
</p>
<gen:highlight type="php">
$date = &$form->getFormElementByName('date-of-birth');
$sql = 'INSERT INTO ... SET ..., dob = `' . $date->getDate()->format('Y-m-d') . '`, ... ';
</gen:highlight>

<h4 id="Chapter-3-5-Neue-Request-Implementierung"><a href="#Chapter-3-5-Neue-Request-Implementierung">3.5. Neue Request-Implementierung</a></h4>
<p>
   Im Rahmen der Umsetzung von <a class="external" linkrewrite="false" href="http://tracker.adventure-php-framework.org/view.php?id=234">ID#234</a>
   wurden die Klassen <em>RequestHandler</em> und <em>HeaderManager</em> durch eine vollständig objektorientierte
   <em>Request</em>- und <em>Response</em>-Umsetzung für die Abstraktion der HTTP-Kommunikation ersetzt.
</p>
<p>
   Diese erleichtern die Implementierung und bieten einfache Methoden für gängige Aufgaben wie das Auslesen von
   Request-Inhalten, die Manipulation von HTTP-Antwort-Headern und die Weiterleitung auf andere URLs.
</p>
<p>
   Die Umstellung auf das neue Modell erfolgt weitestgehend durch die Ausführung der
   <a href="#Chapter-2-Automatisierte-Migration">automatisierten Migration</a>, einige Teile müssen jedoch manuell
   erledigt werden.
</p>
<p>
   Die folgenden Kapitel beschreiben die manuell vorzunehmenden Änderungen um auf die neue <em>Request</em>- und
   <em>Response</em>-Implementierung umzustellen.
</p>
<div class="hint">
   Hinweise zur Request-Verarbeitung im APF 3.0 finden Sie im Kapitel <int:link pageid="163" />.
</div>

<h4 id="Chapter-3-5-1-RequestHandler"><a href="#Chapter-3-5-1-RequestHandler">3.5.1. RequestHandler</a></h4>
<p>
   Die Klasse <em>RequestHandler</em> diente im APF bis Version 2.1 zur Abstraktion des Zugriffs auf die Inhalte der
   aktuellen Anfrage. Die darin enthaltenen Funktionalitäten sind nun vollständig in der Klasse <em>RequestImpl</em>
   enthalten.
</p>
<p>
   Bei der Migration werden die einfachen und auch häufigsten Fälle erfasst. Die Nutzung von <em>getValues()</em> kann
   auf Grund der Komplexität der Anwendung nicht automatisch umgestellt werden. Schreiben Sie daher alle Vorkommen der
   Methode von z.B.
</p>
<gen:highlight type="php">
$values = RequestHandler::getValues(array('page', 'sort' => 'asc'));
</gen:highlight>
<p>
   auf
</p>
<gen:highlight type="php">
$page = self::getRequest()->getParameter('page');
$sort = self::getRequest()->getParameter('sort', 'asc');
</gen:highlight>
<p>
   um. Alternativ lässt sich folgende Implementierung nutzen, die den Eingriff in den Code Ihrer bestehenden Anwendung
   gering hält:
</p>
<gen:highlight type="php">
$values = array();
$request = self::getRequest();
foreach (array('page', 'sort' => 'asc') as $name => $default) {
   if (is_integer($name)) {
      $values[$default] = $request->getParameter($default);
   } else {
      $values[$name] = $request->getParameter($name, $default);
   }
}
</gen:highlight>

<h4 id="Chapter-3-5-2-HeaderManager"><a href="#Chapter-3-5-2-HeaderManager">3.5.2. HeaderManager</a></h4>
<p>
   Mit Hilfe der Klasse <em>HeaderManager</em> ließen sich im APF bis Version 2.1 die HTTP-Header der Antwort
   manipulieren und Benutzer zu generierten URLs weiter leiten. Die darin enthaltenen Funktionalitäten sind nun
   vollständig in der Klasse <em>ResponseImpl</em> aufgegangen.
</p>
<p>
   Die Migration des <em>HeaderManager</em> auf die neuen Funktionen lässt sich größtenteils automatisiert erledigen.
   Eine Ausnahme bilden Front-Controller-Actions, die in der Regel umfassende Manipulationen der Antwort vornehmen. Aus
   diesem Grund bitten wir Sie, Actions nach der Migration nochmals genauerer unter die Lupe zu nehmen.
</p>
<p>
   Code-Blöcke wie z.B.
</p>
<gen:highlight type="php">
HeaderManager::send('Content-Type: application/json');
echo json_encode(array(
      'headline'    => $news->getHeadline(),
      'subheadline' => $news->getSubHeadline(),
      'content'     => $news->getContent(),
      'newscount'   => $news->getNewsCount()
));

exit(0);
</gen:highlight>
<p>
   werden von der automatisieren Migration zu
</p>
<gen:highlight type="php">
self::getResponse()->setHeader(new HeaderImpl('Content-Type', 'application/json'));
echo json_encode(array(
      'headline'    => $news->getHeadline(),
      'subheadline' => $news->getSubHeadline(),
      'content'     => $news->getContent(),
      'newscount'   => $news->getNewsCount()
));

exit(0);
</gen:highlight>
<p>
   umgeschrieben. Dies führt dazu, dass der gesendete <em>Content-Type</em>-Header nicht beim Browser ankommt, da die
   <em>ResponseImpl</em>-Instanz nicht mit zurück gesendet wird. Ändern Sie den Code daher manuell wie folgt ab:
</p>
<gen:highlight type="php">
$response = self::getResponse();
$response->setHeader(new HeaderImpl('Content-Type', 'application/json'));

$response->setBody(json_encode(array(
      'headline'    => $news->getHeadline(),
      'subheadline' => $news->getSubHeadline(),
      'content'     => $news->getContent(),
      'newscount'   => $news->getNewsCount()
)));

$response->send();
</gen:highlight>

<h4 id="Chapter-3-6-Interface-Aenderung-Konfiguration"><a href="#Chapter-3-6-Interface-Aenderung-Konfiguration">3.6. Interface-Änderung Konfiguration</a></h4>
<p>
   Im Rahmen der Umsetzung von Issue <a class="external" linkrewrite="false" href="http://tracker.adventure-php-framework.org/view.php?id=224">ID#224</a>
   wurde das Interface <em>Configuration</em> dahingehend geändert, dass die Methode <em>getSection()</em> unter allen
   Umständen eine Instanz einer <em>Configuration</em>-Implementierung zurück liefert. Dies hilft auf sehr effektive
   Weise <em>Null Pointer Exceptions</em> zu vermeiden und damit den Code für den Betrieb sicherer zu gestalten.
</p>
<p>
   Mit der Änderung wurde die Methode <em>hasSection()</em> eingeführt, die erlaubt das Vorhandensein einer Sektion
   abzufragen.
</p>
<p>
   Um Ihre Applikation mit Version 3.0 fachlich korrekt betreiben zu können ist eine Änderung der Implementierung -
   speziell bei den Prüfungen auf Vorhandensein einer Sektion - notwendig. Haben Sie bisher Code-Schnipsel wie
</p>
<gen:highlight type="php">
if ($config->getSection($this->getLanguage()) !== null) {
   ...
} else {
   ...
}
</gen:highlight>
<p>
   in Ihrer Applikation genutzt, so sind siese wie folgt umzuschreiben:
</p>
<gen:highlight type="php">
if ($config->hasSection($this->getLanguage())) {
   ...
} else {
   ...
}
</gen:highlight>

<h4 id="Chapter-3-7-ServiceManager-API"><a href="#Chapter-3-7-ServiceManager-API">3.7. ServiceManager API</a></h4>
<p>
   APF 3.0 führt das Konzept der <em>constructor injection</em> zur <int:link pageid="030" /> und <int:link pageid="107" />
   ein. Dies erleichtert die Erzeugung und gleichzeitige Initialisierung von Objekten und ermöglicht, Abhängigkeiten
   direkt im Konstruktor auszurücken.
</p>
<p>
   Die automatisierte Migration erfasst bereits alle Aufrufe von <em>APFObject::getServiceObject()</em> die Aufrufe
   von <em>ServiceManager::getServiceObject()</em> werden allerdings nicht abgedeckt. Bitte prüfen Sie Ihre Applikation,
   ob die Methode genutzt wird und aktualisieren Sie beispielsweise die Code-Stelle
</p>
<gen:highlight type="php">
$model = & ServiceManager::getServiceObject(
      'CMS\core\biz\CMSModel',
      $context,
      'de',
      APFService::SERVICE_TYPE_SESSION_SINGLETON
);
</gen:highlight>
<p>
   zu
</p>
<gen:highlight type="php">
$model = & ServiceManager::getServiceObject(
      'CMS\core\biz\CMSModel',
      $context,
      'de',
      [],
      APFService::SERVICE_TYPE_SESSION_SINGLETON
);
</gen:highlight>
<p>
   ab.
</p>
<div class="warn">
   Bitte beachten Sie zudem, dass die als veraltet gekennzeichneten Methoden <em>APFObject::getAndInitServiceObject()</em>
   und <em>ServiceManager::getAndInitServiceObject()</em> entfernt wurden. Nutzen Sie statt dessen bitte die unter
   <int:link pageid="030" /> und <int:link pageid="107" /> beschriebenen Möglichkeiten.
</div>

<h3 id="Chapter-4-FAQ"><a href="#Chapter-4-FAQ">4. FAQ</a></h3>
<p>
   Die folgenden Kapitel beinhalten häufig auftretende Fehler und mögliche Lösungen:
</p>

<h4 id="Chapter-4-1-Fehlende-Tag-Registrierung"><a href="#Chapter-4-1-Fehlende-Tag-Registrierung">4.1. Fehlende Tag-Registrierung</a></h4>
<h5 id="Chapter-4-1-1-Frage"><a href="#Chapter-4-1-1-Frage">Frage</a></h5>
<p>
   Beim Aufruf einer Seite tritt folgender Fehler auf:
</p>
<gen:highlight type="code">
Fatal error: Uncaught exception
'APF\core\pagecontroller\ParserException' with message ' in ***/APF/core/pagecontroller/Document.php on line
1037 APF\core\pagecontroller\ParserException: No tag definition found for prefix "template" and name
"placeholder" in document with type "APF\core\pagecontroller\TemplateTag"! Template code: [..]
</gen:highlight>

<h5 id="Chapter-4-1-2-Antwort"><a href="#Chapter-4-1-2-Antwort">Antwort</a></h5>
<p>
   Migrations-Skript wurde noch nicht ausgeführt oder der Tag wurde im aktuellen Projekt (noch) nicht registriert.
   Bitte füge Sie ein <em>&lt;core:addtaglib /&gt;</em> zu Ihrem Template hinzu oder registrieren den Tag in der
   <em>index.php</em> via <em>Document::addTagLib(...);</em>.
</p>

<h4 id="Chapter-4-2-Altes-Platzhalter-Format"><a href="#Chapter-4-2-Altes-Platzhalter-Format">4.2. Altes Platzhalter-Format</a></h4>
<h5 id="Chapter-4-2-1-Frage"><a href="#Chapter-4-2-1-Frage">Frage</a></h5>
<p>
   Beim Aufruf der Seite tritt folgender Fehler auf:
</p>
<gen:highlight type="code">
No closing tag found for tag &lt;html:placeholder /&gt;!
Template code: &lt;html:placeholder name="anchor"&gt;
&lt;a href="{URL}" title="{TITLE}" class="breadcrumb {CLASSES}" >{TEXT}&lt;/a&gt;&lt;/template:placeholder&gt;
</gen:highlight>

<h5 id="Chapter-4-2-2-Antwort"><a href="#Chapter-4-2-2-Antwort">Antwort</a></h5>
<p>
   Die Verwendung von <em>String Placeholdern</em> ist in Version 3.0 nicht mehr vorhanden. Lösen Sie diese bitte wie
   in <a href="#Chapter-3-3-Platzhalter">Kapitel 3.3</a> beschrieben auf. Für die vorliegende Fehlermeldung ist folgende
   Lösung möglich:
</p>
<gen:highlight type="apf-xml">
&lt;a href="&#36;{URL}" title="&#36;{TITLE}" class="breadcrumb &#36;{CLASSES}"&gt;&#36;{TEXT}&lt;/a&gt;
</gen:highlight>
<p>
   Bitte beachten Sie, dass der zugehörige Controller ebenfalls angepasst werden muss.
</p>

<h3 id="Chapter-5-Weitere-Optimierungen"><a href="#Chapter-5-Weitere-Optimierungen">5. Weitere Optimierungen</a></h3>
<p>
   Tipps für den Umstieg auf Version 3.0 und Vorschläge zur Optimierung Ihrer Anwendung finden Sie im Artikel
   <int:link pageid="158" />.
</p>

<core:importdesign namespace="APF\modules\comments\pres\templates" template="comment" categorykey="de_159" />