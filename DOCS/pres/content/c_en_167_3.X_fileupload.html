<doku:title parent="167" tags="upload,fileupload,filemanagement,explorer,files,player,jquery" title="FileUpload" urlname="FileUpload">
    You can upload, manage and delete files on your server withe the APF-FileUpload extension.
</doku:title>

<h3 id="Chapter-1-Einleitung"><a href="#Chapter-1-Einleitung">1. Introduction</a></h3>
<p>
    The <em>FileUpload</em> is an easy and convenient way to manage and upload files to your webspace. The core of the
    APF extension is the jQuery plugin "jQuery-File-Upload" in use with the PHP component
    "UploadHandler". For more information, see the developer page of the plugin at
    <a linkrewrite="false" class="external" href="https://github.com/blueimp/jQuery-File-Upload">https://github.com/blueimp/jQuery-File-Upload</a>.
    Read the following about how to setup and use the extension.
</p>
<div class="warn">
    File uploads are always a security risk! Therefore, make sure that the uploaded files are in a seperately protected
    area of your webspace. You can find useful information about security here:
    <a linkrewrite="false" class="external" href="https://github.com/blueimp/jQuery-File-Upload/wiki/Security">https://github.com/blueimp/jQuery-File-Upload/wiki/Security</a>.
</div>

<h3 id="Chapter-2-Vorraussetzungen"><a href="#Chapter-2-Vorraussetzungen">2. Requirements</a></h3>
<p>
    As mentioned in the introduction, the<em> FileUpload</em> is based on the jQuery plugin "jQuery-file-upload". This
    plugin is no part of the APF and must be manually installed by the developer. Please read one possible procedure.
</p>
<div class="hint">
    The version of the plugin was version 9.17.0 when this documentation was written. In the course of time the version
    could have changed. However, the procedure for installation remains the same. If changes are necessary, these are
    marked acoordingly.
</div>

<h4 id="Chapter-2-1-Plugin-installieren"><a href="#Chapter-2-1-Plugin-installieren">2.1. Install jQuery-plugin</a></h4>
<p>
    You need all JS and CSS files of the plugin. You can find these files on the developer page of the plugin at
    <a linkrewrite="false" class="external" href="https://github.com/blueimp/jQuery-File-Upload">https://github.com/blueimp/jQuery-File-Upload</a>.
    Alternatively you can also download the complete plugin of the master branch via the following link as ZIP package:
    <a linkrewrite="false" class="external" href="https://github.com/blueimp/jQuery-File-Upload/archive/master.zip">https://github.com/blueimp/jQuery-File-Upload/archive/master.zip</a>.
    Open and unzip the ZIP package in a direction of your choice. You will now need all CSS files from the directory "css"
    and all JS files from the directory "js" including all subfolders and files. Copy the files/folders and paste them
    into the APF directory under
</p>
<gen:highlight type="code">
    APF/extensions/fileupload/pres
</gen:highlight>
<p>
    Your APF directory "fileupload/pres" should look like this:
</p>
<gen:highlight type="code">
    APF/extensions/fileupload/pres
       - css
       - js
          - cors
       - taglib
       - templates
</gen:highlight>

<h4 id="Chapter-2-2-UploadHandler"><a href="#Chapter-2-2-UploadHandler">2.2. Install UploadHandler </a></h4>
<p>
    The upload handler of the plugin provides a mature, secure, and advanced class to handle the uploaded files. This
    class is also not delivered by APF and must be manually installed by the developer.
</p>

<h5 id="Chapter-2-2-1-UploadHandler-install"><a href="#Chapter-2-2-1-UploadHandler-install">2.2.1. Install UploadHandler</a></h5>
<p>
    You can find the desired class under the followink URL:
    <a linkrewrite="false" class="external" href="https://github.com/blueimp/jQuery-File-Upload/blob/master/server/php/UploadHandler.php">https://github.com/blueimp/jQuery-File-Upload/blob/master/server/php/UploadHandler.php</a>.
    You can also find the file in the previously downloaded ZIP package in the directory "server/php". Copy the file
    "UploadHandler.php" and paste it into the APF directory
</p>
<gen:highlight type="code">
    APF/extensions/fileupload/biz
</gen:highlight>
<p>
    The directory "APF/extensions/fileupload/biz" should contain now two files:
</p>
<gen:highlight type="code">
    UploadHandler.php
    FileUploadHandler.php
</gen:highlight>

<h5 id="Chapter-2-2-2-UploadHandler-edit"><a href="#Chapter-2-2-2-UploadHandler-edit">2.2.2. Edit UploadHandler</a></h5>
<p>
    To be able to use the UploadHandler class with the APF, some small adjustments are necessary. Open the file
    "UploadHandler.php" in your editor. Add the <em>namespace</ em> by placing the following line after the opening
    "php" tag:
</p>
<gen:highlight type="php">
    namespace APF\extensions\fileupload\biz;
</gen:highlight>
<p>
    The <em>UploadHandler</ em> class must inherit from APF-Object. For this just add "extends APFObject" during
    initialization of the class:
</p>
<gen:highlight type="php">
    use APF\core\pagecontroller\APFObject;

    class UploadHandler extends APFObject
    {
       ..
       ..
       ..
</gen:highlight>
<p>
    The APF-Object must, of course, be made known beforehand. Just use the "use" command as already shown in the above
    code snippet.
    For the sake of completeness, you will find the complete head of the class "UploadHandler" with the changes made:
</p>
<gen:highlight type="php">
    namespace APF\extensions\fileupload\biz;

    /*
     * jQuery File Upload Plugin PHP Class
     * https://github.com/blueimp/jQuery-File-Upload
     *
     * Copyright 2010, Sebastian Tschan
     * https://blueimp.net
     *
     * Licensed under the MIT license:
     * http://www.opensource.org/licenses/MIT
     */

    use APF\core\pagecontroller\APFObject;

    class UploadHandler extends APFObject
    {
       ..
       ..
       ..
</gen:highlight>

<h5 id="Chapter-2-2-3-UploadHandler-Bootstrap"><a href="#Chapter-2-2-3-UploadHandler-Bootstrap">2.2.3. Register UploadHandler</a></h5>
<p>
    In the next step, the class "UploadHandler" must be loaded via the bootstrap of your application (index.php). This
    is done via the <em>RootClassLoader</em> with the following line:
</p>
<gen:highlight type="php">
    use APF\core\loader\RootClassLoader;
    use APF\core\loader\StandardClassLoader;

    $dir = dirname($_SERVER['SCRIPT_FILENAME']);
    RootClassLoader::addLoader(new StandardClassLoader('UploadHandler', $dir . 'APF/extensions/fileupload/biz'));
</gen:highlight>
<p>
    The prerequisites are now fulfilled and you can complete the configuration.
</p>

<h3 id="Chapter-3-Konfiguration"><a href="#Chapter-3-Konfiguration">3. Configuration</a></h3>
<div class="hint">
    The "UploadHandler" can be configured in addition to the<em> FileUpload</em>. Both configurations are summarized.
    This is certainly only possible via a PHP configuration. Therefore, only a PHP configuration is allowed.
    For more information, please refer to chapter "3.6. PHP Provider" under <int:link pageid="134" />.
</div>
<p>
    If you have not yet registered a PHP configuration provider, this is necessary in the bootstrap (index.php):
</p>
<gen:highlight type="php">
    use APF\core\configuration\ConfigurationManager;
    use APF\core\configuration\provider\php\PhpConfigurationProvider;

    ConfigurationManager::registerProvider('php', new PhpConfigurationProvider());
</gen:highlight>
<p>
    Using this code snippet, the following PHP configuration can be used without any problems.
</p>

<h4 id="Chapter-3-1-Konfiguration-Beispiel"><a href="#Chapter-3-1-Konfiguration-Beispiel">3.1. Example configuration</a></h4>
<p>
    We have prepared a sample configuration for you. These can be found below and in the end a few additional words. For
    all details concerning the "UploadHandler", please read the documentation on the developer page:
    <a linkrewrite="false" class="external" href="https://github.com/blueimp/jQuery-File-Upload/wiki">https://github.com/blueimp/jQuery-File-Upload/wiki</a>.
</p>
<gen:highlight type="php">
    return [
        'imagemp3' => [

            // APF-Configuration
            'UploadPath' => 'fileupload',
            'randomize' => true,          // set to true will rename all files with PHP-uniqueid()-function

            // next 3 parameters are rewritten by script! Use only parameter 'UploadPath' to edit them!!
            // 'script_url' => $this->get_full_url().'/'.$this->basename($this->get_server_var('SCRIPT_NAME')),
            // 'upload_dir' => dirname($this->get_server_var('SCRIPT_FILENAME')).'/files/',
            // 'upload_url' => $this->get_full_url().'/files/',

            // UploadHandler-Configuration
            'input_stream' => 'php://input',
            'user_dirs' => false,
            'mkdir_mode' => 0755,
            'param_name' => 'files',
            // Set the following option to 'POST', if your server does not support
            // DELETE requests. This is a parameter sent to the client:
            'delete_type' => 'DELETE',
            'access_control_allow_origin' => '*',
            'access_control_allow_credentials' => false,
            'access_control_allow_methods' => [
                'OPTIONS',
                'HEAD',
                'GET',
                'POST',
                'PUT',
                'PATCH',
                'DELETE'
            ],
            'access_control_allow_headers' =>[
                'Content-Type',
                'Content-Range',
                'Content-Disposition'
            ],
            // By default, allow redirects to the referer protocol+host:
            // currently not working with APF!!
            /*
            'redirect_allow_target' => '/^'.preg_quote(
                parse_url($this->get_server_var('HTTP_REFERER'), PHP_URL_SCHEME)
                .'://'
                .parse_url($this->get_server_var('HTTP_REFERER'), PHP_URL_HOST)
                .'/', // Trailing slash to not match subdomains by mistake
                '/' // preg_quote delimiter param
                ).'/',
            */
            // Enable to provide file downloads via GET requests to the PHP script:
            //     1. Set to 1 to download files via readfile method through PHP
            //     2. Set to 2 to send a X-Sendfile header for lighttpd/Apache
            //     3. Set to 3 to send a X-Accel-Redirect header for nginx
            // If set to 2 or 3, adjust the upload_url option to the base path of
            // the redirect parameter, e.g. '/files/'.
            'download_via_php' => false,
            // Read files in chunks to avoid memory limits when download_via_php
            // is enabled, set to 0 to disable chunked reading of files:
            'readfile_chunk_size' => 10 * 1024 * 1024, // 10 MiB
            // Defines which files can be displayed inline when downloaded:
            'inline_file_types' => '/\.(gif|jpe?g|png)$/i',
            // Defines which files (based on their names) are accepted for upload:
            'accept_file_types' => '/\.(gif|jpe?g|png|mp3)$/i',                           // '/.+$/i' -> all files are allowed
            // The php.ini settings upload_max_filesize and post_max_size
            // take precedence over the following max_file_size setting:
            'max_file_size' => 9999000,
            'min_file_size' => 1,
            // The maximum number of files for the upload directory:
            'max_number_of_files' => null,
            // Defines which files are handled as image files:
            'image_file_types' => '/\.(gif|jpe?g|png)$/i',
            // Use exif_imagetype on all files to correct file extensions:
            'correct_image_extensions' => false,
            // Image resolution restrictions:
            'max_width' => null,
            'max_height' => null,
            'min_width' => 1,
            'min_height' => 1,
            // Set the following option to false to enable resumable uploads:
            'discard_aborted_uploads' => true,
            // Set to 0 to use the GD library to scale and orient images,
            // set to 1 to use imagick (if installed, falls back to GD),
            // set to 2 to use the ImageMagick convert binary directly:
            'image_library' => 1,
            // Uncomment the following to define an array of resource limits
            // for imagick:
            /*
            'imagick_resource_limits' => [
                imagick::RESOURCETYPE_MAP => 32,
                imagick::RESOURCETYPE_MEMORY => 32
            ],
            */
            // Command or path for to the ImageMagick convert binary:
            'convert_bin' => 'convert',
            // Uncomment the following to add parameters in front of each
            // ImageMagick convert call (the limit constraints seem only
            // to have an effect if put in front):
            /*
            'convert_params' => '-limit memory 32MiB -limit map 32MiB',
            */
            // Command or path for to the ImageMagick identify binary:
            'identify_bin' => 'identify',
            'image_versions' => [
                // The empty image version key defines options for the original image:
                '' => [
                    // Automatically rotate images based on EXIF meta data:
                    'auto_orient' => true
                ],
                // Uncomment the following to create medium sized images:
                /*
                'medium' => [
                    'max_width' => 800,
                    'max_height' => 600
                ],
                */
                'thumbnail' => [
                    // Uncomment the following to use a defined directory for the thumbnails
                    // instead of a subdirectory based on the version identifier.
                    // Make sure that this directory doesn't allow execution of files if you
                    // don't pose any restrictions on the type of uploaded files, e.g. by
                    // copying the .htaccess file from the files directory for Apache:
                    //'upload_dir' => dirname($this->get_server_var('SCRIPT_FILENAME')).'/thumb/',
                    //'upload_url' => $this->get_full_url().'/thumb/',
                    // Uncomment the following to force the max
                    // dimensions and e.g. create square thumbnails:
                    //'crop' => true,
                    'max_width' => 80,
                    'max_height' => 80
                ]
            ],
            'print_response' => true
        ]
    ];
</gen:highlight>
<p>
    You can create different configurations for different applications. The <em>FileUpload</em> tag is designed to use
    the associated configuration, depending on the defined "name" attribute. In the example, a <em>FileUpload</em> tag
    was created with the name "imagemp3". From this, it should be possible to upload pictures and MP3 files.
    Some explanations to the parameters:
</p>
<ul>
    <li>
        <strong>UploadPath</strong>: Destination directory for storing the files. The directory is outgoing from the
        root directory of your application, where is also your bootstrap file (index.php) located.
    </li>
    <li>
        <strong>randomize</strong>: If set to "true", the filenames are renamed with the PHP function "uniqueid()"
        after the upload process in order to make them more difficult to find.
    </li>
    <li>
        <strong>accept_file_types</strong>: This is a configuration option of the "UploadHandler". This parameter can
        be used to define permitted file types.
    </li>
    <li>
        <strong>max_file_size</strong>: This is a configuration option of the "UploadHandler". This parameter isd used
        to define the permitted file size. Please note that this setting can not override the php.ini settings
        "upload_max_filesize" and "post_max_size".
    </li>
    <li>
        <strong>image_versions</strong>: This is a configuration option of the "UploadHandler". With this image files
        can be changed in their resolution on the server and preview images can be generated automatically.
    </li>
</ul>

<h3 id="Chapter-4-Taglib"><a href="#Chapter-4-Taglib">4. FileUpload-Taglib</a></h3>
<p>
    The <em>FileUpload</em> extension also provides an own taglib, which you can use in your templates. Just use the
    following tag definition:
</p>
<gen:highlight type="apf-xml">
    &lt;core:addtaglib class="APF\extensions\fileupload\pres\taglib\FileUploadTag" prefix="form" name="fileupload" /&gt;
    &lt;form:fileupload name="imagemp3[]" id="fileupload" /&gt;
</gen:highlight>
<p>
    As described in chapter 3.1. Example configuration, the "name" attribute of the tag is used to define which
    configuration to use.
    The HTML element is announced due the "id" attribute to manipulate it by the jQuery plugin and to design it by the
    cascading style sheets. Ensure that you always specify the correct id if you want to use features of the plugin
    that differ from the standard. The "name" attribute is only necessary by the APF.
    Required JavaScript is automatically injected into the document by the Taglib through the "HtmlHeaderManager".
    Please note that you have configured the "HtmlHeaderManager" and set the required "gethead" tag in your template.
    All references to the "HtmlHeaderManager" can be found here: <a class="wiki" href="http://wiki.adventure-php-framework.org/Html-Header_Erweiterung" title="Html-Header Erweiterung im Wiki">Html-Header Erweiterung im Wiki</a>
</p>

<h3 id="Chapter-5-Bespiele"><a href="#Chapter-5-Bespiele">5. Examples</a></h3>
<p>
    When the APF has been delivered, you have already received three examples which are already fully usable.
    These examples can be found in the "templates" folder and are named "basic.html", "basic-plus.html" and
    "extended.html".
</p>
<ul>
    <li>
        <strong>basic</strong>: Simple file upload with progress bar, without preview.
    </li>
    <li>
        <strong>basic-plus</strong>: Easy file upload with cancel and preview function.
    </li>
    <li>
        <strong>extended</strong>: File upload with preview function of images, videos and sounds, cancel function,
        delete function as well as integrated queue. The number of simultaneous uploads is defined in the configuration.
    </li>
</ul>
<p>
    For the preview functions additional jQuery plugins are needed, which do not belong to the "jQuery file upload". You
    will find all the details in the included templates.
</p>

<core:importdesign namespace="APF\modules\comments\pres\templates" template="comment" categorykey="de_167" />