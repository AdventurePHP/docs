<doku:title parent="167" tags="upload,hochladen,fileupload,dateiverwaltung,explorer,dateien,player,jquery" title="FileUpload" urlname="FileUpload">
    Mit dem APF-FileUpload lassen sich bequem Datein hochladen, verwalten und löschen.
</doku:title>

<h3 id="Chapter-1-Einleitung"><a href="#Chapter-1-Einleitung">1. Einleitung</a></h3>
<p>
    Über den <em>FileUpload</em> lassen sich bequem und komfortabel Datein auf dem Webspeicher verwalten und hochladen.
    Den Kern der APF-Erweiterung bildet das jQuery-Plugin "jQuery-File-Upload" in Verbindung mit der PHP-Komponente
    "UploadHandler". Weitere Informationen hierzu finden sie auf der Entwickler-Seite des Plugins unter
    <a linkrewrite="false" class="external" href="https://github.com/blueimp/jQuery-File-Upload">https://github.com/blueimp/jQuery-File-Upload</a> (Englisch).
    Lesen Sie im Nachfolgenden, wie Sie die Erweiterung bei sich einrichten und nutzen können.
</p>
<div class="warn">
    Datei-Uploads stellen immer ein Sicherheitsrisiko dar! Stellen Sie daher sicher, dass die hochgeladenen Dateien in
    einem seperat geschützten Bereich des Webservers gespeichert werden. Hilfreiche Informationen dazu finden Sie hier:
    <a linkrewrite="false" class="external" href="https://github.com/blueimp/jQuery-File-Upload/wiki/Security">https://github.com/blueimp/jQuery-File-Upload/wiki/Security</a> (Englisch).
</div>

<h3 id="Chapter-2-Vorraussetzungen"><a href="#Chapter-2-Vorraussetzungen">2. Vorraussetzungen</a></h3>
<p>
    Wie bereits in der Einleitung erwähnt basiert der <em>FileUpload</em> auf dem jQuery-Plugin "jQuery-File-Upload". Dieses
    Plugin ist kein Bestandteil des APF und muss vom Entwickler manuell installiert werden. Lesen Sie im Nachfolgenden
    eine mögliche Vorgehensweise.
</p>
<div class="hint">
    Die Version des Plugins war bei Erstellung dieser Dokumentation die Version 9.17.0. Im Laufe der Zeit kann sich die
    Version bereits geändert haben. Die Vorgehensweise zur Installation bleibt allerdings identisch. Sollten sich
    Änderungen ergeben, werden diese entsprechend vermerkt.
</div>

<h4 id="Chapter-2-1-Plugin-installieren"><a href="#Chapter-2-1-Plugin-installieren">2.1. jQuery-Plugin installieren</a></h4>
<p>
    Sie benötigen alle JS und CSS Dateien des Plugins. Diese finden Sie auf der Entwickler-Seite des Plugins unter
    <a linkrewrite="false" class="external" href="https://github.com/blueimp/jQuery-File-Upload">https://github.com/blueimp/jQuery-File-Upload</a> (Englisch).
    Alternativ können Sie auch das komplette Plugin des master-Branches über folgenden Link im ZIP-Format herunter laden:
    <a linkrewrite="false" class="external" href="https://github.com/blueimp/jQuery-File-Upload/archive/master.zip">https://github.com/blueimp/jQuery-File-Upload/archive/master.zip</a>.
    Öffnen und entpacken Sie das ZIP in ein Verzeichnis Ihrer Wahl. Sie benötigen nun daraus jeweils alle CSS-Dateien aus
    dem Verzeichnis "css" und alle JS-Dateien aus dem Verzeichnis "js" inklusive Unterordner und Dateien.
    Kopieren Sie die Dateien/Ordner und fügen Sie sie im APF-Verzeichnis unter
</p>
<gen:highlight type="code">
    APF/extensions/fileupload/pres
</gen:highlight>
<p>
    ein.
    Ihr APF-Verzeichnis "fileupload/pres" sollte jetzt so aussehen:
</p>
<gen:highlight type="code">
    APF/extensions/fileupload/pres
       - css
       - js
          - cors
       - taglib
       - templates
</gen:highlight>

<h4 id="Chapter-2-2-UploadHandler"><a href="#Chapter-2-2-UploadHandler">2.2. UploadHandler installieren</a></h4>
<p>
    Der Upload-Handler des Plugins bietet uns eine ausgereifte, sichere und fortschrittliche Klasse, die hochgeladenen
    Dateien zu behandeln. Diese Klasse wird nicht über das APF ausgeliefert und muss ebenfalls vom Entwickler manuell
    installiert werden.
</p>

<h5 id="Chapter-2-2-1-UploadHandler-install"><a href="#Chapter-2-2-1-UploadHandler-install">2.2.1. UploadHandler installieren</a></h5>
<p>
    Die notwendige Klasse finden Sie unter folgender Adresse:
    <a linkrewrite="false" class="external" href="https://github.com/blueimp/jQuery-File-Upload/blob/master/server/php/UploadHandler.php">https://github.com/blueimp/jQuery-File-Upload/blob/master/server/php/UploadHandler.php</a>.
    Sie finden die Datei aber auch in dem zuvor herunter geladenen ZIP-Paket in dem Verzeichnis "server/php". Kopieren
    Sie die Datei "UploadHandler.php" und fügen Sie sie in das APF-Verzeichnis
</p>
<gen:highlight type="code">
    APF/extensions/fileupload/biz
</gen:highlight>
<p>
    ein.
    Das Verzeichnis "APF/extensions/fileupload/biz" sollte nun zwei Dateien beinhalten:
</p>
<gen:highlight type="code">
    UploadHandler.php
    FileUploadHandler.php
</gen:highlight>

<h5 id="Chapter-2-2-2-UploadHandler-edit"><a href="#Chapter-2-2-2-UploadHandler-edit">2.2.2. UploadHandler bearbeiten</a></h5>
<p>
    Um die UploadHandler-Klasse mit dem APF nutzen zu können, sind einige kleine Anpassungen notwendig. Öffnen Sie dazu
    die Datei "UploadHandler.php" in Ihrem Editor.
    Ergänzen Sie den <em>namespace</em> indem Sie die folgende Zeile nach dem öffnenden "php"-Tag platzieren:
</p>
<gen:highlight type="php">
    namespace APF\extensions\fileupload\biz;
</gen:highlight>
<p>
    Die Klasse <em>UploadHandler</em> muss vom APF-Object erben. Ergänzen Sie dazu einfach "extends APFObject" während
    der Initialisierung der Klasse:
</p>
<gen:highlight type="php">
    use APF\core\pagecontroller\APFObject;

    class UploadHandler extends APFObject
    {
       ..
       ..
       ..
</gen:highlight>
<p>
    Das APF-Object muss natürlich zuvor noch bekannt gemacht werden. Nutzen Sie dafür einfach den bereits im obigen
    Code-Schnipsel gezeigten "use"-Befehl.
    Der Vollständigkeit halber finden Sie nochmals den vollständigen Kopf der Klasse "UploadHandler" mit den getätigten
    Änderungen:
</p>
<gen:highlight type="php">
    namespace APF\extensions\fileupload\biz;

    /*
     * jQuery File Upload Plugin PHP Class
     * https://github.com/blueimp/jQuery-File-Upload
     *
     * Copyright 2010, Sebastian Tschan
     * https://blueimp.net
     *
     * Licensed under the MIT license:
     * http://www.opensource.org/licenses/MIT
     */

    use APF\core\pagecontroller\APFObject;

    class UploadHandler extends APFObject
    {
       ..
       ..
       ..
</gen:highlight>

<h5 id="Chapter-2-2-3-UploadHandler-Bootstrap"><a href="#Chapter-2-2-3-UploadHandler-Bootstrap">2.2.3. UploadHandler registrieren</a></h5>
<p>
    Im nächsten Schritt muss die Klasse "UploadHandler" über die Bootstrap Ihrer Anwednung (index.php) geladen werden.
    Dies erfolgt über den <em>RootClassLoader</em> mit folgender Zeile:
</p>
<gen:highlight type="php">
    use APF\core\loader\RootClassLoader;
    use APF\core\loader\StandardClassLoader;

    $dir = dirname($_SERVER['SCRIPT_FILENAME']);
    RootClassLoader::addLoader(new StandardClassLoader('UploadHandler', $dir . 'APF/extensions/fileupload/biz'));
</gen:highlight>
<p>
    Die Vorraussetzungen sind damit erfüllt und Sie können die Konfiguration vornehmen.
</p>

<h3 id="Chapter-3-Konfiguration"><a href="#Chapter-3-Konfiguration">3. Konfiguration</a></h3>
<div class="hint">
    Der "UploadHandler" kann neben dem <em>FileUpload</em> zusätzlich konfiguriert werden. Beide Konfigurationen sind zusammen
    gefasst. Dies lässt sicher allerdings nur über eine PHP-Konfiguration bewerkstelligen. Es ist daher nur eine
    Konfiguration im PHP-Format zulässig. Weitere Informationen erhalten Sie im Kapitel "3.6. PHP Provider" unter
    <int:link pageid="134" />.
</div>
<p>
    Wenn Sie noch keinen PHP-Konfigurations-Provider registriert haben, ist dies zunächst in der Bootstrap (index.php)
    notwendig:
</p>
<gen:highlight type="php">
    use APF\core\configuration\ConfigurationManager;
    use APF\core\configuration\provider\php\PhpConfigurationProvider;

    ConfigurationManager::registerProvider('php', new PhpConfigurationProvider());
</gen:highlight>
<p>
    Anhand dieses Code-Schnipsels kann die anschliessende PHP-Konfiguration problemlos genutzt werden.
</p>

<h4 id="Chapter-3-1-Konfiguration-Beispiel"><a href="#Chapter-3-1-Konfiguration-Beispiel">3.1. Beispiel-Konfiguration</a></h4>
<p>
    Wir haben eine Beispiel-Konfiguration für Sie vorbereitet. Diese finden Sie nachfolgend und am Ende ein paar
    ergänzende Worte. Für alle Details, die speziell den "UploadHandler" betreffen, konsultieren Sie bitte die
    Dokumentation auf der Entwickler-Seite:
    <a linkrewrite="false" class="external" href="https://github.com/blueimp/jQuery-File-Upload/wiki">https://github.com/blueimp/jQuery-File-Upload/wiki</a> (Englisch).
</p>
<gen:highlight type="php">
    return [
        'imagemp3' => [

            // APF-Configuration
            'UploadPath' => 'fileupload',
            'randomize' => true,          // set to true will rename all files with PHP-uniqueid()-function

            // next 3 parameters are rewritten by script! Use only parameter 'UploadPath' to edit them!!
            // 'script_url' => $this->get_full_url().'/'.$this->basename($this->get_server_var('SCRIPT_NAME')),
            // 'upload_dir' => dirname($this->get_server_var('SCRIPT_FILENAME')).'/files/',
            // 'upload_url' => $this->get_full_url().'/files/',

            // UploadHandler-Configuration
            'input_stream' => 'php://input',
            'user_dirs' => false,
            'mkdir_mode' => 0755,
            'param_name' => 'files',
            // Set the following option to 'POST', if your server does not support
            // DELETE requests. This is a parameter sent to the client:
            'delete_type' => 'DELETE',
            'access_control_allow_origin' => '*',
            'access_control_allow_credentials' => false,
            'access_control_allow_methods' => [
                'OPTIONS',
                'HEAD',
                'GET',
                'POST',
                'PUT',
                'PATCH',
                'DELETE'
            ],
            'access_control_allow_headers' =>[
                'Content-Type',
                'Content-Range',
                'Content-Disposition'
            ],
            // By default, allow redirects to the referer protocol+host:
            // currently not working with APF!!
            /*
            'redirect_allow_target' => '/^'.preg_quote(
                parse_url($this->get_server_var('HTTP_REFERER'), PHP_URL_SCHEME)
                .'://'
                .parse_url($this->get_server_var('HTTP_REFERER'), PHP_URL_HOST)
                .'/', // Trailing slash to not match subdomains by mistake
                '/' // preg_quote delimiter param
                ).'/',
            */
            // Enable to provide file downloads via GET requests to the PHP script:
            //     1. Set to 1 to download files via readfile method through PHP
            //     2. Set to 2 to send a X-Sendfile header for lighttpd/Apache
            //     3. Set to 3 to send a X-Accel-Redirect header for nginx
            // If set to 2 or 3, adjust the upload_url option to the base path of
            // the redirect parameter, e.g. '/files/'.
            'download_via_php' => false,
            // Read files in chunks to avoid memory limits when download_via_php
            // is enabled, set to 0 to disable chunked reading of files:
            'readfile_chunk_size' => 10 * 1024 * 1024, // 10 MiB
            // Defines which files can be displayed inline when downloaded:
            'inline_file_types' => '/\.(gif|jpe?g|png)$/i',
            // Defines which files (based on their names) are accepted for upload:
            'accept_file_types' => '/\.(gif|jpe?g|png|mp3)$/i',                           // '/.+$/i' -> all files are allowed
            // The php.ini settings upload_max_filesize and post_max_size
            // take precedence over the following max_file_size setting:
            'max_file_size' => 9999000,
            'min_file_size' => 1,
            // The maximum number of files for the upload directory:
            'max_number_of_files' => null,
            // Defines which files are handled as image files:
            'image_file_types' => '/\.(gif|jpe?g|png)$/i',
            // Use exif_imagetype on all files to correct file extensions:
            'correct_image_extensions' => false,
            // Image resolution restrictions:
            'max_width' => null,
            'max_height' => null,
            'min_width' => 1,
            'min_height' => 1,
            // Set the following option to false to enable resumable uploads:
            'discard_aborted_uploads' => true,
            // Set to 0 to use the GD library to scale and orient images,
            // set to 1 to use imagick (if installed, falls back to GD),
            // set to 2 to use the ImageMagick convert binary directly:
            'image_library' => 1,
            // Uncomment the following to define an array of resource limits
            // for imagick:
            /*
            'imagick_resource_limits' => [
                imagick::RESOURCETYPE_MAP => 32,
                imagick::RESOURCETYPE_MEMORY => 32
            ],
            */
            // Command or path for to the ImageMagick convert binary:
            'convert_bin' => 'convert',
            // Uncomment the following to add parameters in front of each
            // ImageMagick convert call (the limit constraints seem only
            // to have an effect if put in front):
            /*
            'convert_params' => '-limit memory 32MiB -limit map 32MiB',
            */
            // Command or path for to the ImageMagick identify binary:
            'identify_bin' => 'identify',
            'image_versions' => [
                // The empty image version key defines options for the original image:
                '' => [
                    // Automatically rotate images based on EXIF meta data:
                    'auto_orient' => true
                ],
                // Uncomment the following to create medium sized images:
                /*
                'medium' => [
                    'max_width' => 800,
                    'max_height' => 600
                ],
                */
                'thumbnail' => [
                    // Uncomment the following to use a defined directory for the thumbnails
                    // instead of a subdirectory based on the version identifier.
                    // Make sure that this directory doesn't allow execution of files if you
                    // don't pose any restrictions on the type of uploaded files, e.g. by
                    // copying the .htaccess file from the files directory for Apache:
                    //'upload_dir' => dirname($this->get_server_var('SCRIPT_FILENAME')).'/thumb/',
                    //'upload_url' => $this->get_full_url().'/thumb/',
                    // Uncomment the following to force the max
                    // dimensions and e.g. create square thumbnails:
                    //'crop' => true,
                    'max_width' => 80,
                    'max_height' => 80
                ]
            ],
            'print_response' => true
        ]
    ];
</gen:highlight>
<p>
    Sie können unterschiedliche Konfigurationen für verschiedenen Anwendungsfälle anlegen. Die <em>FileUpload</em>-Taglib ist so
    gestaltet, dass sie je nach definiertem "name"-Attribut die zugehörige Konfiguration verwendet. Im Beispiel wurde
    entsprechend ein <em>FileUpload</em>-Tag mit dem Namen "imagemp3" angelegt. Anhand dessen soll es mölich sein, Bilder und
    MP3-Dateien hochzuladen.
    Einige Erklärungen zu den Parametern:
</p>
<ul>
    <li>
        <strong>UploadPath</strong>: Ziel-Verzeichnis, indem die Dateien abgelegt werden. Das Verzeichnis ist ausgehend
        vom Root-Verzeichnis Ihrer Anwendung, indem beispielsweise auch Ihre Bootstrap-Datei (index.php) liegt.
    </li>
    <li>
        <strong>randomize</strong>: Wird dieser Parameter auf "true" gesett, werden nach dem Uploadvorgang die
        Dateinamen mit der PHP-Funktion "uniqueid()" umbenannt, um sie schwerer auffindbar zu machen.
    </li>
    <li>
        <strong>accept_file_types</strong>: Es handelt sich hierbei um einen Konfigurationsmöglichkeit seitens des
        "UploadHandler". Mit diesem Parameter lassen sich erlaubte Dateitypen definieren.
    </li>
    <li>
        <strong>max_file_size</strong>: Es handelt sich hierbei um einen Konfigurationsmöglichkeit seitens des
        "UploadHandler". Mit diesem Parameter lässt sich die erlaubte Dateigrösse definieren. Bitte beachten Sie, dass
        diese Einstellung nicht die Einstellungen der php.ini "upload_max_filesize" und "post_max_size" überschreiben
        kann.
    </li>
    <li>
        <strong>image_versions</strong>: Es handelt sich hierbei um einen Konfigurationsmöglichkeit seitens des
        "UploadHandler". Hiermit können Bild-Dateien serverseitig in ihrer Auflösung geändert werden und es lassen sich
        automatisch Vorschaubilder generieren.
    </li>
</ul>

<h3 id="Chapter-4-Taglib"><a href="#Chapter-4-Taglib">4. FileUpload-Taglib</a></h3>
<p>
    Die <em>FileUpload</em>-Erweiterung liefert auch gleichzeitig eine eigene Taglib, welche Sie in Ihren Templates einsetzen
    können. Nutzen Sie dafür einfach folgende Tag-Definition:
</p>
<gen:highlight type="apf-xml">
    &lt;core:addtaglib class="APF\extensions\fileupload\pres\taglib\FileUploadTag" prefix="form" name="fileupload" /&gt;
    &lt;form:fileupload name="imagemp3[]" id="fileupload" /&gt;
</gen:highlight>
<p>
    Wie bereits im Kapitel 3.1. Beispiel-Konfiguration erwähnt dient das "name"-Attribut des Tags zum Definieren, welche
    Konfiguration verwendet werden soll.
    Über das "id"-Attribut wird das HTML-Element für die Manipulation durch das jQuery-Plugin und die Gestaltung durch
    die Cascading Style Sheets bekannt gegeben. Achten Sie darauf, dass Sie immer die richtige id angeben, wenn Sie
    Funktionen des Plugins nutzen möchten, die vom mitgleiferten Standard abweichen. Das "name"-Attribut wird nur für
    das APF benötigt.
    Notwendiges JavaScript wird durch die Taglib automatisch durch den "HtmlHeaderManager" in das Dokument injiziert. Achten
    Sie dementsprechng darauf, dass Sie den "HtmlHeaderManager" konfiguriert haben und in Ihrem Template den nötigen
    "gethead"-Tag gesetzt haben.
    Alle Hinweise zum "HtmlHeaderManager" finden Sie hier: <a class="wiki" href="http://wiki.adventure-php-framework.org/Html-Header_Erweiterung" title="Html-Header Erweiterung im Wiki">Html-Header Erweiterung im Wiki</a>
</p>

<h3 id="Chapter-5-Bespiele"><a href="#Chapter-5-Bespiele">5. Beispiele</a></h3>
<p>
    Bei Auslieferung des APF haben Sie bereits drei Beispiele erhalten, welche bereits vollständig einsetzbar sind.
    Diese Beispiele finden Sie im Ordner "templates" und lauten "basic.html", "basic-plus.html" und "extended.html".
</p>
<ul>
    <li>
        <strong>basic</strong>: Einfacher Datei-Upload mit Fortschrittsbalken, ohne Vorschau.
    </li>
    <li>
        <strong>basic-plus</strong>: Einfacher Datei-Upload mit Abbruchmöglichkeit und Vorschau-Funktion.
    </li>
    <li>
        <strong>extended</strong>: Datei-Upload mit Vorschau-Funktion von Bildern, Videos und Sounds, Abbruch-Funktion,
        Lösch-Funktion sowie integrierter Warteschlange. Die Anzahl gleichzeitiger Uploads wird in der Konfiguration
        festgelegt.
    </li>
</ul>
<p>
    Für die Vorschau-Funktionen werden zusätzliche jQuery-Plugins benötigt, welche nicht zum "jQuery-File-Upload"
    gehören. Alle Einzelheiten finden Sie in den mitgelieferten Templates.
</p>

<core:importdesign namespace="APF\modules\comments\pres\templates" template="comment" categorykey="de_167" />