<doku:title parent="100" tags="umstieg,2.1,3.0" title="Umstieg von 2.1 auf 3.0" urlname="Umstieg-von-2-1-auf-3-0">
   Dieser Artikel richtet sich an Umsteiger von APF 2.X auf die Version 3.X. Er beschreibt Neuerungen und Änderungen
   und gibt Hinweise, wie Sie ihre bestehende Anwendung optimieren können.
</doku:title>
<h3 id="Chapter-1-Einleitung"><a href="#Chapter-1-Einleitung">1. Einleitung</a></h3>
<p>
   Die Version 3.0 des Adventure PHP Framework bringt eine große Anzahl an Neuerungen mit. Dieser Artikel zeigt Ihnen,
   welche neuen Funktionalitäten sich auf Ihre bestehende Anwendung auswirken und wie Sie diese auf die neue Version
   anpassen und gleichzeitig optimieren können.
</p>
<p>
   Der Artikel richtet sich an Umsteiger von der 2.X-Linie. Sollten Sie noch eine ältere Version aus der 1.X-Generation
   einsetzen, migrieren Sie zunächst auf die Version 2.1. Unter <int:link pageid="100" /> finden Sie Hinweise und
   Anleitungen dazu.
</p>

<h3 id="Chapter-2-APF-Parser"><a href="#Chapter-2-APF-Parser">2. APF-Parser</a></h3>
<p>
   Der APF-Parser wurde in der Version 3.0 komplett neu geschrieben. Grund hierfür waren Einschränkungen, die die
   Entwicklung von Anwendungen erschwert haben und an einigen Stellen Workarounds erforderten.
</p>
<p>
   Die bisherige Implementierung des Parsers konnte nicht alle Tag-Strukturen - vor allem hinsichtlich der Hierarchie-Zuordnung
   - auflösen, was entweder zu Parser-Fehlern und damit Applikationsabstürzen führte oder Tags nicht erkannt wurden und
   damit Funktionalität nicht gegeben war. Zusätzlich dazu erschwerte die wiederkehrende Registrierung von Tags pro
   Instanz.
</p>
<p>
   Ein weiteres Problem ist das Timing. Durch die Analyse von Templates an Hand der Liste der bekannten Tags und nicht
   an Hand der Reihenfolge und Struktur von Tags in einem Template war es unter gewissen Umständen notwendig Workarounds
   zu implementieren.
</p>
<p>
   All diese Themen wurden nun mit dem neuen Parser nun gelöst und daraus ergeben sich einige Optimierungsmöglichkeiten
   für Ihre Anwendung. Einige davon werden bereits im Artikel <int:link pageid="159" /> beschrieben.
</p>
<p>
   Der Parser bietet nun folgende Vorteile gegenüber der Version 2.1:
</p>
<ul>
   <li>
      Tags werden an Hand der Definition im Template analysiert und nicht mehr an Hand der Liste der bekannten Tags.
      Damit werden ab dem Release 3.0 alle Tag-Strukturen und -Schachtelungen unterstützt. Nicht mehr erkannte Tags
      oder Parser-Fehler auf Grund von nicht kompatiblen Tag-Strukturen gehören der Vergangenheit an.
   </li>
   <li>
      Durch die Analyse von Tags an Hand des Templates kann die starre Abhängigkeit von Tags zu einer Hierarchie-Ebene
      komplett aufgelöst werden. Ab der Version 3.0 lässt sich jeder Tag (prinzipiell) in jeder Ebene mit der selben
      Kombination aus Präfix und Namen einsetzen. Dies erleichtert nicht nur die Implementierung, sondern spart auch
      Wrapper-Tags, die ausschließlich für den Einsatz in einer speziellen Ebene implementierung wurden.
   </li>
   <li>
      Tags werden ab Version 3.0 global registriert. Dies bedeutet, dass eine Kombination aus Präfix und Namen durch eine
      einmalige Registrierung in allen Templates und allen Ebenen bekannt ist. Damit lassen sich Tags bequem in der
      Bootstrap-Datei zentral und einmalig für die gesamte Applikation registrieren.
   </li>
   <li>
      Die erweiterte Templating-Syntax ist nun in allen Templates und allen Ebenen verfügbar.
   </li>
   <li>
      Viele neue Features (siehe <a class="external" href="http://tracker.adventure-php-framework.org/roadmap_page.php?version_id=9">Roadmap</a>)
      können nun realisiert werden, wie z.B. ein Iterator in einem Formular oder ein Formular in einem
      <em>&lt;html:template /&gt;</em>-Tag.
   </li>
</ul>
<p>
   Die folgenden Kapitel zeigen die Optimierungsmöglichkeiten auf.
</p>

<h4 id="Chapter-2-1-Automatisierte-Migration"><a href="#Chapter-2-1-Automatisierte-Migration">2.1. Automatisierte Migration</a></h4>
<p>
   Als ersten Schritt des Umstiegs auf die neue Version aber auch der Optimierung Ihrer Anwendung führen Sie bitte
   die unter <int:link pageid="159" /> beschriebenen Migrations-Skripten aus. Diese optimieren bereits die Anwendung der
   mit dem APF ausgelieferten Komponenten.
</p>

<h4 id="Chapter-2-2-Optimierung-Tag-Registrierung"><a href="#Chapter-2-2-Optimierung-Tag-Registrierung">2.2. Optimierung der Tag-Registrierung</a></h4>
<p>
   Zur Vereinfachung Ihrer Templates empfiehlt das APF-Team folgende Maßnahmen für Ihre Applikation:
</p>
<ul>
   <li>
      Extrahieren Sie zunächst alle Vorkommen des <em>&lt;core:addtaglib /&gt;</em>-Tags aus Ihren Templates und
      ersetzen diese durch ein <em>Document::addTagLib()</em>-Statement in Ihrer Bootstrap-Datei. Finden Sie in Ihren
      Templates beispielsweise die Tags
<gen:highlight type="apf-xml">
&lt;template:addtaglib class="DOCS\pres\taglib\InternalLinkTag" prefix="int" name="link" /&gt;
&lt;core:addtaglib class="DOCS\pres\taglib\InternalLinkTag" prefix="int" name="link" /&gt;
</gen:highlight>
      so ersetzen sie die beiden durch ein
<gen:highlight type="php">
Document::addTagLib('DOCS\pres\taglib\InternalLinkTag', 'int', 'link');
</gen:highlight>
      Bitte beachten Sie, das die Tag-Registrierung vor dem Starten des Frontcontrollers erfolgen muss.
   </li>
   <li>
      Extrahieren Sie alle <em>self::addTagLib()</em>-Statements aus Ihrer Applikation - z.B.
<gen:highlight type="php">
class FooTag extends Document {
   public function __contruct() {
      self::addTagLib('DOCS\pres\taglib\InternalLinkTag', 'int', 'link');
   }
   ...
}
</gen:highlight>
      - und fügen Sie diese ebenfalls zur Liste in der Bootstrap-Datei hinzu.
   </li>
   <li>
      Konsolidieren Sie nun die erstellte Liste und entfernen alle mehrfachen Tag-Registrierungen.
   </li>
</ul>
<div class="hint">
   Sofern ein Modul aus einem zentralen Haupt-Template und mehreren Unter-Templates besteht, so kann die Tag-Registrierung
   auch via <em>&lt;core:addtaglib /&gt;</em> im Haupt-Template vorgenommen werden. Da das Haupt-Template vom Parser vor
   den Unter-Templates analysiert wird, sind die dort per <em>&lt;core:importdesign /&gt;</em> registrierten Tags
   (zeitlich betrachtet!) auch in den Unter-Templates bekannt.
</div>

<h4 id="Chapter-2-3-Wiederverwendung-von-registrierten-Tags"><a href="#Chapter-2-3-Wiederverwendung-von-registrierten-Tags">2.3. Wiederverwendung von registrierten Tags</a></h4>
<p>
   Der APF-Parser wurde in der Version 3.0 so optimiert, dass er Tags mit gleichen Namen in unterschiedlichen Hierarchien
   korrekt auflösen kann. Die Tag-Struktur
</p>
<gen:highlight type="apf-xml">
&lt;core:addtaglib class="..." prefix="template" name="link"/&gt;
&lt;int:link /&gt;

&lt;html:template&gt;
   &lt;template:addtaglib class="..." prefix="template" name="link"/&gt;
   &lt;template:link /&gt;
&lt;/html:template&gt;
</gen:highlight>
<p>
   lässt sich zukünftig zu
</p>
<gen:highlight type="apf-xml">
&lt;core:addtaglib class="..." prefix="template" name="link"/&gt;
&lt;int:link /&gt;

&lt;html:template&gt;
   &lt;int:link /&gt;
&lt;/html:template&gt;
</gen:highlight>
<p>
   vereinfachen. Der <em>&lt;int:link /&gt;</em>-Tag muss daher nur einmal innerhalb der Applikation registrieren werden:
   entweder konsolidiert per <em>&lt;core:addtaglib /&gt;</em>-Tag in einem Template oder in der <em>index.php</em>.
</p>

<h4 id="Chapter-2-4-Entfernen-von-Wrapper-Tags"><a href="#Chapter-2-4-Entfernen-von-Wrapper-Tags">2.4. Entfernen von Wrapper-Tags</a></h4>
<p>
   In vorangegangenen Version war es notwendig, Wrapper-Tags zu definieren oder Tag-Implementierungen unter einem anderen
   Präfix und/oder Namen zu registrieren um die
   <int:link pageid="147" anchor="Chapter-6-Tag-Hierarchie" version="2.X">Schwächen des APF-Parses</int:link> auszugleichen.
   Bis Version 2.1 konnte der Parser Tags mit gleichem Präfix und Namen nicht korrekt zu den im Template definierten
   Hierarchie-Stufen zu ordnen, da die Analyse des Templates an Hand der registrierten Tags ausgeführt wurde.
</p>
<p>
   In Version 3.0 wurde diese Schwäche beseitigt und in Ihrer Applikation vorhandene Workarounds können entfernt werden.
   Um Ihre Anwendung auf Basis der Version 3.X optimieren zu können, zeigt das folgende Beispiel das Potential des neuen
   APF-Parser auf.
</p>
<p>
   Um in vorangegangenen Versionen die Tag-Struktur
</p>
<gen:highlight type="apf-xml">
&lt;html:iterator name=""&gt;
   ...
   &lt;iterator:fallback&gt;
      ...
      [&lt;fallback:placeholder name="" /&gt;]
      [&lt;fallback:getstring namespace="" config="" entry="" /&gt;]
      [&lt;fallback:addtaglib class="" prefix="" name="" /&gt;]
      ...
   &lt;/iterator:fallback&gt;]
   ...
&lt;/html:iterator&gt;
</gen:highlight>
<p>
   realisieren zu können (Details der Tag-Signatur siehe <int:link pageid="078" anchor="Chapter-1-Iterator" version="2.X" />),
   war ein Wrapper-Tag notwendig, der die Registrierung der Kind-Tags so deklariert, dass diese nicht schon bei der Analyse
   des direkten Inhalts des <em>&lt;html:iterator /&gt;</em>-Tags erfasst und falsch zugeordnet wurden.
</p>
<p>
   Der zugehörige Quellcode des APF gestaltete sich wie folgt:
</p>
<gen:highlight type="php">
class HtmlIteratorTag extends Document {
   public function __construct() {
      $this->tagLibs[] = new TagLib('APF\tools\html\taglib\HtmlIteratorFallbackTag', 'iterator', 'fallback');
      ...
   }
   ...
}

class HtmlIteratorFallbackTag extends TemplateTag {

   public function __construct() {
      $this->tagLibs[] = new TagLib('APF\core\pagecontroller\PlaceHolderTag', 'fallback', 'placeholder');
      $this->tagLibs[] = new TagLib('APF\core\pagecontroller\AddTaglibTag', 'fallback', 'addtaglib');
      $this->tagLibs[] = new TagLib('APF\core\pagecontroller\LanguageLabelTag', 'fallback', 'getstring');
   }

}
</gen:highlight>
<p>
   Da der Parser ab Release 3.0 jeden Tag zur richtigen Hierarchie-Stufe zuordnen kann, lässt sich der (separat implementierte)
   <em>&lt;iterator:fallback /&gt;</em>-Tag einfach durch einen &quot;echten&quot; <em>TemplateTag</em> ersetzen. Für
   Ihr Projekt bedeutet dies folgendes:
</p>
<ul>
   <li>
      Der <em>HtmlIteratorFallbackTag</em> kann komplett entfernt werden und die Tag-Registrierung für den
      <em>&lt;iterator:fallback /&gt;</em>-Tag lässt sich auf
<gen:highlight type="php">
Document::addTagLib('APF\core\pagecontroller\TemplateTag', 'iterator', 'fallback');
</gen:highlight>
      umstellen.
   </li>
   <li>
      Anschließend können Sie die Tag-Struktur auf
<gen:highlight type="apf-xml">
&lt;html:iterator name=""&gt;
   ...
   &lt;iterator:fallback&gt;
      ...
      [&lt;html:placeholder name="" /&gt;]
      [&lt;html:getstring namespace="" config="" entry="" /&gt;]
      [&lt;core:addtaglib class="" prefix="" name="" /&gt;]
      ...
   &lt;/iterator:fallback&gt;]
   ...
&lt;/html:iterator&gt;
</gen:highlight>
      umstellen, da beispielsweise der <em>&lt;html:placeholder /&gt;</em>-Tag auch innerhalb von
      <em>&lt;iterator:fallback /&gt;</em> korrekt erkannt und diesem zugeordnet wird.
   </li>
</ul>
<p>
   Eine Reduktion von Tag-Registrierungen und -Implementierungen spart nicht nur Code, sondern reduziert auch die
   Komplexität Ihrer Anwendung. Es lohnt sich daher, nach ähnlichen Mustern zu suchen und diese mit den neuen Möglichkeiten
   des APF-Parsers aufzulösen.
</p>

<h4 id="Chapter-2-5-Umstellen-auf-Extended-Templating-Syntax"><a href="#Chapter-2-5-Umstellen-auf-Extended-Templating-Syntax">2.5. Umstellen auf Extended Templating Syntax</a></h4>
<p>
   Zur Optimierung der Übersichtlichkeit Ihrer Templates wird empfohlen, die Platzhalter-Notation <em>&lt;html:placeholder /&gt;</em>
   auf die verkürzte Schreibweise der erweiterten Templating Syntax umzustellen.
</p>
<p>
   Diese Änderung lässt sich auf der Kommandozeile mit dem mitgelieferten Migrations-Skript sehr einfach für alle
   Template-Dateien erledigen:
</p>
<div class="warn">
   Bitte wechseln Sie vor der Ausführung in das Konfigurationsverzeichnis Ihrer Applikation um unerwartete Ergebnisse
   zu vermeiden.
</div>
<gen:highlight type="code">
$ /path/to/migration/migrate-place-holders.sh /cygdrive/c/xampp/php/php
#############################################
# APF 3.0 automatic place holder migration  #
#############################################

Checking PHP executable available ... [OK]

Using given php executable at /cygdrive/c/xampp/php/php. PHP Version: 5.4.16.

#############################################

Starting migration ...

#############################################

Migration done! Place holders are now written in extended templating syntax.
</gen:highlight>
<div class="warn">
   Bitte stellen Sie sicher, dass Sie zunächst die automatisierte Migration Ihrer Code-Basis ausgeführt haben. Details
   dazu erfahren Sie unter <int:link pageid="159" />.
</div>

<h3 id="Chapter-3-Autoloading"><a href="#Chapter-3-Autoloading">3. Autoloading</a></h3>
<p>
   In Version 3.0 des APF wurde die Composer-Unterstützung eingeführt. Um Probleme mit dem Laden von Klassen zu vermeiden
   empfiehlt das APF-Team die im PHP-Standard <a class="external" href="http://www.php-fig.org/psr/psr-2/">PSR-2</a>
   beschriebenen Vorgehen zur Quellcode-Strukturierung zu folgen.
</p>
<p>
   Wichtig in diesem Zusammenhang ist die Einhaltung der <em>eine Klasse pro Datei</em>-Regel.
</p>
<div class="hint">
   Bitte beachten Sie, dass das APF die im <a class="external" href="http://www.php-fig.org/psr/psr-2/">PSR-2</a>- bzw.
   <a class="external" href="http://www.php-fig.org/psr/psr-4/">PSR-4</a>-Standard beschriebenen Vorgaben zu sehr großen
   Teilen befolgt. Bei der Formattierung des Quellcodes hat das APF-Team davon abweichende Regeln definiert. Detais hierzu
   können im Wiki unter <a class="wiki" href="http://wiki.adventure-php-framework.org/APF_Coding_Standard">APF Coding Standard</a>
   nachgelesen werden.
</div>

<core:importdesign namespace="APF\modules\comments\pres\templates" template="comment" categorykey="de_158" />